import{j as e,I as S,C as X,u as Q,g as H,r as F,a as U,b as V,R as I}from"./app.js";import{r as u}from"./table.js";import{u as W}from"./useInterval.js";import"./vendor.js";function J({title:a,message:r,confirmLabel:h="Confirm",cancelLabel:g="Cancel",onConfirm:i,onCancel:y,danger:N=!1}){return e.jsx("div",{className:"modal-backdrop",onClick:y,children:e.jsxs("div",{className:"modal",style:{maxWidth:"500px"},onClick:x=>x.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:a}),e.jsx("button",{className:"btn ghost",onClick:y,children:e.jsx(S,{src:X})})]}),e.jsx("div",{className:"modal-body",children:e.jsx("p",{style:{margin:0,lineHeight:1.6},children:r})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn ghost",onClick:y,children:g}),e.jsx("button",{className:`btn ${N?"danger":"primary"}`,onClick:i,children:h})]})]})})}const Y="/static/assets/build.svg",Z=/\b(480p|576p|720p|1080p|2160p|4k|8k|web[-_. ]?(?:dl|rip)|hdrip|hdtv|bluray|bd(?:rip)?|brrip|webrip|remux|x264|x265|hevc|dts|truehd|atmos|proper|repack|dvdrip|hdr|amzn|nf)\b/i,ee=/\bS\d{1,3}E\d{1,3}\b/i,se=/\bSeason\s+\d+\b/i;function re(a){const r=a.trim();if(!r||/^\d+\s+queued item/i.test(r))return"";const h=r.replace(/\s+/g," "),g=h.match(/^(?<title>.+?)\s+(?<year>(?:19|20)\d{2})(?:\s+(?<rest>.*))?$/);if(g){const i=g.groups?.rest??"",y=ee.test(i)||se.test(i);if(i&&!y&&Z.test(i)){const x=(g.groups?.title??"").replace(/[-_.]/g," ").replace(/\s{2,}/g," ").trim(),v=g.groups?.year??"";if(x)return v?`${x} (${v})`:x}}return h}function te(a,r){return a.category===r.category&&a.name===r.name&&a.kind===r.kind&&a.pid===r.pid&&a.alive===r.alive&&(a.searchSummary??"")===(r.searchSummary??"")&&(a.searchTimestamp??"")===(r.searchTimestamp??"")&&(a.queueCount??null)===(r.queueCount??null)&&(a.categoryCount??null)===(r.categoryCount??null)&&(a.metricType??"")===(r.metricType??"")}function ae(a,r){if(a===r)return!0;if(a.length!==r.length)return!1;for(let h=0;h<a.length;h+=1)if(!te(a[h],r[h]))return!1;return!0}function ne(a,r){return a?r.some(i=>i.alive&&i.kind.toLowerCase()==="search")?5e3:r.some(i=>typeof i.queueCount=="number"&&i.queueCount>0)?1e4:2e4:null}function pe({active:a}){const[r,h]=u.useState([]),[g,i]=u.useState(!1),[y,N]=u.useState(!1),[x,v]=u.useState(!1),[A,C]=u.useState(null),{push:d}=Q(),w=u.useRef(!1),m=u.useCallback(async()=>{if(!w.current){w.current=!0,i(s=>s||!0);try{const l=((await H()).processes??[]).map(p=>{if(typeof p.searchSummary=="string"){const b=re(p.searchSummary);return{...p,searchSummary:b}}return p});h(p=>ae(p,l)?p:l)}catch(s){d(s instanceof Error?s.message:"Failed to load processes list","error")}finally{w.current=!1,i(!1)}}},[d]);u.useEffect(()=>{m()},[m]),u.useEffect(()=>{a&&m()},[a,m]);const O=u.useMemo(()=>ne(a,r),[a,r]);W(()=>{m()},O);const K=u.useCallback(async(s,l)=>{try{await F(s,l),d(`Restarted ${s}:${l}`,"success"),m()}catch(p){d(p instanceof Error?p.message:`Failed to restart ${s}:${l}`,"error")}},[m,d]),M=u.useCallback(async()=>{C({title:"Restart All Processes",message:"Are you sure you want to restart all processes? This will temporarily interrupt all operations.",onConfirm:async()=>{C(null),N(!0);try{await U(),d("Restarted all processes","success"),m()}catch(s){d(s instanceof Error?s.message:"Failed to restart all","error")}finally{N(!1)}}})},[m,d]),G=u.useCallback(async()=>{C({title:"Rebuild Arrs",message:"Are you sure you want to rebuild all Arr instances? This will refresh all connections and may take some time.",onConfirm:async()=>{C(null),v(!0);try{await V(),d("Requested Arr rebuild","success"),m()}catch(s){d(s instanceof Error?s.message:"Failed to rebuild Arrs","error")}finally{v(!1)}}})},[m,d]),z=u.useMemo(()=>{const s=new Map,l=n=>{const o=(n.category??"").toLowerCase(),c=(n.name??"").toLowerCase();return o.includes("radarr")||c.includes("radarr")?"Radarr":o.includes("sonarr")||c.includes("sonarr")?"Sonarr":o.includes("qbit")||o.includes("qbittorrent")||c.includes("qbit")||c.includes("qbittorrent")?"qBittorrent":"Other"};r.forEach(n=>{const o=l(n);s.has(o)||s.set(o,new Map);const c=s.get(o),f=n.name||n.category||`${n.category}:${n.kind}`;c.has(f)||c.set(f,[]),c.get(f).push(n)});const p=["Radarr","Sonarr","qBittorrent","Other"],b=Array.from(s.entries()).map(([n,o])=>{const c=Array.from(o.entries()).map(([f,j])=>({name:f,items:j.sort((T,$)=>T.kind.localeCompare($.kind))})).sort((f,j)=>f.name.localeCompare(j.name));return{app:n,instances:c}}).filter(n=>n.instances.length);return b.sort((n,o)=>{const c=f=>{const j=p.indexOf(f);return j===-1?Number.MAX_SAFE_INTEGER:j};return c(n.app)-c(o.app)||n.app.localeCompare(o.app)}),b},[r]),B=u.useCallback(async s=>{try{await Promise.all(s.map(l=>F(l.category,l.kind))),d(`Restarted ${s[0]?.name??"group"}`,"success"),m()}catch(l){d(l instanceof Error?l.message:"Failed to restart process group","error")}},[m,d]),q=z.map(({app:s,instances:l})=>{const p=l.map(({name:b,items:n})=>{const o=n.filter(t=>t.alive).length,c=n.length,f=c===0?"":o===c?"status-indicator--ok":o===0?"status-indicator--bad":"",j=["status-indicator"];f&&j.push(f);const T=c===0?"No processes":o===c?"All running":o===0?"Stopped":`${o}/${c} running`,$=c===1?"1 process":`${c} processes`,D=b==="FreeSpaceManager"?"Free Space Manager":b,L=Array.from(new Set(n.map(t=>t.kind))).filter(t=>{const _=t.toLowerCase();return _!=="search"&&_!=="torrent"}),P=t=>t&&t.charAt(0).toUpperCase()+t.slice(1);return e.jsxs("div",{className:"process-card",children:[e.jsxs("div",{className:"process-card__header",children:[e.jsxs("div",{className:"process-card__title",children:[e.jsx("div",{className:"process-card__name",children:D}),e.jsx("div",{className:"process-card__summary",children:$}),L.length?e.jsx("div",{className:"process-card__badges",children:L.map(t=>e.jsx("span",{className:"process-card__badge",children:P(t)},`${b}:${t}:badge`))}):null]}),e.jsx("div",{className:j.join(" "),title:T})]}),e.jsx("div",{className:"process-card__list",children:n.map(t=>e.jsxs("div",{className:"process-chip",children:[e.jsxs("div",{className:"process-chip__top",children:[e.jsx("div",{className:"process-chip__name",children:P(t.kind)}),e.jsx("div",{className:`status-pill__dot ${t.alive?"text-success":"text-danger"}`})]}),e.jsx("div",{className:"process-chip__detail",children:(()=>{const _=t.kind.toLowerCase();if(_==="search")return(t.searchSummary??"")||"No searches recorded";if(_==="torrent"){const k=t.metricType?.toLowerCase(),E=typeof t.categoryCount=="number"?t.categoryCount:null,R=typeof t.queueCount=="number"?t.queueCount:null;return k?k==="category"&&E!==null?`Torrent count ${E}`:k==="free-space"&&R!==null?`Torrent count ${R}`:"Torrent count unavailable":`Torrents in queue ${R!==null?R:"?"} / total ${E!==null?E:"?"}`}return""})()}),e.jsx("div",{className:"process-chip__actions",children:e.jsx("button",{className:"btn small",onClick:()=>K(t.category,t.kind),children:"Restart"})})]},`${t.category}:${t.kind}`))}),e.jsx("div",{className:"process-card__footer",children:e.jsx("button",{className:"btn small outline",onClick:()=>void B(n),children:"Restart All"})})]},b)});return{app:s,cards:p}});return e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Processes"}),e.jsxs("div",{className:"card-body stack",children:[e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col inline",children:[e.jsxs("button",{className:"btn ghost",onClick:()=>void m(),disabled:g,children:[g&&e.jsx("span",{className:"spinner"}),e.jsx(S,{src:I}),g?"Refreshing...":"Refresh"]}),e.jsxs("button",{className:"btn",onClick:()=>void M(),disabled:y,children:[y&&e.jsx("span",{className:"spinner"}),e.jsx(S,{src:I}),y?"Restarting...":"Restart All"]}),e.jsxs("button",{className:"btn",onClick:()=>void G(),disabled:x,children:[x&&e.jsx("span",{className:"spinner"}),e.jsx(S,{src:Y}),x?"Rebuilding...":"Rebuild Arrs"]})]})}),q.length?q.map(({app:s,cards:l})=>e.jsxs("div",{className:"process-section",children:[e.jsx("div",{className:"process-section__title",children:s}),e.jsx("div",{className:"process-grid",children:l})]},s)):e.jsx("div",{className:"empty-state",children:"No processes available."})]})]}),A&&e.jsx(J,{title:A.title,message:A.message,confirmLabel:"Confirm",cancelLabel:"Cancel",danger:!0,onConfirm:A.onConfirm,onCancel:()=>C(null)})]})}export{pe as ProcessesView};
//# sourceMappingURL=ProcessesView.js.map
