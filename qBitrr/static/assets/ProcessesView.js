import{j as e,I as P,C as U,u as V,g as W,a as J,r as K,b as Y,c as Z,R as M}from"./app.js";import{r as l}from"./table.js";import{u as ee}from"./useInterval.js";import"./vendor.js";function se({title:a,message:r,confirmLabel:h="Confirm",cancelLabel:f="Cancel",onConfirm:u,onCancel:x,danger:_=!1}){return e.jsx("div",{className:"modal-backdrop",onClick:x,children:e.jsxs("div",{className:"modal",style:{maxWidth:"500px"},onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:a}),e.jsx("button",{className:"btn ghost",onClick:x,children:e.jsx(P,{src:U})})]}),e.jsx("div",{className:"modal-body",children:e.jsx("p",{style:{margin:0,lineHeight:1.6},children:r})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn ghost",onClick:x,children:f}),e.jsx("button",{className:`btn ${_?"danger":"primary"}`,onClick:u,children:h})]})]})})}const re="/static/assets/build.svg",te=/\b(480p|576p|720p|1080p|2160p|4k|8k|web[-_. ]?(?:dl|rip)|hdrip|hdtv|bluray|bd(?:rip)?|brrip|webrip|remux|x264|x265|hevc|dts|truehd|atmos|proper|repack|dvdrip|hdr|amzn|nf)\b/i,ae=/\bS\d{1,3}E\d{1,3}\b/i,ne=/\bSeason\s+\d+\b/i;function ce(a){const r=a.trim();if(!r||/^\d+\s+queued item/i.test(r))return"";const h=r.replace(/\s+/g," "),f=h.match(/^(?<title>.+?)\s+(?<year>(?:19|20)\d{2})(?:\s+(?<rest>.*))?$/);if(f){const u=f.groups?.rest??"",x=ae.test(u)||ne.test(u);if(u&&!x&&te.test(u)){const b=(f.groups?.title??"").replace(/[-_.]/g," ").replace(/\s{2,}/g," ").trim(),A=f.groups?.year??"";if(b)return A?`${b} (${A})`:b}}return h}function oe(a,r){return a.category===r.category&&a.name===r.name&&a.kind===r.kind&&a.pid===r.pid&&a.alive===r.alive&&(a.searchSummary??"")===(r.searchSummary??"")&&(a.searchTimestamp??"")===(r.searchTimestamp??"")&&(a.queueCount??null)===(r.queueCount??null)&&(a.categoryCount??null)===(r.categoryCount??null)&&(a.metricType??"")===(r.metricType??"")}function ie(a,r){if(a===r)return!0;if(a.length!==r.length)return!1;for(let h=0;h<a.length;h+=1)if(!oe(a[h],r[h]))return!1;return!0}function le(a,r){return a?r.some(u=>u.alive&&u.kind.toLowerCase()==="search")?5e3:r.some(u=>typeof u.queueCount=="number"&&u.queueCount>0)?1e4:2e4:null}function ge({active:a}){const[r,h]=l.useState([]),[f,u]=l.useState(!1),[x,_]=l.useState(!1),[b,A]=l.useState(!1),[I,D]=l.useState(null),[E,R]=l.useState(null),{push:d}=V(),F=l.useRef(!1),m=l.useCallback(async()=>{if(!F.current){F.current=!0,u(s=>s||!0);try{const[s,o]=await Promise.all([W(),J()]),g=(s.processes??[]).map(p=>{if(typeof p.searchSummary=="string"){const j=ce(p.searchSummary);return{...p,searchSummary:j}}return p});h(p=>ie(p,g)?p:g),D(o)}catch(s){d(s instanceof Error?s.message:"Failed to load processes list","error")}finally{F.current=!1,u(!1)}}},[d]);l.useEffect(()=>{m()},[m]),l.useEffect(()=>{a&&m()},[a,m]);const G=l.useMemo(()=>le(a,r),[a,r]);ee(()=>{m()},G);const z=l.useCallback(async(s,o)=>{try{await K(s,o),d(`Restarted ${s}:${o}`,"success"),m()}catch(g){d(g instanceof Error?g.message:`Failed to restart ${s}:${o}`,"error")}},[m,d]),B=l.useCallback(async()=>{R({title:"Restart All Processes",message:"Are you sure you want to restart all processes? This will temporarily interrupt all operations.",onConfirm:async()=>{R(null),_(!0);try{await Y(),d("Restarted all processes","success"),m()}catch(s){d(s instanceof Error?s.message:"Failed to restart all","error")}finally{_(!1)}}})},[m,d]),X=l.useCallback(async()=>{R({title:"Rebuild Arrs",message:"Are you sure you want to rebuild all Arr instances? This will refresh all connections and may take some time.",onConfirm:async()=>{R(null),A(!0);try{await Z(),d("Requested Arr rebuild","success"),m()}catch(s){d(s instanceof Error?s.message:"Failed to rebuild Arrs","error")}finally{A(!1)}}})},[m,d]),Q=l.useMemo(()=>{const s=new Map,o=n=>{const c=(n.category??"").toLowerCase(),i=(n.name??"").toLowerCase();return c.includes("radarr")||i.includes("radarr")?"Radarr":c.includes("sonarr")||i.includes("sonarr")?"Sonarr":c.includes("lidarr")||i.includes("lidarr")?"Lidarr":c.includes("qbit")||c.includes("qbittorrent")||i.includes("qbit")||i.includes("qbittorrent")?"qBittorrent":"Other"},g=I?.arrs??[],p=g.some(n=>n.type==="radarr"),j=g.some(n=>n.type==="sonarr"),v=g.some(n=>n.type==="lidarr");r.forEach(n=>{const c=o(n);if(c==="Radarr"&&!p||c==="Sonarr"&&!j||c==="Lidarr"&&!v)return;s.has(c)||s.set(c,new Map);const i=s.get(c),y=n.name||n.category||`${n.category}:${n.kind}`;i.has(y)||i.set(y,[]),i.get(y).push(n)});const N=["Radarr","Sonarr","Lidarr","qBittorrent","Other"],S=Array.from(s.entries()).map(([n,c])=>{const i=Array.from(c.entries()).map(([y,C])=>({name:y,items:C.sort((w,L)=>w.kind.localeCompare(L.kind))})).sort((y,C)=>y.name.localeCompare(C.name));return{app:n,instances:i}}).filter(n=>n.instances.length);return S.sort((n,c)=>{const i=y=>{const C=N.indexOf(y);return C===-1?Number.MAX_SAFE_INTEGER:C};return i(n.app)-i(c.app)||n.app.localeCompare(c.app)}),S},[r,I]),H=l.useCallback(async s=>{try{await Promise.all(s.map(o=>K(o.category,o.kind))),d(`Restarted ${s[0]?.name??"group"}`,"success"),m()}catch(o){d(o instanceof Error?o.message:"Failed to restart process group","error")}},[m,d]),O=Q.map(({app:s,instances:o})=>{const g=o.map(({name:p,items:j})=>{const v=j.filter(t=>t.alive).length,N=j.length,S=N===0?"":v===N?"status-indicator--ok":v===0?"status-indicator--bad":"",n=["status-indicator"];S&&n.push(S);const c=N===0?"No processes":v===N?"All running":v===0?"Stopped":`${v}/${N} running`,i=N===1?"1 process":`${N} processes`,y=p==="FreeSpaceManager"?"Free Space Manager":p,w=Array.from(new Set(j.map(t=>t.kind))).filter(t=>{const k=t.toLowerCase();return k!=="search"&&k!=="torrent"}),L=t=>t&&t.charAt(0).toUpperCase()+t.slice(1);return e.jsxs("div",{className:"process-card",children:[e.jsxs("div",{className:"process-card__header",children:[e.jsxs("div",{className:"process-card__title",children:[e.jsx("div",{className:"process-card__name",children:y}),e.jsx("div",{className:"process-card__summary",children:i}),w.length?e.jsx("div",{className:"process-card__badges",children:w.map(t=>e.jsx("span",{className:"process-card__badge",children:L(t)},`${p}:${t}:badge`))}):null]}),e.jsx("div",{className:n.join(" "),title:c})]}),e.jsx("div",{className:"process-card__list",children:j.map(t=>e.jsxs("div",{className:"process-chip",children:[e.jsxs("div",{className:"process-chip__top",children:[e.jsx("div",{className:"process-chip__name",children:L(t.kind)}),e.jsx("div",{className:`status-pill__dot ${t.alive?"text-success":"text-danger"}`})]}),e.jsx("div",{className:"process-chip__detail",children:(()=>{const k=t.kind.toLowerCase();if(k==="search")return(t.searchSummary??"")||"No searches recorded";if(k==="torrent"){const T=t.metricType?.toLowerCase(),$=typeof t.categoryCount=="number"?t.categoryCount:null,q=typeof t.queueCount=="number"?t.queueCount:null;return T?T==="category"&&$!==null?`Torrent count ${$}`:T==="free-space"&&q!==null?`Torrent count ${q}`:"Torrent count unavailable":`Torrents in queue ${q!==null?q:"?"} / total ${$!==null?$:"?"}`}return""})()}),e.jsx("div",{className:"process-chip__actions",children:e.jsx("button",{className:"btn small",onClick:()=>z(t.category,t.kind),children:"Restart"})})]},`${t.category}:${t.kind}`))}),e.jsx("div",{className:"process-card__footer",children:e.jsx("button",{className:"btn small outline",onClick:()=>void H(j),children:"Restart All"})})]},p)});return{app:s,cards:g}});return e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Processes"}),e.jsxs("div",{className:"card-body stack",children:[e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col inline",children:[e.jsxs("button",{className:"btn ghost",onClick:()=>void m(),disabled:f,children:[f&&e.jsx("span",{className:"spinner"}),e.jsx(P,{src:M}),f?"Refreshing...":"Refresh"]}),e.jsxs("button",{className:"btn",onClick:()=>void B(),disabled:x,children:[x&&e.jsx("span",{className:"spinner"}),e.jsx(P,{src:M}),x?"Restarting...":"Restart All"]}),e.jsxs("button",{className:"btn",onClick:()=>void X(),disabled:b,children:[b&&e.jsx("span",{className:"spinner"}),e.jsx(P,{src:re}),b?"Rebuilding...":"Rebuild Arrs"]})]})}),O.length?O.map(({app:s,cards:o})=>e.jsxs("div",{className:"process-section",children:[e.jsx("div",{className:"process-section__title",children:s}),e.jsx("div",{className:"process-grid",children:o})]},s)):e.jsx("div",{className:"empty-state",children:"No processes available."})]})]}),E&&e.jsx(se,{title:E.title,message:E.message,confirmLabel:"Confirm",cancelLabel:"Cancel",danger:!0,onConfirm:E.onConfirm,onCancel:()=>R(null)})]})}export{ge as ProcessesView};
//# sourceMappingURL=ProcessesView.js.map
