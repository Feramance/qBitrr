import{u as Xe,h as qe,i as es,k as ss,l as Ye,m as as,j as e,I as _e,R as Ke,n as Ge,o as We}from"./app.js";import{r as a,u as Fe,f as xe,g as $e,a as ts,b as hs,c as ms}from"./table.js";import{u as Pe}from"./useInterval.js";import"./vendor.js";const Qe=50,ke=50,ls=500;function fs({loading:d,rows:c,total:u,page:v,totalPages:C,onPageChange:L,onRefresh:$,lastUpdated:M,sort:A,onSort:h,summary:o,instanceCount:f}){const r=a.useMemo(()=>[...f>1?[{accessorKey:"__instance",header:"Instance",size:150}]:[],{accessorKey:"title",header:"Title",cell:m=>m.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:m=>m.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:m=>m.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:m=>{const n=m.getValue();return n?e.jsx("span",{className:"table-badge table-badge-reason",children:n}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[f]),x=Fe({data:c,columns:r,getCoreRowModel:$e()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated movies across all instances"," ",M?`(updated ${M})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",o.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",o.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",o.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",o.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:$,disabled:d,children:[e.jsx(_e,{src:Ke}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Radarr library…"]}):u?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:x.getHeaderGroups().map(m=>e.jsx("tr",{children:m.headers.map(n=>e.jsx("th",{className:n.column.getCanSort()?"sortable":"",onClick:()=>{const j=n.id;h(j)},children:n.isPlaceholder?null:xe(n.column.columnDef.header,n.getContext())},n.id))},m.id))}),e.jsx("tbody",{children:x.getRowModel().rows.map(m=>{const n=m.original,j=`${n.__instance}-${n.title}-${n.year}`;return e.jsx("tr",{children:m.getVisibleCells().map(_=>e.jsx("td",{"data-label":String(_.column.columnDef.header),children:xe(_.column.columnDef.cell,_.getContext())},_.id))},j)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),u>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",v+1," of ",C," (",u.toLocaleString()," items · page size"," ",ke,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,v-1)),disabled:v===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(C-1,v+1)),disabled:v>=C-1||d,children:"Next"})]})]})]})}function xs({loading:d,data:c,page:u,totalPages:v,pageSize:C,allMovies:L,onlyMissing:$,reasonFilter:M,onPageChange:A,onRestart:h,lastUpdated:o}){const f=a.useMemo(()=>{let n=L;return $&&(n=n.filter(j=>!j.hasFile)),n},[L,$]),r=a.useMemo(()=>M==="all"?f:M==="none"?f.filter(n=>!n.reason):f.filter(n=>n.reason===M),[f,M]),x=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:n=>n.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const j=n.getValue();return j?e.jsx("span",{className:"table-badge table-badge-reason",children:j}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),m=Fe({data:r.slice(u*C,u*C+C),columns:x,getCoreRowModel:$e(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[c?.counts?`Available: ${c.counts.available??0} • Monitored: ${c.counts.monitored??0}`:"",o?` (updated ${o})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:h,disabled:d,children:[e.jsx(_e,{src:Ke}),"Restart"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):L.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:m.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(j=>e.jsx("th",{children:j.isPlaceholder?null:xe(j.column.columnDef.header,j.getContext())},j.id))},n.id))}),e.jsx("tbody",{children:m.getRowModel().rows.map(n=>{const j=n.original,_=`${j.title}-${j.year}`;return e.jsx("tr",{children:n.getVisibleCells().map(z=>e.jsx("td",{"data-label":String(z.column.columnDef.header),children:xe(z.column.columnDef.cell,z.getContext())},z.id))},_)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),r.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",u+1," of ",v," (",r.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>A(Math.max(0,u-1)),disabled:u===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>A(Math.min(v-1,u+1)),disabled:u>=v-1||d,children:"Next"})]})]})]})}function js({active:d}){const{push:c}=Xe(),{value:u,setValue:v,register:C,clearHandler:L}=qe(),{liveArr:$,setLiveArr:M}=es(),[A,h]=a.useState([]),[o,f]=a.useState(""),[r,x]=a.useState(null),[m,n]=a.useState(0),[j,_]=a.useState(""),[z,pe]=a.useState(!1),[ve,B]=a.useState(null),[U,W]=a.useState({}),[ye,b]=a.useState(Qe),[P,F]=a.useState(1),E=a.useRef(""),O=a.useRef({}),Y=a.useRef(u),Q=a.useRef(!1),[H,ce]=a.useState([]),[Re,ae]=a.useState(!1),[te,ne]=a.useState(0),[X,Ae]=a.useState(""),[we,de]=a.useState(null),[ie,le]=a.useState({key:"__instance",direction:"asc"}),[ge,ue]=a.useState(!1),[he,G]=a.useState("all"),[Ne,q]=a.useState({available:0,monitored:0,missing:0,total:0}),Ce=a.useCallback(async()=>{try{const t=await ss();t.ready===!1&&!Q.current?(Q.current=!0,c("Radarr backend is still initialising. Check the logs if this persists.","info")):t.ready&&(Q.current=!0);const s=(t.arr||[]).filter(l=>l.type==="radarr");if(h(s),!s.length){f("aggregate"),x(null),ce([]),q({available:0,monitored:0,missing:0,total:0});return}o===""?f(s.length===1?s[0].category:"aggregate"):o!=="aggregate"&&!s.some(l=>l.category===o)&&f(s[0].category)}catch(t){c(t instanceof Error?t.message:"Unable to load Radarr instances","error")}},[c,o]),re=a.useCallback(async(t,s,l,g,p)=>{if(g.length)try{const N=[];for(const S of g){const y=await Ye(t,S,l,s),R=y.page??S;if(N.push({page:R,movies:y.movies??[]}),E.current!==p)return}if(E.current!==p)return;W(S=>{const y={...S};let R=!1;for(const{page:w,movies:I}of N){const k=S[w]??[];JSON.stringify(k)!==JSON.stringify(I)&&(y[w]=I,R=!0)}return O.current=y,R?y:S})}catch(N){c(N instanceof Error?N.message:`Failed to load additional pages for ${t}`,"error")}},[c]),J=a.useCallback(async(t,s,l,g={})=>{const p=g.preloadAll!==!1;(g.showLoading??!0)&&pe(!0);try{const S=`${t}::${l}`,y=E.current!==S;y&&(E.current=S,W(()=>(O.current={},{})));const R=await Ye(t,s,Qe,l);x(R);const w=R.page??s;n(w),_(l);const I=R.page_size??Qe,k=R.total??(R.movies??[]).length,T=Math.max(1,Math.ceil((k||0)/I));b(I),F(T);const V=R.movies??[],je=y?{}:O.current,be=O.current[w]??[],oe=JSON.stringify(be)!==JSON.stringify(V);if((y||oe)&&(W(K=>{const Oe={...y?{}:K,[w]:V};return O.current=Oe,Oe}),B(new Date().toLocaleTimeString())),p){const K=[];for(let ee=0;ee<T;ee+=1)ee!==w&&(je[ee]||K.push(ee));re(t,l,I,K,S)}}catch(S){c(S instanceof Error?S.message:`Failed to load ${t} movies`,"error")}finally{pe(!1)}},[c,re]),me=a.useCallback(async()=>{if(!A.length){ce([]),q({available:0,monitored:0,missing:0,total:0});return}ae(!0);try{const t=[];let s=0,l=0;for(const p of A){let N=0,S=!1;const y=p.name||p.category;for(;N<100;){const R=await Ye(p.category,N,ls,"");if(!S){const I=R.counts;I&&(s+=I.available??0,l+=I.monitored??0),S=!0}const w=R.movies??[];if(w.forEach(I=>{t.push({...I,__instance:y})}),!w.length||w.length<ls)break;N+=1}}ce(p=>{const N=JSON.stringify(p),S=JSON.stringify(t);return N===S?p:t});const g={available:s,monitored:l,missing:t.length-s,total:t.length};q(p=>p.available===g.available&&p.monitored===g.monitored&&p.missing===g.missing&&p.total===g.total?p:g),X!==u&&(ne(0),Ae(u)),de(new Date().toLocaleTimeString())}catch(t){ce([]),q({available:0,monitored:0,missing:0,total:0}),c(t instanceof Error?t.message:"Failed to load aggregated Radarr data","error")}finally{ae(!1)}},[A,u,c]);a.useEffect(()=>{d&&Ce()},[d,Ce]),a.useEffect(()=>{if(!d||!o||o==="aggregate")return;O.current={},W({}),F(1),n(0);const t=Y.current;J(o,0,t,{preloadAll:!0,showLoading:!0})},[d,o,J]),a.useEffect(()=>{d&&o==="aggregate"&&me()},[d,o,me]),Pe(()=>{o==="aggregate"&&$&&me()},o==="aggregate"&&$?1e4:null),a.useEffect(()=>{if(!d)return;const t=s=>{o==="aggregate"?(Ae(s),ne(0)):o&&(n(0),J(o,0,s,{preloadAll:!0,showLoading:!0}))};return C(t),()=>{L(t)}},[d,o,C,L,J]),Pe(()=>{if(o&&o!=="aggregate"){if(Y.current?.trim?.()||"")return;J(o,m,j,{preloadAll:!1,showLoading:!1})}},d&&o&&o!=="aggregate"&&$?1e3:null),a.useEffect(()=>{Y.current=u},[u]),a.useEffect(()=>{o==="aggregate"&&Ae(u)},[o,u]);const Z=a.useMemo(()=>{let t=H;if(X){const s=X.toLowerCase();t=t.filter(l=>{const g=(l.title??"").toString().toLowerCase(),p=(l.__instance??"").toLowerCase();return g.includes(s)||p.includes(s)})}return ge&&(t=t.filter(s=>!s.hasFile)),he!=="all"&&(he==="none"?t=t.filter(s=>!s.reason):t=t.filter(s=>s.reason===he)),t},[H,X,ge,he]),fe=a.useMemo(()=>{const t=[...Z],s=(l,g)=>{switch(g){case"__instance":return(l.__instance||"").toLowerCase();case"title":return(l.title||"").toLowerCase();case"year":return l.year??0;case"monitored":return l.monitored?1:0;case"hasFile":return l.hasFile?1:0;default:return""}};return t.sort((l,g)=>{const p=s(l,ie.key),N=s(g,ie.key);let S=0;return typeof p=="number"&&typeof N=="number"?S=p-N:typeof p=="string"&&typeof N=="string"?S=p.localeCompare(N):S=String(p).localeCompare(String(N)),ie.direction==="asc"?S:-S}),t},[Z,ie]),ze=Math.max(1,Math.ceil(fe.length/ke)),Se=fe.slice(te*ke,te*ke+ke),Ee=a.useMemo(()=>{const t=Object.keys(U).map(Number).sort((l,g)=>l-g),s=[];return t.forEach(l=>{U[l]&&s.push(...U[l])}),s},[U]),Ie=a.useCallback(async()=>{if(!(!o||o==="aggregate"))try{await as(o),c(`Restarted ${o}`,"success")}catch(t){c(t instanceof Error?t.message:`Failed to restart ${o}`,"error")}},[o,c]),Me=a.useCallback(t=>{const s=t.target.value||"aggregate";f(s),s!=="aggregate"&&v("")},[f,v]),i=o==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Radarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[A.length>1&&e.jsx("button",{className:`btn ${i?"active":""}`,onClick:()=>f("aggregate"),children:"All Radarr"}),A.map(t=>e.jsx("button",{className:`btn ghost ${o===t.category?"active":""}`,onClick:()=>{f(t.category),v("")},children:t.name||t.category},t.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:o||"aggregate",onChange:Me,disabled:!A.length,children:[A.length>1&&e.jsx("option",{value:"aggregate",children:"All Radarr"}),A.map(t=>e.jsx("option",{value:t.category,children:t.name||t.category},t.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter movies",value:u,onChange:t=>v(t.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:t=>{const s=t.target.value;ue(s==="missing")},value:ge?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Movies"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:t=>G(t.target.value),value:he,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),i?e.jsx(fs,{loading:Re,rows:Se,total:fe.length,page:te,totalPages:ze,onPageChange:ne,onRefresh:()=>void me(),lastUpdated:we,sort:ie,onSort:t=>le(s=>s.key===t?{key:t,direction:s.direction==="asc"?"desc":"asc"}:{key:t,direction:"asc"}),summary:Ne,instanceCount:A.length}):e.jsx(xs,{loading:z,data:r,page:m,totalPages:P,pageSize:ye,allMovies:Ee,onlyMissing:ge,reasonFilter:he,onPageChange:t=>{n(t),J(o,t,j,{preloadAll:!0})},onRestart:()=>void Ie(),lastUpdated:ve})]})]})})]})}const Ze=25,Ve=50,rs=200;function bs(d,c){if(!c)return d;const u=[];for(const v of d){const C=v.seasons??{},L={};for(const[$,M]of Object.entries(C)){const A=(M.episodes??[]).filter(h=>!h.hasFile);A.length&&(L[$]={...M,episodes:A})}Object.keys(L).length!==0&&u.push({...v,seasons:L})}return u}function Ue(d,c){return JSON.stringify(bs(d,c))}function ps({active:d}){const{push:c}=Xe(),{value:u,setValue:v,register:C,clearHandler:L}=qe(),{liveArr:$,setLiveArr:M,groupSonarr:A,setGroupSonarr:h}=es(),[o,f]=a.useState([]),[r,x]=a.useState("aggregate"),[m,n]=a.useState(null),[j,_]=a.useState(0),[z,pe]=a.useState(""),[ve,B]=a.useState(!1),[U,W]=a.useState(null),[ye,b]=a.useState({}),P=a.useRef({}),F=a.useRef(null),E=a.useRef(""),[O,Y]=a.useState(Ze),[Q,H]=a.useState(1),[ce,Re]=a.useState(0),ae=a.useRef(u),te=a.useRef(!1),[ne,X]=a.useState([]),[Ae,we]=a.useState(!1),[de,ie]=a.useState(0),[le,ge]=a.useState(""),[ue,he]=a.useState(null),[G,Ne]=a.useState(!1),[q,Ce]=a.useState("all"),[re,J]=a.useState({available:0,monitored:0,missing:0,total:0}),me=a.useCallback(async()=>{try{const s=await ss();s.ready===!1&&!te.current?(te.current=!0,c("Sonarr backend is still initialising. Check the logs if this persists.","info")):s.ready&&(te.current=!0);const l=(s.arr||[]).filter(g=>g.type==="sonarr");if(f(l),!l.length){x("aggregate"),n(null),X([]),J({available:0,monitored:0,missing:0,total:0});return}r===""?x(l.length===1?l[0].category:"aggregate"):r!=="aggregate"&&!l.some(g=>g.category===r)&&x(l[0].category)}catch(s){c(s instanceof Error?s.message:"Unable to load Sonarr instances","error")}},[c,r]),Z=a.useCallback(async(s,l,g,p={})=>{const{preloadAll:N=!0,showLoading:S=!0,missingOnly:y}=p,R=y??G;S&&B(!0);try{const w=`${s}::${g}::${R?"missing":"all"}`,I=E.current!==w;I&&(E.current=w,b(()=>(P.current={},{})),Re(0),H(1));const k=await Ge(s,l,Ze,g,{missingOnly:R}),T=k.page??l,V=k.page_size??Ze,je=k.total??(k.series??[]).length,be=Math.max(1,Math.ceil((je||0)/V)),oe=k.series??[],K=I?{}:P.current,ee={...K,[T]:oe},Oe=Ue(K[T]??[],R),cs=Ue(oe,R),He=I||Oe!==cs;if(P.current=ee,He&&b(ee),n(D=>{const se=D?.counts??null,Le=k.counts??null;return!D||D.total!==k.total||D.page!==k.page||D.page_size!==k.page_size||(se?.available??null)!==(Le?.available??null)||(se?.monitored??null)!==(Le?.monitored??null)||(se?.missing??null)!==(Le?.missing??null)||He?(F.current=k,k):D}),_(D=>D===T?D:T),pe(D=>D===g?D:g),Y(D=>D===V?D:V),H(D=>D===be?D:be),Re(D=>D===je?D:je),He&&W(new Date().toLocaleTimeString()),N){const D=[];for(let se=0;se<be;se+=1)se!==T&&(ee[se]||D.push(se));for(const se of D)try{const Le=await Ge(s,se,V,g,{missingOnly:R});if(E.current!==w)break;const Te=Le.page??se,Je=Le.series??[],ns=P.current,ds=Ue(ns[Te]??[],R),gs=Ue(Je,R);if(ds===gs){P.current={...ns,[Te]:Je};continue}b(us=>{const is={...us,[Te]:Je};return P.current=is,is})}catch{break}}}catch(w){c(w instanceof Error?w.message:`Failed to load ${s} series`,"error")}finally{S&&B(!1)}},[c,G]),fe=a.useCallback(async()=>{if(!o.length){X([]),J({available:0,monitored:0,missing:0,total:0});return}console.log(`[Sonarr Aggregate] Starting aggregation for ${o.length} instances`),we(!0);try{const s=[];let l=0,g=0,p=0;for(const y of o){let R=0,w=!1;const I=y.name||y.category;for(console.log(`[Sonarr Aggregate] Processing instance: ${I}`);R<200;){const k=await Ge(y.category,R,rs,"",{missingOnly:G});if(console.log(`[Sonarr Aggregate] Response for ${I} page ${R}:`,{total:k.total,page:k.page,page_size:k.page_size,series_count:k.series?.length??0,counts:k.counts}),!w){const V=k.counts;V&&(l+=V.available??0,g+=V.monitored??0,p+=V.missing??0),w=!0}const T=k.series??[];if(console.log(`[Sonarr Aggregate] Instance: ${I}, Page: ${R}, Series count: ${T.length}, Total episodes so far: ${s.length}`),T.forEach(V=>{const je=V.series?.title||"";Object.entries(V.seasons??{}).forEach(([be,oe])=>{(oe.episodes??[]).forEach(K=>{s.push({__instance:I,series:je,season:be,episode:K.episodeNumber??"",title:K.title??"",monitored:!!K.monitored,hasFile:!!K.hasFile,airDate:K.airDateUtc??""})})})}),!T.length||T.length<rs){console.log(`[Sonarr Aggregate] Breaking pagination for ${I} - series.length=${T.length}`);break}R+=1}}const N=new Set(s.map(y=>`${y.__instance}::${y.series}`)).size;console.log("[Sonarr Aggregate] Aggregation complete:",{totalEpisodes:s.length,uniqueSeries:N,instances:o.length}),X(y=>{const R=JSON.stringify(y),w=JSON.stringify(s);return R===w?(console.log("[Sonarr Aggregate] Data unchanged, skipping update"),y):(console.log(`[Sonarr Aggregate] Data changed, updating from ${y.length} to ${s.length} episodes`),s)});const S={available:l,monitored:g,missing:p,total:s.length};J(y=>y.available===S.available&&y.monitored===S.monitored&&y.missing===S.missing&&y.total===S.total?y:S),le!==u&&(ie(0),ge(u)),he(new Date().toLocaleTimeString())}catch(s){X([]),J({available:0,monitored:0,missing:0,total:0}),c(s instanceof Error?s.message:"Failed to load aggregated Sonarr data","error")}finally{we(!1)}},[o,u,c,G]);a.useEffect(()=>{d&&me()},[d,me]),a.useEffect(()=>{if(!d||!r||r==="aggregate")return;_(0);const s=ae.current;Z(r,0,s,{preloadAll:!0,showLoading:!0,missingOnly:G})},[d,r,Z]),a.useEffect(()=>{d&&r==="aggregate"&&fe()},[d,r,fe]),Pe(()=>{r==="aggregate"&&$&&fe()},r==="aggregate"&&$?1e4:null),a.useEffect(()=>{if(!d)return;const s=l=>{r==="aggregate"?(ge(l),ie(0)):r&&(_(0),Z(r,0,l,{preloadAll:!0,showLoading:!0,missingOnly:G}))};return C(s),()=>L(s)},[d,r,C,L,Z,G]),Pe(()=>{if(r&&r!=="aggregate"){if(ae.current?.trim?.()||"")return;Z(r,j,z,{preloadAll:!1,showLoading:!1,missingOnly:G})}},d&&r&&r!=="aggregate"&&$?1e3:null),a.useEffect(()=>{ae.current=u},[u]),a.useEffect(()=>{r==="aggregate"&&ge(u)},[r,u]);const Se=a.useMemo(()=>{let s=ne;if(le){const l=le.toLowerCase();s=s.filter(g=>g.series.toLowerCase().includes(l)||g.title.toLowerCase().includes(l)||g.__instance.toLowerCase().includes(l))}return q!=="all"&&(q==="none"?s=s.filter(l=>!l.reason):s=s.filter(l=>l.reason===q)),s},[ne,le,q]),Ee=Math.max(1,Math.ceil(Se.length/Ve));Se.slice(de*Ve,de*Ve+Ve);const Ie=ye[j]??[],Me=a.useCallback(async()=>{if(!(!r||r==="aggregate"))try{await as(r),c(`Restarted ${r}`,"success")}catch(s){c(s instanceof Error?s.message:`Failed to restart ${r}`,"error")}},[r,c]),i=a.useCallback(s=>{const l=s.target.value||"aggregate";x(l),l!=="aggregate"&&v("")},[x,v]),t=r==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Sonarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[o.length>1&&e.jsx("button",{className:`btn ${t?"active":""}`,onClick:()=>x("aggregate"),children:"All Sonarr"}),o.map(s=>e.jsx("button",{className:`btn ghost ${r===s.category?"active":""}`,onClick:()=>{x(s.category),v("")},children:s.name||s.category},s.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:r||"aggregate",onChange:i,disabled:!o.length,children:[o.length>1&&e.jsx("option",{value:"aggregate",children:"All Sonarr"}),o.map(s=>e.jsx("option",{value:s.category,children:s.name||s.category},s.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter series or episodes",value:u,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:s=>{const g=s.target.value==="missing";Ne(g),r&&r!=="aggregate"&&Z(r,0,ae.current||"",{preloadAll:!0,showLoading:!0,missingOnly:g})},value:G?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Episodes"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:s=>Ce(s.target.value),value:q,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),t?e.jsx(vs,{loading:Ae,rows:Se,total:Se.length,page:de,totalPages:Ee,onPageChange:ie,onRefresh:()=>void fe(),lastUpdated:ue,groupSonarr:A,summary:re,instanceCount:o.length}):e.jsx(Ns,{loading:ve,counts:m?.counts??null,series:Ie,page:j,pageSize:O,totalPages:Q,totalItems:ce,onlyMissing:G,onPageChange:s=>{_(s),Z(r,s,z,{preloadAll:!1,showLoading:!0,missingOnly:G})},onRestart:()=>void Me(),lastUpdated:U,groupSonarr:A})]})]})})]})}function vs({loading:d,rows:c,total:u,page:v,totalPages:C,onPageChange:L,onRefresh:$,lastUpdated:M,groupSonarr:A,summary:h,instanceCount:o}){const f=a.useMemo(()=>{const b=new Map;c.forEach(F=>{const E=F.__instance,O=F.series,Y=String(F.season);b.has(E)||b.set(E,new Map);const Q=b.get(E);Q.has(O)||Q.set(O,new Map);const H=Q.get(O);H.has(Y)||H.set(Y,[]),H.get(Y).push(F)});const P=[];return b.forEach((F,E)=>{F.forEach((O,Y)=>{P.push({instance:E,series:Y,subRows:Array.from(O.entries()).map(([Q,H])=>({seasonNumber:Q,isSeason:!0,subRows:H.map(ce=>({...ce,isEpisode:!0}))}))})})}),P},[c]),r=a.useMemo(()=>f.slice(v*50,(v+1)*50),[f,v]),x=a.useMemo(()=>c.slice(v*50,(v+1)*50),[c,v]),m=A?r:x,n=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:({row:b})=>b.original.isEpisode?b.original.title:b.original.isSeason?`Season ${b.original.seasonNumber}`:b.original.series},{accessorKey:"monitored",header:"Monitored",cell:({row:b})=>{const P=(b.original.isEpisode,b.original.monitored);return e.jsx("span",{className:"table-badge",children:P?"Yes":"No"})}},{accessorKey:"hasFile",header:"Has File",cell:({row:b})=>b.original.isEpisode?e.jsx("span",{className:"table-badge",children:b.original.hasFile?"Yes":"No"}):null},{accessorKey:"airDate",header:"Air Date",cell:({row:b})=>b.original.isEpisode?b.original.airDate||"—":null}],[]),j=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance"},{accessorKey:"series",header:"Series"},{accessorKey:"season",header:"Season"},{accessorKey:"episode",header:"Episode"},{accessorKey:"title",header:"Title"},{accessorKey:"monitored",header:"Monitored",cell:({getValue:b})=>e.jsx("span",{className:"table-badge",children:b()?"Yes":"No"})},{accessorKey:"hasFile",header:"Has File",cell:({getValue:b})=>e.jsx("span",{className:"table-badge",children:b()?"Yes":"No"})},{accessorKey:"airDate",header:"Air Date",cell:({getValue:b})=>b()||"—"}],[]),_=A?n:j,z=Fe({data:m,columns:_,getCoreRowModel:$e(),getExpandedRowModel:hs()}),pe=Fe({data:m,columns:_,getCoreRowModel:$e(),getSortedRowModel:ts(),getPaginationRowModel:ms(),state:{pagination:{pageIndex:v,pageSize:50}},manualPagination:!0,pageCount:C}),ve=A?z:pe,B=50,U=Math.ceil(A?f.length/B:c.length/B),W=Math.min(v,Math.max(0,U-1)),ye=A?`${f.length} series`:c.length.toLocaleString();return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated episodes across all instances"," ",M?`(updated ${M})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",h.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",h.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",h.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total Episodes:"})," ",h.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:$,disabled:d,children:[e.jsx(_e,{src:Ke}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Sonarr library…"]}):A?e.jsx("div",{className:"sonarr-hierarchical-view",children:r.map(b=>e.jsxs("details",{className:"series-details",children:[e.jsxs("summary",{className:"series-summary",children:[e.jsx("span",{className:"series-title",children:b.series}),e.jsxs("span",{className:"series-instance",children:["(",b.instance,")"]})]}),e.jsx("div",{className:"series-content",children:b.subRows.map(P=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",P.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",P.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:P.subRows.map(F=>e.jsxs("tr",{children:[e.jsx("td",{children:F.episode}),e.jsx("td",{children:F.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:F.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:F.hasFile?"Yes":"No"})}),e.jsx("td",{children:F.airDate||"—"}),e.jsx("td",{children:F.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:F.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${F.__instance}-${F.series}-${F.season}-${F.episode}`))})]})})})]},`${b.instance}-${b.series}-${P.seasonNumber}`))})]},`${b.instance}-${b.series}`))}):m.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsx("tr",{children:ve.getFlatHeaders().map(b=>e.jsxs("th",{className:b.column.getCanSort()?"sortable":"",onClick:b.column.getToggleSortingHandler(),children:[b.isPlaceholder?null:xe(b.column.columnDef.header,b.getContext()),b.column.getCanSort()&&e.jsx("span",{className:"sort-arrow",children:{asc:"▲",desc:"▼"}[b.column.getIsSorted()]??null})]},b.id))})}),e.jsx("tbody",{children:ve.getRowModel().rows.map(b=>{const P=b.original,F=`${P.__instance}-${P.series}-${P.season}-${P.episode}`;return e.jsx("tr",{children:b.getVisibleCells().map(E=>e.jsx("td",{"data-label":E.column.columnDef.header,children:xe(E.column.columnDef.cell,E.getContext())},E.id))},F)})})]})}):e.jsx("div",{className:"hint",children:"No series found."}),m.length>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",W+1," of ",U," (",ye," items · page size ",B,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,W-1)),disabled:W===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(U-1,W+1)),disabled:W>=U-1||d,children:"Next"})]})]})]})}function Ns({loading:d,counts:c,series:u,page:v,pageSize:C,totalPages:L,onPageChange:$,groupSonarr:M}){const A=Math.min(v,Math.max(0,L-1)),h=a.useMemo(()=>{const f=[];for(const r of u){const x=r.series?.title||"";Object.entries(r.seasons??{}).forEach(([m,n])=>{(n.episodes??[]).forEach(j=>{f.push({__instance:"Instance",series:x,season:m,episode:j.episodeNumber??"",title:j.title??"",monitored:!!j.monitored,hasFile:!!j.hasFile,airDate:j.airDateUtc??""})})})}return f},[u]),o=a.useMemo(()=>{const f=new Map;return h.forEach(r=>{const x=r.series;f.has(x)||f.set(x,new Map);const m=f.get(x),n=String(r.season);m.has(n)||m.set(n,[]),m.get(n).push(r)}),Array.from(f.entries()).map(([r,x])=>({series:r,subRows:Array.from(x.entries()).map(([m,n])=>({seasonNumber:m,isSeason:!0,subRows:n.map(j=>({...j,isEpisode:!0}))}))}))},[h]);return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsx("div",{className:"row",style:{justifyContent:"space-between"},children:e.jsx("div",{className:"hint",children:c?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Available:"})," ",c.available.toLocaleString()," •"," ",e.jsx("strong",{children:"Monitored:"})," ",c.monitored.toLocaleString()," •"," ",e.jsx("strong",{children:"Missing:"})," ",c.missing?.toLocaleString()??0]}):"Loading series information..."})}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading series…"]}):M?e.jsx("div",{className:"sonarr-hierarchical-view",children:o.map(f=>e.jsxs("details",{className:"series-details",children:[e.jsx("summary",{className:"series-summary",children:e.jsx("span",{className:"series-title",children:f.series})}),e.jsx("div",{className:"series-content",children:f.subRows.map(r=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",r.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",r.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:r.subRows.map(x=>e.jsxs("tr",{children:[e.jsx("td",{children:x.episode}),e.jsx("td",{children:x.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:x.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:x.hasFile?"Yes":"No"})}),e.jsx("td",{children:x.airDate||"—"}),e.jsx("td",{children:x.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:x.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${x.series}-${x.season}-${x.episode}`))})]})})})]},`${f.series}-${r.seasonNumber}`))})]},`${f.series}`))}):h.length?e.jsxs("div",{className:"table-wrapper",children:[e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Series"}),e.jsx("th",{children:"Season"}),e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:h.slice(A*C,A*C+C).map((f,r)=>e.jsxs("tr",{children:[e.jsx("td",{children:f.series}),e.jsx("td",{children:f.season}),e.jsx("td",{children:f.episode}),e.jsx("td",{children:f.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:f.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:f.hasFile?"Yes":"No"})}),e.jsx("td",{children:f.airDate||"—"}),e.jsx("td",{children:f.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:f.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${f.series}-${f.season}-${f.episode}-${r}`))})]}),e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",A+1," of ",L," (",h.length.toLocaleString()," items · page size ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>$(Math.max(0,A-1)),disabled:A===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>$(Math.min(L-1,A+1)),disabled:A>=L-1||d,children:"Next"})]})]})]}):e.jsx("div",{className:"hint",children:"No series found."})]})}const Be=50,De=50,os=500;function Ss({loading:d,rows:c,total:u,page:v,totalPages:C,onPageChange:L,onRefresh:$,lastUpdated:M,onSort:A,summary:h,instanceCount:o}){const f=a.useMemo(()=>[...o>1?[{accessorKey:"__instance",header:"Instance",size:150}]:[],{accessorKey:"title",header:"Album",cell:x=>x.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:x=>{const m=x.getValue();return m?new Date(m).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:x=>x.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:x=>x.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:x=>{const m=x.getValue();return m?e.jsx("span",{className:"table-badge table-badge-reason",children:m}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[o]),r=Fe({data:c,columns:f,getCoreRowModel:$e()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated albums across all instances"," ",M?`(updated ${M})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",h.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",h.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",h.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",h.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:$,disabled:d,children:[e.jsx(_e,{src:Ke}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Lidarr library…"]}):u?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:r.getHeaderGroups().map(x=>e.jsx("tr",{children:x.headers.map(m=>e.jsx("th",{className:m.column.getCanSort()?"sortable":"",onClick:()=>{const n=m.id;A(n)},children:m.isPlaceholder?null:xe(m.column.columnDef.header,m.getContext())},m.id))},x.id))}),e.jsx("tbody",{children:r.getRowModel().rows.map(x=>{const m=x.original,n=`${m.__instance}-${m.title}-${m.artistName}`;return e.jsx("tr",{children:x.getVisibleCells().map(j=>e.jsx("td",{"data-label":String(j.column.columnDef.header),children:xe(j.column.columnDef.cell,j.getContext())},j.id))},n)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),u>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",v+1," of ",C," (",u.toLocaleString()," items · page size"," ",De,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,v-1)),disabled:v===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(C-1,v+1)),disabled:v>=C-1||d,children:"Next"})]})]})]})}function ys({loading:d,data:c,page:u,totalPages:v,pageSize:C,allAlbums:L,onlyMissing:$,reasonFilter:M,onPageChange:A,onRestart:h,lastUpdated:o}){const f=a.useMemo(()=>{let n=L;return $&&(n=n.filter(j=>!j.hasFile)),n},[L,$]),r=a.useMemo(()=>M==="all"?f:M==="none"?f.filter(n=>!n.reason):f.filter(n=>n.reason===M),[f,M]),x=a.useMemo(()=>[{accessorKey:"title",header:"Album",cell:n=>n.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:n=>{const j=n.getValue();return j?new Date(j).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const j=n.getValue();return j?e.jsx("span",{className:"table-badge table-badge-reason",children:j}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),m=Fe({data:r.slice(u*C,u*C+C),columns:x,getCoreRowModel:$e(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[c?.counts?`Available: ${c.counts.available??0} • Monitored: ${c.counts.monitored??0}`:"",o?` (updated ${o})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:h,disabled:d,children:[e.jsx(_e,{src:Ke}),"Restart"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):L.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:m.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(j=>e.jsx("th",{children:j.isPlaceholder?null:xe(j.column.columnDef.header,j.getContext())},j.id))},n.id))}),e.jsx("tbody",{children:m.getRowModel().rows.map(n=>{const j=n.original,_=`${j.title}-${j.artistName}`;return e.jsx("tr",{children:n.getVisibleCells().map(z=>e.jsx("td",{"data-label":String(z.column.columnDef.header),children:xe(z.column.columnDef.cell,z.getContext())},z.id))},_)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),r.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",u+1," of ",v," (",r.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>A(Math.max(0,u-1)),disabled:u===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>A(Math.min(v-1,u+1)),disabled:u>=v-1||d,children:"Next"})]})]})]})}function Rs({active:d}){const{push:c}=Xe(),{value:u,setValue:v,register:C,clearHandler:L}=qe(),{liveArr:$}=es(),[M,A]=a.useState([]),[h,o]=a.useState("aggregate"),[f,r]=a.useState(null),[x,m]=a.useState(0),[n,j]=a.useState(""),[_,z]=a.useState(!1),[pe,ve]=a.useState(null),[B,U]=a.useState({}),[W,ye]=a.useState(Be),[b,P]=a.useState(1),F=a.useRef(""),E=a.useRef({}),O=a.useRef(u),Y=a.useRef(!1),[Q,H]=a.useState([]),[ce,Re]=a.useState(!1),[ae,te]=a.useState(0),[ne,X]=a.useState(""),[Ae,we]=a.useState(null),[de,ie]=a.useState({key:"__instance",direction:"asc"}),[le,ge]=a.useState(!1),[ue,he]=a.useState("all"),[G,Ne]=a.useState({available:0,monitored:0,missing:0,total:0}),q=a.useCallback(async()=>{try{const i=await ss();i.ready===!1&&!Y.current?(Y.current=!0,c("Lidarr backend is still initialising. Check the logs if this persists.","info")):i.ready&&(Y.current=!0);const t=(i.arr||[]).filter(s=>s.type==="lidarr");if(A(t),!t.length){o("aggregate"),r(null),H([]),Ne({available:0,monitored:0,missing:0,total:0});return}h===""?o(t.length===1?t[0].category:"aggregate"):h!=="aggregate"&&!t.some(s=>s.category===h)&&o(t[0].category)}catch(i){c(i instanceof Error?i.message:"Unable to load Lidarr instances","error")}},[c,h]),Ce=a.useCallback(async(i,t,s,l,g)=>{if(l.length)try{const p=[];for(const N of l){const S=await We(i,N,s,t),y=S.page??N;if(p.push({page:y,albums:S.albums??[]}),F.current!==g)return}if(F.current!==g)return;U(N=>{const S={...N};let y=!1;for(const{page:R,albums:w}of p){const I=N[R]??[];JSON.stringify(I)!==JSON.stringify(w)&&(S[R]=w,y=!0)}return E.current=S,y?S:N})}catch(p){c(p instanceof Error?p.message:`Failed to load additional pages for ${i}`,"error")}},[c]),re=a.useCallback(async(i,t,s,l={})=>{const g=l.preloadAll!==!1;(l.showLoading??!0)&&z(!0);try{const N=`${i}::${s}`,S=F.current!==N;S&&(F.current=N,U(()=>(E.current={},{})));const y=await We(i,t,Be,s);r(y);const R=y.page??t;m(R),j(s);const w=y.page_size??Be,I=y.total??(y.albums??[]).length,k=Math.max(1,Math.ceil((I||0)/w));ye(w),P(k);const T=y.albums??[],V=S?{}:E.current,je=E.current[R]??[],be=JSON.stringify(je)!==JSON.stringify(T);if((S||be)&&(U(oe=>{const ee={...S?{}:oe,[R]:T};return E.current=ee,ee}),ve(new Date().toLocaleTimeString())),g){const oe=[];for(let K=0;K<k;K+=1)K!==R&&(V[K]||oe.push(K));Ce(i,s,w,oe,N)}}catch(N){c(N instanceof Error?N.message:`Failed to load ${i} albums`,"error")}finally{z(!1)}},[c,Ce]),J=a.useCallback(async()=>{if(!M.length){H([]),Ne({available:0,monitored:0,missing:0,total:0});return}Re(!0);try{const i=[];let t=0,s=0;for(const g of M){let p=0,N=!1;const S=g.name||g.category;for(;p<100;){const y=await We(g.category,p,os,"");if(!N){const w=y.counts;w&&(t+=w.available??0,s+=w.monitored??0),N=!0}const R=y.albums??[];if(R.forEach(w=>{i.push({...w,__instance:S})}),!R.length||R.length<os)break;p+=1}}H(g=>{const p=JSON.stringify(g),N=JSON.stringify(i);return p===N?g:i});const l={available:t,monitored:s,missing:i.length-t,total:i.length};Ne(g=>g.available===l.available&&g.monitored===l.monitored&&g.missing===l.missing&&g.total===l.total?g:l),ne!==u&&(te(0),X(u)),we(new Date().toLocaleTimeString())}catch(i){H([]),Ne({available:0,monitored:0,missing:0,total:0}),c(i instanceof Error?i.message:"Failed to load aggregated Lidarr data","error")}finally{Re(!1)}},[M,u,c]);a.useEffect(()=>{d&&q()},[d,q]),a.useEffect(()=>{if(!d||!h||h==="aggregate")return;E.current={},U({}),P(1),m(0);const i=O.current;re(h,0,i,{preloadAll:!0,showLoading:!0})},[d,h,re]),a.useEffect(()=>{d&&h==="aggregate"&&J()},[d,h,J]),Pe(()=>{h==="aggregate"&&$&&J()},h==="aggregate"&&$?1e4:null),a.useEffect(()=>{if(!d)return;const i=t=>{h==="aggregate"?(X(t),te(0)):h&&(m(0),re(h,0,t,{preloadAll:!0,showLoading:!0}))};return C(i),()=>{L(i)}},[d,h,C,L,re]),Pe(()=>{if(h&&h!=="aggregate"){if(O.current?.trim?.()||"")return;re(h,x,n,{preloadAll:!1,showLoading:!1})}},d&&h&&h!=="aggregate"&&$?1e3:null),a.useEffect(()=>{O.current=u},[u]),a.useEffect(()=>{h==="aggregate"&&X(u)},[h,u]);const me=a.useMemo(()=>{let i=Q;if(ne){const t=ne.toLowerCase();i=i.filter(s=>{const l=(s.title??"").toString().toLowerCase(),g=(s.artistName??"").toString().toLowerCase(),p=(s.__instance??"").toLowerCase();return l.includes(t)||g.includes(t)||p.includes(t)})}return le&&(i=i.filter(t=>!t.hasFile)),ue!=="all"&&(ue==="none"?i=i.filter(t=>!t.reason):i=i.filter(t=>t.reason===ue)),i},[Q,ne,le,ue]),Z=a.useMemo(()=>{const i=[...me],t=(s,l)=>{switch(l){case"__instance":return(s.__instance||"").toLowerCase();case"title":return(s.title||"").toLowerCase();case"artistName":return(s.artistName||"").toLowerCase();case"releaseDate":return s.releaseDate??"";case"monitored":return s.monitored?1:0;case"hasFile":return s.hasFile?1:0;default:return""}};return i.sort((s,l)=>{const g=t(s,de.key),p=t(l,de.key);let N=0;return typeof g=="number"&&typeof p=="number"?N=g-p:typeof g=="string"&&typeof p=="string"?N=g.localeCompare(p):N=String(g).localeCompare(String(p)),de.direction==="asc"?N:-N}),i},[me,de]),fe=Math.max(1,Math.ceil(Z.length/De)),ze=Z.slice(ae*De,ae*De+De),Se=a.useMemo(()=>{const i=Object.keys(B).map(Number).sort((s,l)=>s-l),t=[];return i.forEach(s=>{B[s]&&t.push(...B[s])}),t},[B]),Ee=a.useCallback(async()=>{if(!(!h||h==="aggregate"))try{await as(h),c(`Restarted ${h}`,"success")}catch(i){c(i instanceof Error?i.message:`Failed to restart ${h}`,"error")}},[h,c]),Ie=a.useCallback(i=>{const t=i.target.value||"aggregate";o(t),t!=="aggregate"&&v("")},[o,v]),Me=h==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Lidarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[M.length>1&&e.jsx("button",{className:`btn ${Me?"active":""}`,onClick:()=>o("aggregate"),children:"All Lidarr"}),M.map(i=>e.jsx("button",{className:`btn ghost ${h===i.category?"active":""}`,onClick:()=>{o(i.category),v("")},children:i.name||i.category},i.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:h||"aggregate",onChange:Ie,disabled:!M.length,children:[M.length>1&&e.jsx("option",{value:"aggregate",children:"All Lidarr"}),M.map(i=>e.jsx("option",{value:i.category,children:i.name||i.category},i.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter albums",value:u,onChange:i=>v(i.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:i=>{const t=i.target.value;ge(t==="missing")},value:le?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Albums"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:i=>he(i.target.value),value:ue,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),Me?e.jsx(Ss,{loading:ce,rows:ze,total:Z.length,page:ae,totalPages:fe,onPageChange:te,onRefresh:()=>void J(),lastUpdated:Ae,onSort:i=>ie(t=>t.key===i?{key:i,direction:t.direction==="asc"?"desc":"asc"}:{key:i,direction:"asc"}),summary:G,instanceCount:M.length}):e.jsx(ys,{loading:_,data:f,page:x,totalPages:b,pageSize:W,allAlbums:Se,onlyMissing:le,reasonFilter:ue,onPageChange:i=>{m(i),re(h,i,n,{preloadAll:!0})},onRestart:()=>void Ee(),lastUpdated:pe})]})]})})]})}function Ls({type:d,active:c}){return d==="radarr"?e.jsx(js,{active:c}):d==="lidarr"?e.jsx(Rs,{active:c}):e.jsx(ps,{active:c})}export{Ls as ArrView};
//# sourceMappingURL=ArrView.js.map
