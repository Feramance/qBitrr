import{u as Xe,h as qe,i as es,k as ss,l as Ye,m as as,j as e,I as _e,R as Ke,n as Ge,o as We}from"./app.js";import{r as a,u as Fe,f as xe,g as Ee,a as ts,b as hs,c as ms}from"./table.js";import{u as $e}from"./useInterval.js";import"./vendor.js";const Qe=50,Ie=50,is=500;function fs({loading:d,rows:c,total:u,page:v,totalPages:C,onPageChange:L,onRefresh:E,lastUpdated:w,sort:A,onSort:h,summary:o,instanceCount:f}){const r=a.useMemo(()=>[...f>1?[{accessorKey:"__instance",header:"Instance",size:150}]:[],{accessorKey:"title",header:"Title",cell:m=>m.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:m=>m.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:m=>m.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:m=>{const n=m.getValue();return n?e.jsx("span",{className:"table-badge table-badge-reason",children:n}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[f]),x=Fe({data:c,columns:r,getCoreRowModel:Ee()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated movies across all instances"," ",w?`(updated ${w})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",o.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",o.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",o.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",o.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:E,disabled:d,children:[e.jsx(_e,{src:Ke}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Radarr library…"]}):u?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:x.getHeaderGroups().map(m=>e.jsx("tr",{children:m.headers.map(n=>e.jsx("th",{className:n.column.getCanSort()?"sortable":"",onClick:()=>{const b=n.id;h(b)},children:n.isPlaceholder?null:xe(n.column.columnDef.header,n.getContext())},n.id))},m.id))}),e.jsx("tbody",{children:x.getRowModel().rows.map(m=>{const n=m.original,b=`${n.__instance}-${n.title}-${n.year}`;return e.jsx("tr",{children:m.getVisibleCells().map(_=>e.jsx("td",{"data-label":String(_.column.columnDef.header),children:xe(_.column.columnDef.cell,_.getContext())},_.id))},b)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),u>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",v+1," of ",C," (",u.toLocaleString()," items · page size"," ",Ie,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,v-1)),disabled:v===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(C-1,v+1)),disabled:v>=C-1||d,children:"Next"})]})]})]})}function xs({loading:d,data:c,page:u,totalPages:v,pageSize:C,allMovies:L,onlyMissing:E,reasonFilter:w,onPageChange:A,onRestart:h,lastUpdated:o}){const f=a.useMemo(()=>{let n=L;return E&&(n=n.filter(b=>!b.hasFile)),n},[L,E]),r=a.useMemo(()=>w==="all"?f:w==="none"?f.filter(n=>!n.reason):f.filter(n=>n.reason===w),[f,w]),x=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:n=>n.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const b=n.getValue();return b?e.jsx("span",{className:"table-badge table-badge-reason",children:b}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),m=Fe({data:r.slice(u*C,u*C+C),columns:x,getCoreRowModel:Ee(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[c?.counts?`Available: ${c.counts.available??0} • Monitored: ${c.counts.monitored??0}`:"",o?` (updated ${o})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:h,disabled:d,children:[e.jsx(_e,{src:Ke}),"Restart"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):L.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:m.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(b=>e.jsx("th",{children:b.isPlaceholder?null:xe(b.column.columnDef.header,b.getContext())},b.id))},n.id))}),e.jsx("tbody",{children:m.getRowModel().rows.map(n=>{const b=n.original,_=`${b.title}-${b.year}`;return e.jsx("tr",{children:n.getVisibleCells().map(z=>e.jsx("td",{"data-label":String(z.column.columnDef.header),children:xe(z.column.columnDef.cell,z.getContext())},z.id))},_)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),r.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",u+1," of ",v," (",r.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>A(Math.max(0,u-1)),disabled:u===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>A(Math.min(v-1,u+1)),disabled:u>=v-1||d,children:"Next"})]})]})]})}function bs({active:d}){const{push:c}=Xe(),{value:u,setValue:v,register:C,clearHandler:L}=qe(),{liveArr:E,setLiveArr:w}=es(),[A,h]=a.useState([]),[o,f]=a.useState(""),[r,x]=a.useState(null),[m,n]=a.useState(0),[b,_]=a.useState(""),[z,pe]=a.useState(!1),[ve,B]=a.useState(null),[H,W]=a.useState({}),[ye,j]=a.useState(Qe),[$,F]=a.useState(1),P=a.useRef(""),T=a.useRef({}),Y=a.useRef(u),Q=a.useRef(!1),[U,ce]=a.useState([]),[Re,ae]=a.useState(!1),[te,ne]=a.useState(0),[X,Ae]=a.useState(""),[Me,de]=a.useState(null),[le,ie]=a.useState({key:"__instance",direction:"asc"}),[ge,ue]=a.useState(!1),[he,G]=a.useState("all"),[Ne,q]=a.useState({available:0,monitored:0,missing:0,total:0}),Ce=a.useCallback(async()=>{try{const t=await ss();t.ready===!1&&!Q.current?(Q.current=!0,c("Radarr backend is still initialising. Check the logs if this persists.","info")):t.ready&&(Q.current=!0);const s=(t.arr||[]).filter(i=>i.type==="radarr");if(h(s),!s.length){f("aggregate"),x(null),ce([]),q({available:0,monitored:0,missing:0,total:0});return}o===""?f(s.length===1?s[0].category:"aggregate"):o!=="aggregate"&&!s.some(i=>i.category===o)&&f(s[0].category)}catch(t){c(t instanceof Error?t.message:"Unable to load Radarr instances","error")}},[c,o]),re=a.useCallback(async(t,s,i,g,p)=>{if(g.length)try{const N=[];for(const S of g){const y=await Ye(t,S,i,s),R=y.page??S;if(N.push({page:R,movies:y.movies??[]}),P.current!==p)return}if(P.current!==p)return;W(S=>{const y={...S};let R=!1;for(const{page:M,movies:D}of N){const I=S[M]??[];JSON.stringify(I)!==JSON.stringify(D)&&(y[M]=D,R=!0)}return T.current=y,R?y:S})}catch(N){c(N instanceof Error?N.message:`Failed to load additional pages for ${t}`,"error")}},[c]),J=a.useCallback(async(t,s,i,g={})=>{const p=g.preloadAll!==!1;(g.showLoading??!0)&&pe(!0);try{const S=`${t}::${i}`,y=P.current!==S;y&&(P.current=S,W(()=>(T.current={},{})));const R=await Ye(t,s,Qe,i);x(R);const M=R.page??s;n(M),_(i);const D=R.page_size??Qe,I=R.total??(R.movies??[]).length,O=Math.max(1,Math.ceil((I||0)/D));j(D),F(O);const V=R.movies??[],be=y?{}:T.current,je=T.current[M]??[],oe=JSON.stringify(je)!==JSON.stringify(V);if((y||oe)&&(W(K=>{const Te={...y?{}:K,[M]:V};return T.current=Te,Te}),B(new Date().toLocaleTimeString())),p){const K=[];for(let ee=0;ee<O;ee+=1)ee!==M&&(be[ee]||K.push(ee));re(t,i,D,K,S)}}catch(S){c(S instanceof Error?S.message:`Failed to load ${t} movies`,"error")}finally{pe(!1)}},[c,re]),me=a.useCallback(async()=>{if(!A.length){ce([]),q({available:0,monitored:0,missing:0,total:0});return}ae(!0);try{const t=[];let s=0,i=0;for(const p of A){let N=0,S=!1;const y=p.name||p.category;for(;N<100;){const R=await Ye(p.category,N,is,"");if(!S){const D=R.counts;D&&(s+=D.available??0,i+=D.monitored??0),S=!0}const M=R.movies??[];if(M.forEach(D=>{t.push({...D,__instance:y})}),!M.length||M.length<is)break;N+=1}}ce(p=>{const N=JSON.stringify(p),S=JSON.stringify(t);return N===S?p:t});const g={available:s,monitored:i,missing:t.length-s,total:t.length};q(p=>p.available===g.available&&p.monitored===g.monitored&&p.missing===g.missing&&p.total===g.total?p:g),X!==u&&(ne(0),Ae(u)),de(new Date().toLocaleTimeString())}catch(t){ce([]),q({available:0,monitored:0,missing:0,total:0}),c(t instanceof Error?t.message:"Failed to load aggregated Radarr data","error")}finally{ae(!1)}},[A,u,c]);a.useEffect(()=>{d&&Ce()},[d,Ce]),a.useEffect(()=>{if(!d||!o||o==="aggregate")return;T.current={},W({}),F(1),n(0);const t=Y.current;J(o,0,t,{preloadAll:!0,showLoading:!0})},[d,o,J]),a.useEffect(()=>{d&&o==="aggregate"&&me()},[d,o,me]),$e(()=>{o==="aggregate"&&E&&me()},o==="aggregate"&&E?1e4:null),a.useEffect(()=>{if(!d)return;const t=s=>{o==="aggregate"?(Ae(s),ne(0)):o&&(n(0),J(o,0,s,{preloadAll:!0,showLoading:!0}))};return C(t),()=>{L(t)}},[d,o,C,L,J]),$e(()=>{if(o&&o!=="aggregate"){if(Y.current?.trim?.()||"")return;J(o,m,b,{preloadAll:!1,showLoading:!1})}},d&&o&&o!=="aggregate"&&E?1e3:null),a.useEffect(()=>{Y.current=u},[u]),a.useEffect(()=>{o==="aggregate"&&Ae(u)},[o,u]);const Z=a.useMemo(()=>{let t=U;if(X){const s=X.toLowerCase();t=t.filter(i=>{const g=(i.title??"").toString().toLowerCase(),p=(i.__instance??"").toLowerCase();return g.includes(s)||p.includes(s)})}return ge&&(t=t.filter(s=>!s.hasFile)),he!=="all"&&(he==="none"?t=t.filter(s=>!s.reason):t=t.filter(s=>s.reason===he)),t},[U,X,ge,he]),fe=a.useMemo(()=>{const t=[...Z],s=(i,g)=>{switch(g){case"__instance":return(i.__instance||"").toLowerCase();case"title":return(i.title||"").toLowerCase();case"year":return i.year??0;case"monitored":return i.monitored?1:0;case"hasFile":return i.hasFile?1:0;default:return""}};return t.sort((i,g)=>{const p=s(i,le.key),N=s(g,le.key);let S=0;return typeof p=="number"&&typeof N=="number"?S=p-N:typeof p=="string"&&typeof N=="string"?S=p.localeCompare(N):S=String(p).localeCompare(String(N)),le.direction==="asc"?S:-S}),t},[Z,le]),ze=Math.max(1,Math.ceil(fe.length/Ie)),Se=fe.slice(te*Ie,te*Ie+Ie),Pe=a.useMemo(()=>{const t=Object.keys(H).map(Number).sort((i,g)=>i-g),s=[];return t.forEach(i=>{H[i]&&s.push(...H[i])}),s},[H]),De=a.useCallback(async()=>{if(!(!o||o==="aggregate"))try{await as(o),c(`Restarted ${o}`,"success")}catch(t){c(t instanceof Error?t.message:`Failed to restart ${o}`,"error")}},[o,c]),we=a.useCallback(t=>{const s=t.target.value||"aggregate";f(s),s!=="aggregate"&&v("")},[f,v]),l=o==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Radarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[A.length>1&&e.jsx("button",{className:`btn ${l?"active":""}`,onClick:()=>f("aggregate"),children:"All Radarr"}),A.map(t=>e.jsx("button",{className:`btn ghost ${o===t.category?"active":""}`,onClick:()=>{f(t.category),v("")},children:t.name||t.category},t.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:o||"aggregate",onChange:we,disabled:!A.length,children:[A.length>1&&e.jsx("option",{value:"aggregate",children:"All Radarr"}),A.map(t=>e.jsx("option",{value:t.category,children:t.name||t.category},t.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter movies",value:u,onChange:t=>v(t.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:t=>{const s=t.target.value;ue(s==="missing")},value:ge?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Movies"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:t=>G(t.target.value),value:he,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),l?e.jsx(fs,{loading:Re,rows:Se,total:fe.length,page:te,totalPages:ze,onPageChange:ne,onRefresh:()=>void me(),lastUpdated:Me,sort:le,onSort:t=>ie(s=>s.key===t?{key:t,direction:s.direction==="asc"?"desc":"asc"}:{key:t,direction:"asc"}),summary:Ne,instanceCount:A.length}):e.jsx(xs,{loading:z,data:r,page:m,totalPages:$,pageSize:ye,allMovies:Pe,onlyMissing:ge,reasonFilter:he,onPageChange:t=>{n(t),J(o,t,b,{preloadAll:!0})},onRestart:()=>void De(),lastUpdated:ve})]})]})})]})}const Ze=25,Ve=50,rs=200;function js(d,c){if(!c)return d;const u=[];for(const v of d){const C=v.seasons??{},L={};for(const[E,w]of Object.entries(C)){const A=(w.episodes??[]).filter(h=>!h.hasFile);A.length&&(L[E]={...w,episodes:A})}Object.keys(L).length!==0&&u.push({...v,seasons:L})}return u}function He(d,c){return JSON.stringify(js(d,c))}function ps({active:d}){const{push:c}=Xe(),{value:u,setValue:v,register:C,clearHandler:L}=qe(),{liveArr:E,setLiveArr:w,groupSonarr:A,setGroupSonarr:h}=es(),[o,f]=a.useState([]),[r,x]=a.useState("aggregate"),[m,n]=a.useState(null),[b,_]=a.useState(0),[z,pe]=a.useState(""),[ve,B]=a.useState(!1),[H,W]=a.useState(null),[ye,j]=a.useState({}),$=a.useRef({}),F=a.useRef(null),P=a.useRef(""),[T,Y]=a.useState(Ze),[Q,U]=a.useState(1),[ce,Re]=a.useState(0),ae=a.useRef(u),te=a.useRef(!1),[ne,X]=a.useState([]),[Ae,Me]=a.useState(!1),[de,le]=a.useState(0),[ie,ge]=a.useState(""),[ue,he]=a.useState(null),[G,Ne]=a.useState(!1),[q,Ce]=a.useState("all"),[re,J]=a.useState({available:0,monitored:0,missing:0,total:0}),me=a.useCallback(async()=>{try{const s=await ss();s.ready===!1&&!te.current?(te.current=!0,c("Sonarr backend is still initialising. Check the logs if this persists.","info")):s.ready&&(te.current=!0);const i=(s.arr||[]).filter(g=>g.type==="sonarr");if(f(i),!i.length){x("aggregate"),n(null),X([]),J({available:0,monitored:0,missing:0,total:0});return}r===""?x(i.length===1?i[0].category:"aggregate"):r!=="aggregate"&&!i.some(g=>g.category===r)&&x(i[0].category)}catch(s){c(s instanceof Error?s.message:"Unable to load Sonarr instances","error")}},[c,r]),Z=a.useCallback(async(s,i,g,p={})=>{const{preloadAll:N=!0,showLoading:S=!0,missingOnly:y}=p,R=y??G;S&&B(!0);try{const M=`${s}::${g}::${R?"missing":"all"}`,D=P.current!==M;D&&(P.current=M,j(()=>($.current={},{})),Re(0),U(1));const I=await Ge(s,i,Ze,g,{missingOnly:R}),O=I.page??i,V=I.page_size??Ze,be=I.total??(I.series??[]).length,je=Math.max(1,Math.ceil((be||0)/V)),oe=I.series??[],K=D?{}:$.current,ee={...K,[O]:oe},Te=He(K[O]??[],R),cs=He(oe,R),Ue=D||Te!==cs;if($.current=ee,Ue&&j(ee),n(k=>{const se=k?.counts??null,Le=I.counts??null;return!k||k.total!==I.total||k.page!==I.page||k.page_size!==I.page_size||(se?.available??null)!==(Le?.available??null)||(se?.monitored??null)!==(Le?.monitored??null)||(se?.missing??null)!==(Le?.missing??null)||Ue?(F.current=I,I):k}),_(k=>k===O?k:O),pe(k=>k===g?k:g),Y(k=>k===V?k:V),U(k=>k===je?k:je),Re(k=>k===be?k:be),Ue&&W(new Date().toLocaleTimeString()),N){const k=[];for(let se=0;se<je;se+=1)se!==O&&(ee[se]||k.push(se));for(const se of k)try{const Le=await Ge(s,se,V,g,{missingOnly:R});if(P.current!==M)break;const Oe=Le.page??se,Je=Le.series??[],ns=$.current,ds=He(ns[Oe]??[],R),gs=He(Je,R);if(ds===gs){$.current={...ns,[Oe]:Je};continue}j(us=>{const ls={...us,[Oe]:Je};return $.current=ls,ls})}catch{break}}}catch(M){c(M instanceof Error?M.message:`Failed to load ${s} series`,"error")}finally{S&&B(!1)}},[c,G]),fe=a.useCallback(async()=>{if(!o.length){X([]),J({available:0,monitored:0,missing:0,total:0});return}console.log(`[Sonarr Aggregate] Starting aggregation for ${o.length} instances`),Me(!0);try{const s=[];let i=0,g=0,p=0;for(const y of o){let R=0,M=!1;const D=y.name||y.category;for(console.log(`[Sonarr Aggregate] Processing instance: ${D}`);R<200;){const I=await Ge(y.category,R,rs,"",{missingOnly:G});if(console.log(`[Sonarr Aggregate] Response for ${D} page ${R}:`,{total:I.total,page:I.page,page_size:I.page_size,series_count:I.series?.length??0,counts:I.counts}),!M){const V=I.counts;V&&(i+=V.available??0,g+=V.monitored??0,p+=V.missing??0),M=!0}const O=I.series??[];if(console.log(`[Sonarr Aggregate] Instance: ${D}, Page: ${R}, Series count: ${O.length}, Total episodes so far: ${s.length}`),O.forEach(V=>{const be=V.series?.title||"";Object.entries(V.seasons??{}).forEach(([je,oe])=>{(oe.episodes??[]).forEach(K=>{s.push({__instance:D,series:be,season:je,episode:K.episodeNumber??"",title:K.title??"",monitored:!!K.monitored,hasFile:!!K.hasFile,airDate:K.airDateUtc??""})})})}),!O.length||O.length<rs){console.log(`[Sonarr Aggregate] Breaking pagination for ${D} - series.length=${O.length}`);break}R+=1}}const N=new Set(s.map(y=>`${y.__instance}::${y.series}`)).size;console.log("[Sonarr Aggregate] Aggregation complete:",{totalEpisodes:s.length,uniqueSeries:N,instances:o.length}),X(y=>{const R=JSON.stringify(y),M=JSON.stringify(s);return R===M?(console.log("[Sonarr Aggregate] Data unchanged, skipping update"),y):(console.log(`[Sonarr Aggregate] Data changed, updating from ${y.length} to ${s.length} episodes`),s)});const S={available:i,monitored:g,missing:p,total:s.length};J(y=>y.available===S.available&&y.monitored===S.monitored&&y.missing===S.missing&&y.total===S.total?y:S),ie!==u&&(le(0),ge(u)),he(new Date().toLocaleTimeString())}catch(s){X([]),J({available:0,monitored:0,missing:0,total:0}),c(s instanceof Error?s.message:"Failed to load aggregated Sonarr data","error")}finally{Me(!1)}},[o,u,c,G]);a.useEffect(()=>{d&&me()},[d,me]),a.useEffect(()=>{if(!d||!r||r==="aggregate")return;_(0);const s=ae.current;Z(r,0,s,{preloadAll:!0,showLoading:!0,missingOnly:G})},[d,r,Z]),a.useEffect(()=>{d&&r==="aggregate"&&fe()},[d,r,fe]),$e(()=>{r==="aggregate"&&E&&fe()},r==="aggregate"&&E?1e4:null),a.useEffect(()=>{if(!d)return;const s=i=>{r==="aggregate"?(ge(i),le(0)):r&&(_(0),Z(r,0,i,{preloadAll:!0,showLoading:!0,missingOnly:G}))};return C(s),()=>L(s)},[d,r,C,L,Z,G]),$e(()=>{if(r&&r!=="aggregate"){if(ae.current?.trim?.()||"")return;Z(r,b,z,{preloadAll:!1,showLoading:!1,missingOnly:G})}},d&&r&&r!=="aggregate"&&E?1e3:null),a.useEffect(()=>{ae.current=u},[u]),a.useEffect(()=>{r==="aggregate"&&ge(u)},[r,u]);const Se=a.useMemo(()=>{let s=ne;if(ie){const i=ie.toLowerCase();s=s.filter(g=>g.series.toLowerCase().includes(i)||g.title.toLowerCase().includes(i)||g.__instance.toLowerCase().includes(i))}return q!=="all"&&(q==="none"?s=s.filter(i=>!i.reason):s=s.filter(i=>i.reason===q)),s},[ne,ie,q]),Pe=Math.max(1,Math.ceil(Se.length/Ve));Se.slice(de*Ve,de*Ve+Ve);const De=ye[b]??[],we=a.useCallback(async()=>{if(!(!r||r==="aggregate"))try{await as(r),c(`Restarted ${r}`,"success")}catch(s){c(s instanceof Error?s.message:`Failed to restart ${r}`,"error")}},[r,c]),l=a.useCallback(s=>{const i=s.target.value||"aggregate";x(i),i!=="aggregate"&&v("")},[x,v]),t=r==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Sonarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[o.length>1&&e.jsx("button",{className:`btn ${t?"active":""}`,onClick:()=>x("aggregate"),children:"All Sonarr"}),o.map(s=>e.jsx("button",{className:`btn ghost ${r===s.category?"active":""}`,onClick:()=>{x(s.category),v("")},children:s.name||s.category},s.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:r||"aggregate",onChange:l,disabled:!o.length,children:[o.length>1&&e.jsx("option",{value:"aggregate",children:"All Sonarr"}),o.map(s=>e.jsx("option",{value:s.category,children:s.name||s.category},s.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter series or episodes",value:u,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:s=>{const g=s.target.value==="missing";Ne(g),r&&r!=="aggregate"&&Z(r,0,ae.current||"",{preloadAll:!0,showLoading:!0,missingOnly:g})},value:G?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Episodes"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:s=>Ce(s.target.value),value:q,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),t?e.jsx(vs,{loading:Ae,rows:Se,total:Se.length,page:de,totalPages:Pe,onPageChange:le,onRefresh:()=>void fe(),lastUpdated:ue,groupSonarr:A,summary:re,instanceCount:o.length}):e.jsx(Ns,{loading:ve,counts:m?.counts??null,series:De,page:b,pageSize:T,totalPages:Q,totalItems:ce,onlyMissing:G,onPageChange:s=>{_(s),Z(r,s,z,{preloadAll:!1,showLoading:!0,missingOnly:G})},onRestart:()=>void we(),lastUpdated:H,groupSonarr:A})]})]})})]})}function vs({loading:d,rows:c,total:u,page:v,totalPages:C,onPageChange:L,onRefresh:E,lastUpdated:w,groupSonarr:A,summary:h,instanceCount:o}){const f=a.useMemo(()=>{const j=new Map;c.forEach(F=>{const P=F.__instance,T=F.series,Y=String(F.season);j.has(P)||j.set(P,new Map);const Q=j.get(P);Q.has(T)||Q.set(T,new Map);const U=Q.get(T);U.has(Y)||U.set(Y,[]),U.get(Y).push(F)});const $=[];return j.forEach((F,P)=>{F.forEach((T,Y)=>{$.push({instance:P,series:Y,subRows:Array.from(T.entries()).map(([Q,U])=>({seasonNumber:Q,isSeason:!0,subRows:U.map(ce=>({...ce,isEpisode:!0}))}))})})}),$},[c]),r=a.useMemo(()=>f.slice(v*50,(v+1)*50),[f,v]),x=a.useMemo(()=>c.slice(v*50,(v+1)*50),[c,v]),m=A?r:x,n=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:({row:j})=>j.original.isEpisode?j.original.title:j.original.isSeason?`Season ${j.original.seasonNumber}`:j.original.series},{accessorKey:"monitored",header:"Monitored",cell:({row:j})=>{const $=(j.original.isEpisode,j.original.monitored);return e.jsx("span",{className:"table-badge",children:$?"Yes":"No"})}},{accessorKey:"hasFile",header:"Has File",cell:({row:j})=>j.original.isEpisode?e.jsx("span",{className:"table-badge",children:j.original.hasFile?"Yes":"No"}):null},{accessorKey:"airDate",header:"Air Date",cell:({row:j})=>j.original.isEpisode?j.original.airDate||"—":null}],[]),b=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance"},{accessorKey:"series",header:"Series"},{accessorKey:"season",header:"Season"},{accessorKey:"episode",header:"Episode"},{accessorKey:"title",header:"Title"},{accessorKey:"monitored",header:"Monitored",cell:({getValue:j})=>e.jsx("span",{className:"table-badge",children:j()?"Yes":"No"})},{accessorKey:"hasFile",header:"Has File",cell:({getValue:j})=>e.jsx("span",{className:"table-badge",children:j()?"Yes":"No"})},{accessorKey:"airDate",header:"Air Date",cell:({getValue:j})=>j()||"—"}],[]),_=A?n:b,z=Fe({data:m,columns:_,getCoreRowModel:Ee(),getExpandedRowModel:hs()}),pe=Fe({data:m,columns:_,getCoreRowModel:Ee(),getSortedRowModel:ts(),getPaginationRowModel:ms(),state:{pagination:{pageIndex:v,pageSize:50}},manualPagination:!0,pageCount:C}),ve=A?z:pe,B=50,H=Math.ceil(A?f.length/B:c.length/B),W=Math.min(v,Math.max(0,H-1)),ye=A?`${f.length} series`:c.length.toLocaleString();return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated episodes across all instances"," ",w?`(updated ${w})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",h.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",h.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",h.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total Episodes:"})," ",h.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:E,disabled:d,children:[e.jsx(_e,{src:Ke}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Sonarr library…"]}):A?e.jsx("div",{className:"sonarr-hierarchical-view",children:r.map(j=>e.jsxs("details",{className:"series-details",children:[e.jsxs("summary",{className:"series-summary",children:[e.jsx("span",{className:"series-title",children:j.series}),e.jsxs("span",{className:"series-instance",children:["(",j.instance,")"]})]}),e.jsx("div",{className:"series-content",children:j.subRows.map($=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",$.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",$.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:$.subRows.map(F=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Episode",children:F.episode}),e.jsx("td",{"data-label":"Title",children:F.title}),e.jsx("td",{"data-label":"Monitored",children:e.jsx("span",{className:"table-badge",children:F.monitored?"Yes":"No"})}),e.jsx("td",{"data-label":"Has File",children:e.jsx("span",{className:"table-badge",children:F.hasFile?"Yes":"No"})}),e.jsx("td",{"data-label":"Air Date",children:F.airDate||"—"}),e.jsx("td",{"data-label":"Reason",children:F.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:F.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${F.__instance}-${F.series}-${F.season}-${F.episode}`))})]})})})]},`${j.instance}-${j.series}-${$.seasonNumber}`))})]},`${j.instance}-${j.series}`))}):m.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsx("tr",{children:ve.getFlatHeaders().map(j=>e.jsxs("th",{className:j.column.getCanSort()?"sortable":"",onClick:j.column.getToggleSortingHandler(),children:[j.isPlaceholder?null:xe(j.column.columnDef.header,j.getContext()),j.column.getCanSort()&&e.jsx("span",{className:"sort-arrow",children:{asc:"▲",desc:"▼"}[j.column.getIsSorted()]??null})]},j.id))})}),e.jsx("tbody",{children:ve.getRowModel().rows.map(j=>{const $=j.original,F=`${$.__instance}-${$.series}-${$.season}-${$.episode}`;return e.jsx("tr",{children:j.getVisibleCells().map(P=>e.jsx("td",{"data-label":P.column.columnDef.header,children:xe(P.column.columnDef.cell,P.getContext())},P.id))},F)})})]})}):e.jsx("div",{className:"hint",children:"No series found."}),m.length>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",W+1," of ",H," (",ye," items · page size ",B,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,W-1)),disabled:W===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(H-1,W+1)),disabled:W>=H-1||d,children:"Next"})]})]})]})}function Ns({loading:d,counts:c,series:u,page:v,pageSize:C,totalPages:L,onPageChange:E,groupSonarr:w}){const A=Math.min(v,Math.max(0,L-1)),h=a.useMemo(()=>{const f=[];for(const r of u){const x=r.series?.title||"";Object.entries(r.seasons??{}).forEach(([m,n])=>{(n.episodes??[]).forEach(b=>{f.push({__instance:"Instance",series:x,season:m,episode:b.episodeNumber??"",title:b.title??"",monitored:!!b.monitored,hasFile:!!b.hasFile,airDate:b.airDateUtc??""})})})}return f},[u]),o=a.useMemo(()=>{const f=new Map;return h.forEach(r=>{const x=r.series;f.has(x)||f.set(x,new Map);const m=f.get(x),n=String(r.season);m.has(n)||m.set(n,[]),m.get(n).push(r)}),Array.from(f.entries()).map(([r,x])=>({series:r,subRows:Array.from(x.entries()).map(([m,n])=>({seasonNumber:m,isSeason:!0,subRows:n.map(b=>({...b,isEpisode:!0}))}))}))},[h]);return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsx("div",{className:"row",style:{justifyContent:"space-between"},children:e.jsx("div",{className:"hint",children:c?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Available:"})," ",c.available.toLocaleString()," •"," ",e.jsx("strong",{children:"Monitored:"})," ",c.monitored.toLocaleString()," •"," ",e.jsx("strong",{children:"Missing:"})," ",c.missing?.toLocaleString()??0]}):"Loading series information..."})}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading series…"]}):w?e.jsx("div",{className:"sonarr-hierarchical-view",children:o.map(f=>e.jsxs("details",{className:"series-details",children:[e.jsx("summary",{className:"series-summary",children:e.jsx("span",{className:"series-title",children:f.series})}),e.jsx("div",{className:"series-content",children:f.subRows.map(r=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",r.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",r.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:r.subRows.map(x=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Episode",children:x.episode}),e.jsx("td",{"data-label":"Title",children:x.title}),e.jsx("td",{"data-label":"Monitored",children:e.jsx("span",{className:"table-badge",children:x.monitored?"Yes":"No"})}),e.jsx("td",{"data-label":"Has File",children:e.jsx("span",{className:"table-badge",children:x.hasFile?"Yes":"No"})}),e.jsx("td",{"data-label":"Air Date",children:x.airDate||"—"}),e.jsx("td",{"data-label":"Reason",children:x.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:x.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${x.series}-${x.season}-${x.episode}`))})]})})})]},`${f.series}-${r.seasonNumber}`))})]},`${f.series}`))}):h.length?e.jsxs("div",{className:"table-wrapper",children:[e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Series"}),e.jsx("th",{children:"Season"}),e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:h.slice(A*C,A*C+C).map((f,r)=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Series",children:f.series}),e.jsx("td",{"data-label":"Season",children:f.season}),e.jsx("td",{"data-label":"Episode",children:f.episode}),e.jsx("td",{"data-label":"Title",children:f.title}),e.jsx("td",{"data-label":"Monitored",children:e.jsx("span",{className:"table-badge",children:f.monitored?"Yes":"No"})}),e.jsx("td",{"data-label":"Has File",children:e.jsx("span",{className:"table-badge",children:f.hasFile?"Yes":"No"})}),e.jsx("td",{"data-label":"Air Date",children:f.airDate||"—"}),e.jsx("td",{"data-label":"Reason",children:f.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:f.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${f.series}-${f.season}-${f.episode}-${r}`))})]}),e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",A+1," of ",L," (",h.length.toLocaleString()," items · page size ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>E(Math.max(0,A-1)),disabled:A===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>E(Math.min(L-1,A+1)),disabled:A>=L-1||d,children:"Next"})]})]})]}):e.jsx("div",{className:"hint",children:"No series found."})]})}const Be=50,ke=50,os=500;function Ss({loading:d,rows:c,total:u,page:v,totalPages:C,onPageChange:L,onRefresh:E,lastUpdated:w,onSort:A,summary:h,instanceCount:o}){const f=a.useMemo(()=>[...o>1?[{accessorKey:"__instance",header:"Instance",size:150}]:[],{accessorKey:"title",header:"Album",cell:x=>x.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:x=>{const m=x.getValue();return m?new Date(m).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:x=>x.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:x=>x.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:x=>{const m=x.getValue();return m?e.jsx("span",{className:"table-badge table-badge-reason",children:m}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[o]),r=Fe({data:c,columns:f,getCoreRowModel:Ee()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated albums across all instances"," ",w?`(updated ${w})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",h.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",h.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",h.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",h.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:E,disabled:d,children:[e.jsx(_e,{src:Ke}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Lidarr library…"]}):u?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:r.getHeaderGroups().map(x=>e.jsx("tr",{children:x.headers.map(m=>e.jsx("th",{className:m.column.getCanSort()?"sortable":"",onClick:()=>{const n=m.id;A(n)},children:m.isPlaceholder?null:xe(m.column.columnDef.header,m.getContext())},m.id))},x.id))}),e.jsx("tbody",{children:r.getRowModel().rows.map(x=>{const m=x.original,n=`${m.__instance}-${m.title}-${m.artistName}`;return e.jsx("tr",{children:x.getVisibleCells().map(b=>e.jsx("td",{"data-label":String(b.column.columnDef.header),children:xe(b.column.columnDef.cell,b.getContext())},b.id))},n)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),u>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",v+1," of ",C," (",u.toLocaleString()," items · page size"," ",ke,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,v-1)),disabled:v===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(C-1,v+1)),disabled:v>=C-1||d,children:"Next"})]})]})]})}function ys({loading:d,data:c,page:u,totalPages:v,pageSize:C,allAlbums:L,onlyMissing:E,reasonFilter:w,onPageChange:A,onRestart:h,lastUpdated:o}){const f=a.useMemo(()=>{let n=L;return E&&(n=n.filter(b=>!b.hasFile)),n},[L,E]),r=a.useMemo(()=>w==="all"?f:w==="none"?f.filter(n=>!n.reason):f.filter(n=>n.reason===w),[f,w]),x=a.useMemo(()=>[{accessorKey:"title",header:"Album",cell:n=>n.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:n=>{const b=n.getValue();return b?new Date(b).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const b=n.getValue();return b?e.jsx("span",{className:"table-badge table-badge-reason",children:b}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),m=Fe({data:r.slice(u*C,u*C+C),columns:x,getCoreRowModel:Ee(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[c?.counts?`Available: ${c.counts.available??0} • Monitored: ${c.counts.monitored??0}`:"",o?` (updated ${o})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:h,disabled:d,children:[e.jsx(_e,{src:Ke}),"Restart"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):L.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:m.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(b=>e.jsx("th",{children:b.isPlaceholder?null:xe(b.column.columnDef.header,b.getContext())},b.id))},n.id))}),e.jsx("tbody",{children:m.getRowModel().rows.map(n=>{const b=n.original,_=`${b.title}-${b.artistName}`;return e.jsx("tr",{children:n.getVisibleCells().map(z=>e.jsx("td",{"data-label":String(z.column.columnDef.header),children:xe(z.column.columnDef.cell,z.getContext())},z.id))},_)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),r.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",u+1," of ",v," (",r.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>A(Math.max(0,u-1)),disabled:u===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>A(Math.min(v-1,u+1)),disabled:u>=v-1||d,children:"Next"})]})]})]})}function Rs({active:d}){const{push:c}=Xe(),{value:u,setValue:v,register:C,clearHandler:L}=qe(),{liveArr:E}=es(),[w,A]=a.useState([]),[h,o]=a.useState("aggregate"),[f,r]=a.useState(null),[x,m]=a.useState(0),[n,b]=a.useState(""),[_,z]=a.useState(!1),[pe,ve]=a.useState(null),[B,H]=a.useState({}),[W,ye]=a.useState(Be),[j,$]=a.useState(1),F=a.useRef(""),P=a.useRef({}),T=a.useRef(u),Y=a.useRef(!1),[Q,U]=a.useState([]),[ce,Re]=a.useState(!1),[ae,te]=a.useState(0),[ne,X]=a.useState(""),[Ae,Me]=a.useState(null),[de,le]=a.useState({key:"__instance",direction:"asc"}),[ie,ge]=a.useState(!1),[ue,he]=a.useState("all"),[G,Ne]=a.useState({available:0,monitored:0,missing:0,total:0}),q=a.useCallback(async()=>{try{const l=await ss();l.ready===!1&&!Y.current?(Y.current=!0,c("Lidarr backend is still initialising. Check the logs if this persists.","info")):l.ready&&(Y.current=!0);const t=(l.arr||[]).filter(s=>s.type==="lidarr");if(A(t),!t.length){o("aggregate"),r(null),U([]),Ne({available:0,monitored:0,missing:0,total:0});return}h===""?o(t.length===1?t[0].category:"aggregate"):h!=="aggregate"&&!t.some(s=>s.category===h)&&o(t[0].category)}catch(l){c(l instanceof Error?l.message:"Unable to load Lidarr instances","error")}},[c,h]),Ce=a.useCallback(async(l,t,s,i,g)=>{if(i.length)try{const p=[];for(const N of i){const S=await We(l,N,s,t),y=S.page??N;if(p.push({page:y,albums:S.albums??[]}),F.current!==g)return}if(F.current!==g)return;H(N=>{const S={...N};let y=!1;for(const{page:R,albums:M}of p){const D=N[R]??[];JSON.stringify(D)!==JSON.stringify(M)&&(S[R]=M,y=!0)}return P.current=S,y?S:N})}catch(p){c(p instanceof Error?p.message:`Failed to load additional pages for ${l}`,"error")}},[c]),re=a.useCallback(async(l,t,s,i={})=>{const g=i.preloadAll!==!1;(i.showLoading??!0)&&z(!0);try{const N=`${l}::${s}`,S=F.current!==N;S&&(F.current=N,H(()=>(P.current={},{})));const y=await We(l,t,Be,s);r(y);const R=y.page??t;m(R),b(s);const M=y.page_size??Be,D=y.total??(y.albums??[]).length,I=Math.max(1,Math.ceil((D||0)/M));ye(M),$(I);const O=y.albums??[],V=S?{}:P.current,be=P.current[R]??[],je=JSON.stringify(be)!==JSON.stringify(O);if((S||je)&&(H(oe=>{const ee={...S?{}:oe,[R]:O};return P.current=ee,ee}),ve(new Date().toLocaleTimeString())),g){const oe=[];for(let K=0;K<I;K+=1)K!==R&&(V[K]||oe.push(K));Ce(l,s,M,oe,N)}}catch(N){c(N instanceof Error?N.message:`Failed to load ${l} albums`,"error")}finally{z(!1)}},[c,Ce]),J=a.useCallback(async()=>{if(!w.length){U([]),Ne({available:0,monitored:0,missing:0,total:0});return}Re(!0);try{const l=[];let t=0,s=0;for(const g of w){let p=0,N=!1;const S=g.name||g.category;for(;p<100;){const y=await We(g.category,p,os,"");if(!N){const M=y.counts;M&&(t+=M.available??0,s+=M.monitored??0),N=!0}const R=y.albums??[];if(R.forEach(M=>{l.push({...M,__instance:S})}),!R.length||R.length<os)break;p+=1}}U(g=>{const p=JSON.stringify(g),N=JSON.stringify(l);return p===N?g:l});const i={available:t,monitored:s,missing:l.length-t,total:l.length};Ne(g=>g.available===i.available&&g.monitored===i.monitored&&g.missing===i.missing&&g.total===i.total?g:i),ne!==u&&(te(0),X(u)),Me(new Date().toLocaleTimeString())}catch(l){U([]),Ne({available:0,monitored:0,missing:0,total:0}),c(l instanceof Error?l.message:"Failed to load aggregated Lidarr data","error")}finally{Re(!1)}},[w,u,c]);a.useEffect(()=>{d&&q()},[d,q]),a.useEffect(()=>{if(!d||!h||h==="aggregate")return;P.current={},H({}),$(1),m(0);const l=T.current;re(h,0,l,{preloadAll:!0,showLoading:!0})},[d,h,re]),a.useEffect(()=>{d&&h==="aggregate"&&J()},[d,h,J]),$e(()=>{h==="aggregate"&&E&&J()},h==="aggregate"&&E?1e4:null),a.useEffect(()=>{if(!d)return;const l=t=>{h==="aggregate"?(X(t),te(0)):h&&(m(0),re(h,0,t,{preloadAll:!0,showLoading:!0}))};return C(l),()=>{L(l)}},[d,h,C,L,re]),$e(()=>{if(h&&h!=="aggregate"){if(T.current?.trim?.()||"")return;re(h,x,n,{preloadAll:!1,showLoading:!1})}},d&&h&&h!=="aggregate"&&E?1e3:null),a.useEffect(()=>{T.current=u},[u]),a.useEffect(()=>{h==="aggregate"&&X(u)},[h,u]);const me=a.useMemo(()=>{let l=Q;if(ne){const t=ne.toLowerCase();l=l.filter(s=>{const i=(s.title??"").toString().toLowerCase(),g=(s.artistName??"").toString().toLowerCase(),p=(s.__instance??"").toLowerCase();return i.includes(t)||g.includes(t)||p.includes(t)})}return ie&&(l=l.filter(t=>!t.hasFile)),ue!=="all"&&(ue==="none"?l=l.filter(t=>!t.reason):l=l.filter(t=>t.reason===ue)),l},[Q,ne,ie,ue]),Z=a.useMemo(()=>{const l=[...me],t=(s,i)=>{switch(i){case"__instance":return(s.__instance||"").toLowerCase();case"title":return(s.title||"").toLowerCase();case"artistName":return(s.artistName||"").toLowerCase();case"releaseDate":return s.releaseDate??"";case"monitored":return s.monitored?1:0;case"hasFile":return s.hasFile?1:0;default:return""}};return l.sort((s,i)=>{const g=t(s,de.key),p=t(i,de.key);let N=0;return typeof g=="number"&&typeof p=="number"?N=g-p:typeof g=="string"&&typeof p=="string"?N=g.localeCompare(p):N=String(g).localeCompare(String(p)),de.direction==="asc"?N:-N}),l},[me,de]),fe=Math.max(1,Math.ceil(Z.length/ke)),ze=Z.slice(ae*ke,ae*ke+ke),Se=a.useMemo(()=>{const l=Object.keys(B).map(Number).sort((s,i)=>s-i),t=[];return l.forEach(s=>{B[s]&&t.push(...B[s])}),t},[B]),Pe=a.useCallback(async()=>{if(!(!h||h==="aggregate"))try{await as(h),c(`Restarted ${h}`,"success")}catch(l){c(l instanceof Error?l.message:`Failed to restart ${h}`,"error")}},[h,c]),De=a.useCallback(l=>{const t=l.target.value||"aggregate";o(t),t!=="aggregate"&&v("")},[o,v]),we=h==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Lidarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[w.length>1&&e.jsx("button",{className:`btn ${we?"active":""}`,onClick:()=>o("aggregate"),children:"All Lidarr"}),w.map(l=>e.jsx("button",{className:`btn ghost ${h===l.category?"active":""}`,onClick:()=>{o(l.category),v("")},children:l.name||l.category},l.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:h||"aggregate",onChange:De,disabled:!w.length,children:[w.length>1&&e.jsx("option",{value:"aggregate",children:"All Lidarr"}),w.map(l=>e.jsx("option",{value:l.category,children:l.name||l.category},l.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter albums",value:u,onChange:l=>v(l.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:l=>{const t=l.target.value;ge(t==="missing")},value:ie?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Albums"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:l=>he(l.target.value),value:ue,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),we?e.jsx(Ss,{loading:ce,rows:ze,total:Z.length,page:ae,totalPages:fe,onPageChange:te,onRefresh:()=>void J(),lastUpdated:Ae,onSort:l=>le(t=>t.key===l?{key:l,direction:t.direction==="asc"?"desc":"asc"}:{key:l,direction:"asc"}),summary:G,instanceCount:w.length}):e.jsx(ys,{loading:_,data:f,page:x,totalPages:j,pageSize:W,allAlbums:Se,onlyMissing:ie,reasonFilter:ue,onPageChange:l=>{m(l),re(h,l,n,{preloadAll:!0})},onRestart:()=>void Pe(),lastUpdated:pe})]})]})})]})}function Ls({type:d,active:c}){return d==="radarr"?e.jsx(bs,{active:c}):d==="lidarr"?e.jsx(Rs,{active:c}):e.jsx(ps,{active:c})}export{Ls as ArrView};
//# sourceMappingURL=ArrView.js.map
