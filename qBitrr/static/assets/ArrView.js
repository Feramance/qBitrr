import{u as Xe,h as qe,i as es,k as ss,l as Ye,m as as,j as e,I as Ke,R as ze,n as Ge,o as We}from"./app.js";import{r as a,u as Ee,f as pe,g as ke,a as ts,b as hs,c as ms}from"./table.js";import{u as $e}from"./useInterval.js";import"./vendor.js";const Qe=50,Ie=50,ls=500;function fs({loading:c,rows:d,total:h,page:N,totalPages:C,onPageChange:L,onRefresh:k,lastUpdated:M,sort:R,onSort:u,summary:r,instanceCount:f}){const o=a.useMemo(()=>[...f>1?[{accessorKey:"__instance",header:"Instance",size:150}]:[],{accessorKey:"title",header:"Title",cell:m=>m.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:m=>m.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:m=>m.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:m=>{const n=m.getValue();return n?e.jsx("span",{className:"table-badge table-badge-reason",children:n}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[f]),x=Ee({data:d,columns:o,getCoreRowModel:ke()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated movies across all instances"," ",M?`(updated ${M})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",r.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",r.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",r.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",r.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:k,disabled:c,children:[e.jsx(Ke,{src:ze}),"Refresh"]})]}),c?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Radarr library…"]}):h?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:x.getHeaderGroups().map(m=>e.jsx("tr",{children:m.headers.map(n=>e.jsx("th",{className:n.column.getCanSort()?"sortable":"",onClick:()=>{const b=n.id;u(b)},children:n.isPlaceholder?null:pe(n.column.columnDef.header,n.getContext())},n.id))},m.id))}),e.jsx("tbody",{children:x.getRowModel().rows.map(m=>{const n=m.original,b=`${n.__instance}-${n.title}-${n.year}`;return e.jsx("tr",{children:m.getVisibleCells().map(K=>e.jsx("td",{"data-label":String(K.column.columnDef.header),children:pe(K.column.columnDef.cell,K.getContext())},K.id))},b)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),h>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",N+1," of ",C," (",h.toLocaleString()," items · page size"," ",Ie,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,N-1)),disabled:N===0||c,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(C-1,N+1)),disabled:N>=C-1||c,children:"Next"})]})]})]})}function xs({loading:c,data:d,page:h,totalPages:N,pageSize:C,allMovies:L,onlyMissing:k,reasonFilter:M,onPageChange:R,onRestart:u,lastUpdated:r}){const f=a.useMemo(()=>{let n=L;return k&&(n=n.filter(b=>!b.hasFile)),n},[L,k]),o=a.useMemo(()=>M==="all"?f:M==="none"?f.filter(n=>!n.reason):f.filter(n=>n.reason===M),[f,M]),x=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:n=>n.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const b=n.getValue();return b?e.jsx("span",{className:"table-badge table-badge-reason",children:b}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),m=Ee({data:o.slice(h*C,h*C+C),columns:x,getCoreRowModel:ke(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[d?.counts?`Available: ${d.counts.available??0} • Monitored: ${d.counts.monitored??0}`:"",r?` (updated ${r})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:u,disabled:c,children:[e.jsx(Ke,{src:ze}),"Restart"]})]}),c?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):L.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:m.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(b=>e.jsx("th",{children:b.isPlaceholder?null:pe(b.column.columnDef.header,b.getContext())},b.id))},n.id))}),e.jsx("tbody",{children:m.getRowModel().rows.map(n=>{const b=n.original,K=`${b.title}-${b.year}`;return e.jsx("tr",{children:n.getVisibleCells().map(z=>e.jsx("td",{"data-label":String(z.column.columnDef.header),children:pe(z.column.columnDef.cell,z.getContext())},z.id))},K)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),o.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",h+1," of ",N," (",o.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>R(Math.max(0,h-1)),disabled:h===0||c,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>R(Math.min(N-1,h+1)),disabled:h>=N-1||c,children:"Next"})]})]})]})}function bs({active:c}){const{push:d}=Xe(),{value:h,setValue:N,register:C,clearHandler:L}=qe(),{liveArr:k,setLiveArr:M}=es(),[R,u]=a.useState([]),[r,f]=a.useState(""),[o,x]=a.useState(null),[m,n]=a.useState(0),[b,K]=a.useState(""),[z,ve]=a.useState(!1),[Ne,q]=a.useState(null),[U,Z]=a.useState({}),[Re,j]=a.useState(Qe),[$,E]=a.useState(1),P=a.useRef(""),T=a.useRef({}),Q=a.useRef(h),B=a.useRef(!1),[J,de]=a.useState([]),[Ae,ne]=a.useState(!1),[ie,le]=a.useState(0),[ee,Ce]=a.useState(""),[Me,ge]=a.useState(null),[re,oe]=a.useState({key:"__instance",direction:"asc"}),[ue,he]=a.useState(!1),[me,Y]=a.useState("all"),[Se,se]=a.useState({available:0,monitored:0,missing:0,total:0}),we=a.useCallback(async()=>{try{const t=await ss();t.ready===!1&&!B.current?(B.current=!0,d("Radarr backend is still initialising. Check the logs if this persists.","info")):t.ready&&(B.current=!0);const s=(t.arr||[]).filter(l=>l.type==="radarr");if(u(s),!s.length){f("aggregate"),x(null),de([]),se({available:0,monitored:0,missing:0,total:0});return}r===""?f(s.length===1?s[0].category:"aggregate"):r!=="aggregate"&&!s.some(l=>l.category===r)&&f(s[0].category)}catch(t){d(t instanceof Error?t.message:"Unable to load Radarr instances","error")}},[d,r]),ce=a.useCallback(async(t,s,l,g,v)=>{if(g.length)try{const S=[];for(const y of g){const w=await Ye(t,y,l,s),p=w.page??y;if(S.push({page:p,movies:w.movies??[]}),P.current!==v)return}if(P.current!==v)return;Z(y=>{const w={...y};let p=!1;for(const{page:A,movies:D}of S){const F=y[A]??[];JSON.stringify(F)!==JSON.stringify(D)&&(w[A]=D,p=!0)}return T.current=w,p?w:y})}catch(S){d(S instanceof Error?S.message:`Failed to load additional pages for ${t}`,"error")}},[d]),G=a.useCallback(async(t,s,l,g={})=>{const v=g.preloadAll!==!1;(g.showLoading??!0)&&ve(!0);try{const y=`${t}::${l}`,w=P.current!==y;w&&(P.current=y,Z(()=>(T.current={},{})));const p=await Ye(t,s,Qe,l);x(p);const A=p.page??s;n(A),K(l);const D=p.page_size??Qe,F=p.total??(p.movies??[]).length,_=Math.max(1,Math.ceil((F||0)/D));j(D),E(_);const W=p.movies??[],be=w?{}:T.current,V=T.current[A]??[],ae=JSON.stringify(V)!==JSON.stringify(W);if((w||ae)&&(Z(O=>{const je={...w?{}:O,[A]:W};return T.current=je,je}),q(new Date().toLocaleTimeString())),v){const O=[];for(let H=0;H<_;H+=1)H!==A&&(be[H]||O.push(H));ce(t,l,D,O,y)}}catch(y){d(y instanceof Error?y.message:`Failed to load ${t} movies`,"error")}finally{ve(!1)}},[d,ce]),fe=a.useCallback(async()=>{if(!R.length){de([]),se({available:0,monitored:0,missing:0,total:0});return}ne(!0);try{const t=[];let s=0,l=0;for(const v of R){let S=0,y=!1;const w=v.name||v.category;for(;S<100;){const p=await Ye(v.category,S,ls,"");if(!y){const D=p.counts;D&&(s+=D.available??0,l+=D.monitored??0),y=!0}const A=p.movies??[];if(A.forEach(D=>{t.push({...D,__instance:w})}),!A.length||A.length<ls)break;S+=1}}de(v=>{const S=JSON.stringify(v),y=JSON.stringify(t);return S===y?v:t});const g={available:s,monitored:l,missing:t.length-s,total:t.length};se(v=>v.available===g.available&&v.monitored===g.monitored&&v.missing===g.missing&&v.total===g.total?v:g),ee!==h&&(le(0),Ce(h)),ge(new Date().toLocaleTimeString())}catch(t){de([]),se({available:0,monitored:0,missing:0,total:0}),d(t instanceof Error?t.message:"Failed to load aggregated Radarr data","error")}finally{ne(!1)}},[R,h,d]);a.useEffect(()=>{c&&we()},[c,we]),a.useEffect(()=>{if(!c||!r||r==="aggregate")return;T.current={},Z({}),E(1),n(0);const t=Q.current;G(r,0,t,{preloadAll:!0,showLoading:!0})},[c,r,G]),a.useEffect(()=>{c&&r==="aggregate"&&fe()},[c,r,fe]),$e(()=>{r==="aggregate"&&k&&fe()},r==="aggregate"&&k?1e4:null),a.useEffect(()=>{if(!c)return;const t=s=>{r==="aggregate"?(Ce(s),le(0)):r&&(n(0),G(r,0,s,{preloadAll:!0,showLoading:!0}))};return C(t),()=>{L(t)}},[c,r,C,L,G]),$e(()=>{if(r&&r!=="aggregate"){if(Q.current?.trim?.()||"")return;G(r,m,b,{preloadAll:!1,showLoading:!1})}},c&&r&&r!=="aggregate"&&k?1e3:null),a.useEffect(()=>{Q.current=h},[h]),a.useEffect(()=>{r==="aggregate"&&Ce(h)},[r,h]);const X=a.useMemo(()=>{let t=J;if(ee){const s=ee.toLowerCase();t=t.filter(l=>{const g=(l.title??"").toString().toLowerCase(),v=(l.__instance??"").toLowerCase();return g.includes(s)||v.includes(s)})}return ue&&(t=t.filter(s=>!s.hasFile)),me!=="all"&&(me==="none"?t=t.filter(s=>!s.reason):t=t.filter(s=>s.reason===me)),t},[J,ee,ue,me]),xe=a.useMemo(()=>{const t=[...X],s=(l,g)=>{switch(g){case"__instance":return(l.__instance||"").toLowerCase();case"title":return(l.title||"").toLowerCase();case"year":return l.year??0;case"monitored":return l.monitored?1:0;case"hasFile":return l.hasFile?1:0;default:return""}};return t.sort((l,g)=>{const v=s(l,re.key),S=s(g,re.key);let y=0;return typeof v=="number"&&typeof S=="number"?y=v-S:typeof v=="string"&&typeof S=="string"?y=v.localeCompare(S):y=String(v).localeCompare(String(S)),re.direction==="asc"?y:-y}),t},[X,re]),Oe=Math.max(1,Math.ceil(xe.length/Ie)),ye=xe.slice(ie*Ie,ie*Ie+Ie),Pe=a.useMemo(()=>{const t=Object.keys(U).map(Number).sort((l,g)=>l-g),s=[];return t.forEach(l=>{U[l]&&s.push(...U[l])}),s},[U]),De=a.useCallback(async()=>{if(!(!r||r==="aggregate"))try{await as(r),d(`Restarted ${r}`,"success")}catch(t){d(t instanceof Error?t.message:`Failed to restart ${r}`,"error")}},[r,d]),Le=a.useCallback(t=>{const s=t.target.value||"aggregate";f(s),s!=="aggregate"&&N("")},[f,N]),i=r==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Radarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[R.length>1&&e.jsx("button",{className:`btn ${i?"active":""}`,onClick:()=>f("aggregate"),children:"All Radarr"}),R.map(t=>e.jsx("button",{className:`btn ghost ${r===t.category?"active":""}`,onClick:()=>{f(t.category),N("")},children:t.name||t.category},t.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:r||"aggregate",onChange:Le,disabled:!R.length,children:[R.length>1&&e.jsx("option",{value:"aggregate",children:"All Radarr"}),R.map(t=>e.jsx("option",{value:t.category,children:t.name||t.category},t.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter movies",value:h,onChange:t=>N(t.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:t=>{const s=t.target.value;he(s==="missing")},value:ue?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Movies"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:t=>Y(t.target.value),value:me,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),i?e.jsx(fs,{loading:Ae,rows:ye,total:xe.length,page:ie,totalPages:Oe,onPageChange:le,onRefresh:()=>void fe(),lastUpdated:Me,sort:re,onSort:t=>oe(s=>s.key===t?{key:t,direction:s.direction==="asc"?"desc":"asc"}:{key:t,direction:"asc"}),summary:Se,instanceCount:R.length}):e.jsx(xs,{loading:z,data:o,page:m,totalPages:$,pageSize:Re,allMovies:Pe,onlyMissing:ue,reasonFilter:me,onPageChange:t=>{n(t),G(r,t,b,{preloadAll:!0})},onRestart:()=>void De(),lastUpdated:Ne})]})]})})]})}const Ze=25,Ve=50,rs=200;function js(c,d){if(!d)return c;const h=[];for(const N of c){const C=N.seasons??{},L={};for(const[k,M]of Object.entries(C)){const R=(M.episodes??[]).filter(u=>!u.hasFile);R.length&&(L[k]={...M,episodes:R})}Object.keys(L).length!==0&&h.push({...N,seasons:L})}return h}function He(c,d){return JSON.stringify(js(c,d))}function ps({active:c}){const{push:d}=Xe(),{value:h,setValue:N,register:C,clearHandler:L}=qe(),{liveArr:k,setLiveArr:M,groupSonarr:R,setGroupSonarr:u}=es(),[r,f]=a.useState([]),[o,x]=a.useState("aggregate"),[m,n]=a.useState(null),[b,K]=a.useState(0),[z,ve]=a.useState(""),[Ne,q]=a.useState(!1),[U,Z]=a.useState(null),[Re,j]=a.useState({}),$=a.useRef({}),E=a.useRef(null),P=a.useRef(""),[T,Q]=a.useState(Ze),[B,J]=a.useState(1),[de,Ae]=a.useState(0),ne=a.useRef(h),ie=a.useRef(!1),[le,ee]=a.useState([]),[Ce,Me]=a.useState(!1),[ge,re]=a.useState(0),[oe,ue]=a.useState(""),[he,me]=a.useState(null),[Y,Se]=a.useState(!1),[se,we]=a.useState("all"),[ce,G]=a.useState({available:0,monitored:0,missing:0,total:0}),fe=a.useCallback(async()=>{try{const s=await ss();s.ready===!1&&!ie.current?(ie.current=!0,d("Sonarr backend is still initialising. Check the logs if this persists.","info")):s.ready&&(ie.current=!0);const l=(s.arr||[]).filter(g=>g.type==="sonarr");if(f(l),!l.length){x("aggregate"),n(null),ee([]),G({available:0,monitored:0,missing:0,total:0});return}o===""?x(l.length===1?l[0].category:"aggregate"):o!=="aggregate"&&!l.some(g=>g.category===o)&&x(l[0].category)}catch(s){d(s instanceof Error?s.message:"Unable to load Sonarr instances","error")}},[d,o]),X=a.useCallback(async(s,l,g,v={})=>{const{preloadAll:S=!0,showLoading:y=!0,missingOnly:w}=v,p=w??Y;y&&q(!0);try{const A=`${s}::${g}::${p?"missing":"all"}`,D=P.current!==A;D&&(P.current=A,j(()=>($.current={},{})),Ae(0),J(1));const F=await Ge(s,l,Ze,g,{missingOnly:p});console.log(`[Sonarr Instance] Response for ${s} page ${l}:`,{total:F.total,page:F.page,page_size:F.page_size,series_count:F.series?.length??0,counts:F.counts,missingOnly:p,firstSeries:F.series?.[0]?{title:F.series[0].series?.title,seasonsCount:Object.keys(F.series[0].seasons??{}).length,firstSeasonEpisodes:Object.values(F.series[0].seasons??{})[0]?.episodes?.length??0}:null});const _=F.page??l,W=F.page_size??Ze,be=F.total??(F.series??[]).length,V=Math.max(1,Math.ceil((be||0)/W)),ae=F.series??[],O=D?{}:$.current,H={...O,[_]:ae},je=He(O[_]??[],p),cs=He(ae,p),Ue=D||je!==cs;if($.current=H,Ue&&j(H),n(I=>{const te=I?.counts??null,Fe=F.counts??null;return!I||I.total!==F.total||I.page!==F.page||I.page_size!==F.page_size||(te?.available??null)!==(Fe?.available??null)||(te?.monitored??null)!==(Fe?.monitored??null)||(te?.missing??null)!==(Fe?.missing??null)||Ue?(E.current=F,F):I}),K(I=>I===_?I:_),ve(I=>I===g?I:g),Q(I=>I===W?I:W),J(I=>I===V?I:V),Ae(I=>I===be?I:be),Ue&&Z(new Date().toLocaleTimeString()),S){const I=[];for(let te=0;te<V;te+=1)te!==_&&(H[te]||I.push(te));for(const te of I)try{const Fe=await Ge(s,te,W,g,{missingOnly:p});if(P.current!==A)break;const Te=Fe.page??te,Je=Fe.series??[],ns=$.current,ds=He(ns[Te]??[],p),gs=He(Je,p);if(ds===gs){$.current={...ns,[Te]:Je};continue}j(us=>{const is={...us,[Te]:Je};return $.current=is,is})}catch{break}}}catch(A){d(A instanceof Error?A.message:`Failed to load ${s} series`,"error")}finally{y&&q(!1)}},[d,Y]),xe=a.useCallback(async()=>{if(!r.length){ee([]),G({available:0,monitored:0,missing:0,total:0});return}console.log(`[Sonarr Aggregate] Starting aggregation for ${r.length} instances`),Me(!0);try{const s=[];let l=0,g=0,v=0;for(const p of r){let A=0,D=!1;const F=p.name||p.category;for(console.log(`[Sonarr Aggregate] Processing instance: ${F}`);A<200;){const _=await Ge(p.category,A,rs,"",{missingOnly:Y});if(console.log(`[Sonarr Aggregate] Response for ${F} page ${A}:`,{total:_.total,page:_.page,page_size:_.page_size,series_count:_.series?.length??0,counts:_.counts,missingOnly:Y,firstSeries:_.series?.[0]?{title:_.series[0].series?.title,seasonsCount:Object.keys(_.series[0].seasons??{}).length,firstSeasonEpisodes:Object.values(_.series[0].seasons??{})[0]?.episodes?.length??0}:null}),!D){const V=_.counts;V&&(l+=V.available??0,g+=V.monitored??0,v+=V.missing??0),D=!0}const W=_.series??[];let be=0;if(W.forEach(V=>{const ae=Object.keys(V.seasons??{}).length;let O=0;Object.values(V.seasons??{}).forEach(H=>{O+=(H.episodes??[]).length}),be+=O}),console.log(`[Sonarr Aggregate] Instance: ${F}, Page: ${A}, Series count: ${W.length}, Total episodes so far: ${s.length}, Episodes in this response: ${be}`),W.forEach(V=>{const ae=V.series?.title||"";Object.entries(V.seasons??{}).forEach(([O,H])=>{(H.episodes??[]).forEach(je=>{s.push({__instance:F,series:ae,season:O,episode:je.episodeNumber??"",title:je.title??"",monitored:!!je.monitored,hasFile:!!je.hasFile,airDate:je.airDateUtc??""})})})}),!W.length||W.length<rs){console.log(`[Sonarr Aggregate] Breaking pagination for ${F} - series.length=${W.length}`);break}A+=1}}const S=new Set(s.map(p=>`${p.__instance}::${p.series}`)).size,y=r.reduce((p,A)=>p,0);console.log("[Sonarr Aggregate] Aggregation complete:",{totalEpisodes:s.length,uniqueSeries:S,instances:r.length,note:s.length===0?"No episodes found - backend may still be initializing":""}),ee(p=>{const A=JSON.stringify(p),D=JSON.stringify(s);return A===D?(console.log("[Sonarr Aggregate] Data unchanged, skipping update"),p):(console.log(`[Sonarr Aggregate] Data changed, updating from ${p.length} to ${s.length} episodes`),s)});const w={available:l,monitored:g,missing:v,total:s.length};G(p=>p.available===w.available&&p.monitored===w.monitored&&p.missing===w.missing&&p.total===w.total?p:w),oe!==h&&(re(0),ue(h)),me(new Date().toLocaleTimeString())}catch(s){ee([]),G({available:0,monitored:0,missing:0,total:0}),d(s instanceof Error?s.message:"Failed to load aggregated Sonarr data","error")}finally{Me(!1)}},[r,h,d,Y]);a.useEffect(()=>{c&&fe()},[c,fe]),a.useEffect(()=>{if(!c||!o||o==="aggregate")return;K(0);const s=ne.current;X(o,0,s,{preloadAll:!0,showLoading:!0,missingOnly:Y})},[c,o,X]),a.useEffect(()=>{c&&o==="aggregate"&&xe()},[c,o,xe]),$e(()=>{o==="aggregate"&&k&&xe()},o==="aggregate"&&k?1e4:null),a.useEffect(()=>{if(!c)return;const s=l=>{o==="aggregate"?(ue(l),re(0)):o&&(K(0),X(o,0,l,{preloadAll:!0,showLoading:!0,missingOnly:Y}))};return C(s),()=>L(s)},[c,o,C,L,X,Y]),$e(()=>{if(o&&o!=="aggregate"){if(ne.current?.trim?.()||"")return;X(o,b,z,{preloadAll:!1,showLoading:!1,missingOnly:Y})}},c&&o&&o!=="aggregate"&&k?1e3:null),a.useEffect(()=>{ne.current=h},[h]),a.useEffect(()=>{o==="aggregate"&&ue(h)},[o,h]);const ye=a.useMemo(()=>{let s=le;if(oe){const l=oe.toLowerCase();s=s.filter(g=>g.series.toLowerCase().includes(l)||g.title.toLowerCase().includes(l)||g.__instance.toLowerCase().includes(l))}return se!=="all"&&(se==="none"?s=s.filter(l=>!l.reason):s=s.filter(l=>l.reason===se)),s},[le,oe,se]),Pe=Math.max(1,Math.ceil(ye.length/Ve));ye.slice(ge*Ve,ge*Ve+Ve);const De=Re[b]??[],Le=a.useCallback(async()=>{if(!(!o||o==="aggregate"))try{await as(o),d(`Restarted ${o}`,"success")}catch(s){d(s instanceof Error?s.message:`Failed to restart ${o}`,"error")}},[o,d]),i=a.useCallback(s=>{const l=s.target.value||"aggregate";x(l),l!=="aggregate"&&N("")},[x,N]),t=o==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Sonarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[r.length>1&&e.jsx("button",{className:`btn ${t?"active":""}`,onClick:()=>x("aggregate"),children:"All Sonarr"}),r.map(s=>e.jsx("button",{className:`btn ghost ${o===s.category?"active":""}`,onClick:()=>{x(s.category),N("")},children:s.name||s.category},s.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:o||"aggregate",onChange:i,disabled:!r.length,children:[r.length>1&&e.jsx("option",{value:"aggregate",children:"All Sonarr"}),r.map(s=>e.jsx("option",{value:s.category,children:s.name||s.category},s.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter series or episodes",value:h,onChange:s=>N(s.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:s=>{const g=s.target.value==="missing";Se(g),o&&o!=="aggregate"&&X(o,0,ne.current||"",{preloadAll:!0,showLoading:!0,missingOnly:g})},value:Y?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Episodes"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:s=>we(s.target.value),value:se,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),t?e.jsx(vs,{loading:Ce,rows:ye,total:ye.length,page:ge,totalPages:Pe,onPageChange:re,onRefresh:()=>void xe(),lastUpdated:he,groupSonarr:R,summary:ce,instanceCount:r.length}):e.jsx(Ns,{loading:Ne,counts:m?.counts??null,series:De,page:b,pageSize:T,totalPages:B,totalItems:de,onlyMissing:Y,onPageChange:s=>{K(s),X(o,s,z,{preloadAll:!1,showLoading:!0,missingOnly:Y})},onRestart:()=>void Le(),lastUpdated:U,groupSonarr:R})]})]})})]})}function vs({loading:c,rows:d,total:h,page:N,totalPages:C,onPageChange:L,onRefresh:k,lastUpdated:M,groupSonarr:R,summary:u,instanceCount:r}){const f=a.useMemo(()=>{const j=new Map;d.forEach(E=>{const P=E.__instance,T=E.series,Q=String(E.season);j.has(P)||j.set(P,new Map);const B=j.get(P);B.has(T)||B.set(T,new Map);const J=B.get(T);J.has(Q)||J.set(Q,[]),J.get(Q).push(E)});const $=[];return j.forEach((E,P)=>{E.forEach((T,Q)=>{$.push({instance:P,series:Q,subRows:Array.from(T.entries()).map(([B,J])=>({seasonNumber:B,isSeason:!0,subRows:J.map(de=>({...de,isEpisode:!0}))}))})})}),$},[d]),o=a.useMemo(()=>f.slice(N*50,(N+1)*50),[f,N]),x=a.useMemo(()=>d.slice(N*50,(N+1)*50),[d,N]),m=R?o:x,n=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:({row:j})=>j.original.isEpisode?j.original.title:j.original.isSeason?`Season ${j.original.seasonNumber}`:j.original.series},{accessorKey:"monitored",header:"Monitored",cell:({row:j})=>{const $=(j.original.isEpisode,j.original.monitored);return e.jsx("span",{className:"table-badge",children:$?"Yes":"No"})}},{accessorKey:"hasFile",header:"Has File",cell:({row:j})=>j.original.isEpisode?e.jsx("span",{className:"table-badge",children:j.original.hasFile?"Yes":"No"}):null},{accessorKey:"airDate",header:"Air Date",cell:({row:j})=>j.original.isEpisode?j.original.airDate||"—":null}],[]),b=a.useMemo(()=>[...r>1?[{accessorKey:"__instance",header:"Instance"}]:[],{accessorKey:"series",header:"Series"},{accessorKey:"season",header:"Season"},{accessorKey:"episode",header:"Episode"},{accessorKey:"title",header:"Title"},{accessorKey:"monitored",header:"Monitored",cell:({getValue:j})=>e.jsx("span",{className:"table-badge",children:j()?"Yes":"No"})},{accessorKey:"hasFile",header:"Has File",cell:({getValue:j})=>e.jsx("span",{className:"table-badge",children:j()?"Yes":"No"})},{accessorKey:"airDate",header:"Air Date",cell:({getValue:j})=>j()||"—"}],[r]),K=R?n:b,z=Ee({data:m,columns:K,getCoreRowModel:ke(),getExpandedRowModel:hs()}),ve=Ee({data:m,columns:K,getCoreRowModel:ke(),getSortedRowModel:ts(),getPaginationRowModel:ms(),state:{pagination:{pageIndex:N,pageSize:50}},manualPagination:!0,pageCount:C}),Ne=R?z:ve,q=50,U=Math.ceil(R?f.length/q:d.length/q),Z=Math.min(N,Math.max(0,U-1)),Re=R?`${f.length} series`:d.length.toLocaleString();return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated episodes across all instances"," ",M?`(updated ${M})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",u.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",u.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",u.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total Episodes:"})," ",u.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:k,disabled:c,children:[e.jsx(Ke,{src:ze}),"Refresh"]})]}),c?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Sonarr library…"]}):R?e.jsx("div",{className:"sonarr-hierarchical-view",children:o.map(j=>e.jsxs("details",{className:"series-details",children:[e.jsxs("summary",{className:"series-summary",children:[e.jsx("span",{className:"series-title",children:j.series}),e.jsxs("span",{className:"series-instance",children:["(",j.instance,")"]})]}),e.jsx("div",{className:"series-content",children:j.subRows.map($=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",$.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",$.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:$.subRows.map(E=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Episode",children:E.episode}),e.jsx("td",{"data-label":"Title",children:E.title}),e.jsx("td",{"data-label":"Monitored",children:e.jsx("span",{className:"table-badge",children:E.monitored?"Yes":"No"})}),e.jsx("td",{"data-label":"Has File",children:e.jsx("span",{className:"table-badge",children:E.hasFile?"Yes":"No"})}),e.jsx("td",{"data-label":"Air Date",children:E.airDate||"—"}),e.jsx("td",{"data-label":"Reason",children:E.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:E.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${E.__instance}-${E.series}-${E.season}-${E.episode}`))})]})})})]},`${j.instance}-${j.series}-${$.seasonNumber}`))})]},`${j.instance}-${j.series}`))}):!c&&u.total===0&&r>0?e.jsxs("div",{className:"hint",children:[e.jsx("p",{children:"No episodes found in the database."}),e.jsx("p",{children:"The backend may still be initializing and syncing data from your Sonarr instances. Please check the logs or wait a few moments and refresh."})]}):m.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsx("tr",{children:Ne.getFlatHeaders().map(j=>e.jsxs("th",{className:j.column.getCanSort()?"sortable":"",onClick:j.column.getToggleSortingHandler(),children:[j.isPlaceholder?null:pe(j.column.columnDef.header,j.getContext()),j.column.getCanSort()&&e.jsx("span",{className:"sort-arrow",children:{asc:"▲",desc:"▼"}[j.column.getIsSorted()]??null})]},j.id))})}),e.jsx("tbody",{children:Ne.getRowModel().rows.map(j=>{const $=j.original,E=`${$.__instance}-${$.series}-${$.season}-${$.episode}`;return e.jsx("tr",{children:j.getVisibleCells().map(P=>e.jsx("td",{"data-label":P.column.columnDef.header,children:pe(P.column.columnDef.cell,P.getContext())},P.id))},E)})})]})}):e.jsx("div",{className:"hint",children:"No series found."}),m.length>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",Z+1," of ",U," (",Re," items · page size ",q,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,Z-1)),disabled:Z===0||c,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(U-1,Z+1)),disabled:Z>=U-1||c,children:"Next"})]})]})]})}function Ns({loading:c,counts:d,series:h,page:N,pageSize:C,totalPages:L,onPageChange:k,groupSonarr:M}){const R=Math.min(N,Math.max(0,L-1)),u=a.useMemo(()=>{const f=[];for(const o of h){const x=o.series?.title||"";Object.entries(o.seasons??{}).forEach(([m,n])=>{(n.episodes??[]).forEach(b=>{f.push({__instance:"Instance",series:x,season:m,episode:b.episodeNumber??"",title:b.title??"",monitored:!!b.monitored,hasFile:!!b.hasFile,airDate:b.airDateUtc??""})})})}return f},[h]),r=a.useMemo(()=>{const f=new Map;return u.forEach(o=>{const x=o.series;f.has(x)||f.set(x,new Map);const m=f.get(x),n=String(o.season);m.has(n)||m.set(n,[]),m.get(n).push(o)}),Array.from(f.entries()).map(([o,x])=>({series:o,subRows:Array.from(x.entries()).map(([m,n])=>({seasonNumber:m,isSeason:!0,subRows:n.map(b=>({...b,isEpisode:!0}))}))}))},[u]);return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsx("div",{className:"row",style:{justifyContent:"space-between"},children:e.jsx("div",{className:"hint",children:d?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Available:"})," ",d.available.toLocaleString()," •"," ",e.jsx("strong",{children:"Monitored:"})," ",d.monitored.toLocaleString()," •"," ",e.jsx("strong",{children:"Missing:"})," ",d.missing?.toLocaleString()??0]}):"Loading series information..."})}),c?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading series…"]}):M?e.jsx("div",{className:"sonarr-hierarchical-view",children:r.map(f=>e.jsxs("details",{className:"series-details",children:[e.jsx("summary",{className:"series-summary",children:e.jsx("span",{className:"series-title",children:f.series})}),e.jsx("div",{className:"series-content",children:f.subRows.map(o=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",o.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",o.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:o.subRows.map(x=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Episode",children:x.episode}),e.jsx("td",{"data-label":"Title",children:x.title}),e.jsx("td",{"data-label":"Monitored",children:e.jsx("span",{className:"table-badge",children:x.monitored?"Yes":"No"})}),e.jsx("td",{"data-label":"Has File",children:e.jsx("span",{className:"table-badge",children:x.hasFile?"Yes":"No"})}),e.jsx("td",{"data-label":"Air Date",children:x.airDate||"—"}),e.jsx("td",{"data-label":"Reason",children:x.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:x.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${x.series}-${x.season}-${x.episode}`))})]})})})]},`${f.series}-${o.seasonNumber}`))})]},`${f.series}`))}):!c&&h.length>0&&u.length===0?e.jsxs("div",{className:"hint",children:[e.jsx("p",{children:"No episodes found for these series."}),e.jsx("p",{children:"The backend may still be syncing episode data from Sonarr. Please check the logs or wait a few moments and refresh."})]}):u.length?e.jsxs("div",{className:"table-wrapper",children:[e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Series"}),e.jsx("th",{children:"Season"}),e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:u.slice(R*C,R*C+C).map((f,o)=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Series",children:f.series}),e.jsx("td",{"data-label":"Season",children:f.season}),e.jsx("td",{"data-label":"Episode",children:f.episode}),e.jsx("td",{"data-label":"Title",children:f.title}),e.jsx("td",{"data-label":"Monitored",children:e.jsx("span",{className:"table-badge",children:f.monitored?"Yes":"No"})}),e.jsx("td",{"data-label":"Has File",children:e.jsx("span",{className:"table-badge",children:f.hasFile?"Yes":"No"})}),e.jsx("td",{"data-label":"Air Date",children:f.airDate||"—"}),e.jsx("td",{"data-label":"Reason",children:f.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:f.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${f.series}-${f.season}-${f.episode}-${o}`))})]}),e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",R+1," of ",L," (",u.length.toLocaleString()," items · page size ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>k(Math.max(0,R-1)),disabled:R===0||c,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>k(Math.min(L-1,R+1)),disabled:R>=L-1||c,children:"Next"})]})]})]}):e.jsx("div",{className:"hint",children:"No series found."})]})}const Be=50,_e=50,os=500;function Ss({loading:c,rows:d,total:h,page:N,totalPages:C,onPageChange:L,onRefresh:k,lastUpdated:M,onSort:R,summary:u,instanceCount:r}){const f=a.useMemo(()=>[...r>1?[{accessorKey:"__instance",header:"Instance",size:150}]:[],{accessorKey:"title",header:"Album",cell:x=>x.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:x=>{const m=x.getValue();return m?new Date(m).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:x=>x.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:x=>x.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:x=>{const m=x.getValue();return m?e.jsx("span",{className:"table-badge table-badge-reason",children:m}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[r]),o=Ee({data:d,columns:f,getCoreRowModel:ke()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated albums across all instances"," ",M?`(updated ${M})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",u.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",u.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",u.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",u.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:k,disabled:c,children:[e.jsx(Ke,{src:ze}),"Refresh"]})]}),c?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Lidarr library…"]}):h?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:o.getHeaderGroups().map(x=>e.jsx("tr",{children:x.headers.map(m=>e.jsx("th",{className:m.column.getCanSort()?"sortable":"",onClick:()=>{const n=m.id;R(n)},children:m.isPlaceholder?null:pe(m.column.columnDef.header,m.getContext())},m.id))},x.id))}),e.jsx("tbody",{children:o.getRowModel().rows.map(x=>{const m=x.original,n=`${m.__instance}-${m.title}-${m.artistName}`;return e.jsx("tr",{children:x.getVisibleCells().map(b=>e.jsx("td",{"data-label":String(b.column.columnDef.header),children:pe(b.column.columnDef.cell,b.getContext())},b.id))},n)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),h>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",N+1," of ",C," (",h.toLocaleString()," items · page size"," ",_e,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,N-1)),disabled:N===0||c,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(C-1,N+1)),disabled:N>=C-1||c,children:"Next"})]})]})]})}function ys({loading:c,data:d,page:h,totalPages:N,pageSize:C,allAlbums:L,onlyMissing:k,reasonFilter:M,onPageChange:R,onRestart:u,lastUpdated:r}){const f=a.useMemo(()=>{let n=L;return k&&(n=n.filter(b=>!b.hasFile)),n},[L,k]),o=a.useMemo(()=>M==="all"?f:M==="none"?f.filter(n=>!n.reason):f.filter(n=>n.reason===M),[f,M]),x=a.useMemo(()=>[{accessorKey:"title",header:"Album",cell:n=>n.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:n=>{const b=n.getValue();return b?new Date(b).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const b=n.getValue();return b?e.jsx("span",{className:"table-badge table-badge-reason",children:b}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),m=Ee({data:o.slice(h*C,h*C+C),columns:x,getCoreRowModel:ke(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[d?.counts?`Available: ${d.counts.available??0} • Monitored: ${d.counts.monitored??0}`:"",r?` (updated ${r})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:u,disabled:c,children:[e.jsx(Ke,{src:ze}),"Restart"]})]}),c?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):L.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:m.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(b=>e.jsx("th",{children:b.isPlaceholder?null:pe(b.column.columnDef.header,b.getContext())},b.id))},n.id))}),e.jsx("tbody",{children:m.getRowModel().rows.map(n=>{const b=n.original,K=`${b.title}-${b.artistName}`;return e.jsx("tr",{children:n.getVisibleCells().map(z=>e.jsx("td",{"data-label":String(z.column.columnDef.header),children:pe(z.column.columnDef.cell,z.getContext())},z.id))},K)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),o.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",h+1," of ",N," (",o.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>R(Math.max(0,h-1)),disabled:h===0||c,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>R(Math.min(N-1,h+1)),disabled:h>=N-1||c,children:"Next"})]})]})]})}function Rs({active:c}){const{push:d}=Xe(),{value:h,setValue:N,register:C,clearHandler:L}=qe(),{liveArr:k}=es(),[M,R]=a.useState([]),[u,r]=a.useState("aggregate"),[f,o]=a.useState(null),[x,m]=a.useState(0),[n,b]=a.useState(""),[K,z]=a.useState(!1),[ve,Ne]=a.useState(null),[q,U]=a.useState({}),[Z,Re]=a.useState(Be),[j,$]=a.useState(1),E=a.useRef(""),P=a.useRef({}),T=a.useRef(h),Q=a.useRef(!1),[B,J]=a.useState([]),[de,Ae]=a.useState(!1),[ne,ie]=a.useState(0),[le,ee]=a.useState(""),[Ce,Me]=a.useState(null),[ge,re]=a.useState({key:"__instance",direction:"asc"}),[oe,ue]=a.useState(!1),[he,me]=a.useState("all"),[Y,Se]=a.useState({available:0,monitored:0,missing:0,total:0}),se=a.useCallback(async()=>{try{const i=await ss();i.ready===!1&&!Q.current?(Q.current=!0,d("Lidarr backend is still initialising. Check the logs if this persists.","info")):i.ready&&(Q.current=!0);const t=(i.arr||[]).filter(s=>s.type==="lidarr");if(R(t),!t.length){r("aggregate"),o(null),J([]),Se({available:0,monitored:0,missing:0,total:0});return}u===""?r(t.length===1?t[0].category:"aggregate"):u!=="aggregate"&&!t.some(s=>s.category===u)&&r(t[0].category)}catch(i){d(i instanceof Error?i.message:"Unable to load Lidarr instances","error")}},[d,u]),we=a.useCallback(async(i,t,s,l,g)=>{if(l.length)try{const v=[];for(const S of l){const y=await We(i,S,s,t),w=y.page??S;if(v.push({page:w,albums:y.albums??[]}),E.current!==g)return}if(E.current!==g)return;U(S=>{const y={...S};let w=!1;for(const{page:p,albums:A}of v){const D=S[p]??[];JSON.stringify(D)!==JSON.stringify(A)&&(y[p]=A,w=!0)}return P.current=y,w?y:S})}catch(v){d(v instanceof Error?v.message:`Failed to load additional pages for ${i}`,"error")}},[d]),ce=a.useCallback(async(i,t,s,l={})=>{const g=l.preloadAll!==!1;(l.showLoading??!0)&&z(!0);try{const S=`${i}::${s}`,y=E.current!==S;y&&(E.current=S,U(()=>(P.current={},{})));const w=await We(i,t,Be,s);o(w);const p=w.page??t;m(p),b(s);const A=w.page_size??Be,D=w.total??(w.albums??[]).length,F=Math.max(1,Math.ceil((D||0)/A));Re(A),$(F);const _=w.albums??[],W=y?{}:P.current,be=P.current[p]??[],V=JSON.stringify(be)!==JSON.stringify(_);if((y||V)&&(U(ae=>{const H={...y?{}:ae,[p]:_};return P.current=H,H}),Ne(new Date().toLocaleTimeString())),g){const ae=[];for(let O=0;O<F;O+=1)O!==p&&(W[O]||ae.push(O));we(i,s,A,ae,S)}}catch(S){d(S instanceof Error?S.message:`Failed to load ${i} albums`,"error")}finally{z(!1)}},[d,we]),G=a.useCallback(async()=>{if(!M.length){J([]),Se({available:0,monitored:0,missing:0,total:0});return}Ae(!0);try{const i=[];let t=0,s=0;for(const g of M){let v=0,S=!1;const y=g.name||g.category;for(;v<100;){const w=await We(g.category,v,os,"");if(!S){const A=w.counts;A&&(t+=A.available??0,s+=A.monitored??0),S=!0}const p=w.albums??[];if(p.forEach(A=>{i.push({...A,__instance:y})}),!p.length||p.length<os)break;v+=1}}J(g=>{const v=JSON.stringify(g),S=JSON.stringify(i);return v===S?g:i});const l={available:t,monitored:s,missing:i.length-t,total:i.length};Se(g=>g.available===l.available&&g.monitored===l.monitored&&g.missing===l.missing&&g.total===l.total?g:l),le!==h&&(ie(0),ee(h)),Me(new Date().toLocaleTimeString())}catch(i){J([]),Se({available:0,monitored:0,missing:0,total:0}),d(i instanceof Error?i.message:"Failed to load aggregated Lidarr data","error")}finally{Ae(!1)}},[M,h,d]);a.useEffect(()=>{c&&se()},[c,se]),a.useEffect(()=>{if(!c||!u||u==="aggregate")return;P.current={},U({}),$(1),m(0);const i=T.current;ce(u,0,i,{preloadAll:!0,showLoading:!0})},[c,u,ce]),a.useEffect(()=>{c&&u==="aggregate"&&G()},[c,u,G]),$e(()=>{u==="aggregate"&&k&&G()},u==="aggregate"&&k?1e4:null),a.useEffect(()=>{if(!c)return;const i=t=>{u==="aggregate"?(ee(t),ie(0)):u&&(m(0),ce(u,0,t,{preloadAll:!0,showLoading:!0}))};return C(i),()=>{L(i)}},[c,u,C,L,ce]),$e(()=>{if(u&&u!=="aggregate"){if(T.current?.trim?.()||"")return;ce(u,x,n,{preloadAll:!1,showLoading:!1})}},c&&u&&u!=="aggregate"&&k?1e3:null),a.useEffect(()=>{T.current=h},[h]),a.useEffect(()=>{u==="aggregate"&&ee(h)},[u,h]);const fe=a.useMemo(()=>{let i=B;if(le){const t=le.toLowerCase();i=i.filter(s=>{const l=(s.title??"").toString().toLowerCase(),g=(s.artistName??"").toString().toLowerCase(),v=(s.__instance??"").toLowerCase();return l.includes(t)||g.includes(t)||v.includes(t)})}return oe&&(i=i.filter(t=>!t.hasFile)),he!=="all"&&(he==="none"?i=i.filter(t=>!t.reason):i=i.filter(t=>t.reason===he)),i},[B,le,oe,he]),X=a.useMemo(()=>{const i=[...fe],t=(s,l)=>{switch(l){case"__instance":return(s.__instance||"").toLowerCase();case"title":return(s.title||"").toLowerCase();case"artistName":return(s.artistName||"").toLowerCase();case"releaseDate":return s.releaseDate??"";case"monitored":return s.monitored?1:0;case"hasFile":return s.hasFile?1:0;default:return""}};return i.sort((s,l)=>{const g=t(s,ge.key),v=t(l,ge.key);let S=0;return typeof g=="number"&&typeof v=="number"?S=g-v:typeof g=="string"&&typeof v=="string"?S=g.localeCompare(v):S=String(g).localeCompare(String(v)),ge.direction==="asc"?S:-S}),i},[fe,ge]),xe=Math.max(1,Math.ceil(X.length/_e)),Oe=X.slice(ne*_e,ne*_e+_e),ye=a.useMemo(()=>{const i=Object.keys(q).map(Number).sort((s,l)=>s-l),t=[];return i.forEach(s=>{q[s]&&t.push(...q[s])}),t},[q]),Pe=a.useCallback(async()=>{if(!(!u||u==="aggregate"))try{await as(u),d(`Restarted ${u}`,"success")}catch(i){d(i instanceof Error?i.message:`Failed to restart ${u}`,"error")}},[u,d]),De=a.useCallback(i=>{const t=i.target.value||"aggregate";r(t),t!=="aggregate"&&N("")},[r,N]),Le=u==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Lidarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[M.length>1&&e.jsx("button",{className:`btn ${Le?"active":""}`,onClick:()=>r("aggregate"),children:"All Lidarr"}),M.map(i=>e.jsx("button",{className:`btn ghost ${u===i.category?"active":""}`,onClick:()=>{r(i.category),N("")},children:i.name||i.category},i.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:u||"aggregate",onChange:De,disabled:!M.length,children:[M.length>1&&e.jsx("option",{value:"aggregate",children:"All Lidarr"}),M.map(i=>e.jsx("option",{value:i.category,children:i.name||i.category},i.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter albums",value:h,onChange:i=>N(i.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:i=>{const t=i.target.value;ue(t==="missing")},value:oe?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Albums"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:i=>me(i.target.value),value:he,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),Le?e.jsx(Ss,{loading:de,rows:Oe,total:X.length,page:ne,totalPages:xe,onPageChange:ie,onRefresh:()=>void G(),lastUpdated:Ce,onSort:i=>re(t=>t.key===i?{key:i,direction:t.direction==="asc"?"desc":"asc"}:{key:i,direction:"asc"}),summary:Y,instanceCount:M.length}):e.jsx(ys,{loading:K,data:f,page:x,totalPages:j,pageSize:Z,allAlbums:ye,onlyMissing:oe,reasonFilter:he,onPageChange:i=>{m(i),ce(u,i,n,{preloadAll:!0})},onRestart:()=>void Pe(),lastUpdated:ve})]})]})})]})}function Ls({type:c,active:d}){return c==="radarr"?e.jsx(bs,{active:d}):c==="lidarr"?e.jsx(Rs,{active:d}):e.jsx(ps,{active:d})}export{Ls as ArrView};
//# sourceMappingURL=ArrView.js.map
