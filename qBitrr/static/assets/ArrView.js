import{u as qe,f as es,h as ss,i as as,k as Ve,l as ts,j as e,I as Je,R as Ge,m as Ue}from"./app.js";import{r as a,u as Le,f as pe,g as Pe,a as ns,b as cs,c as ds}from"./table.js";import{u as Ie}from"./useInterval.js";import"./vendor.js";const Ye=50,Se=50,Be=500;function gs({loading:d,rows:c,total:m,page:f,totalPages:R,onPageChange:M,onRefresh:L,lastUpdated:I,sort:p,onSort:P,summary:i}){const g=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance",size:150},{accessorKey:"title",header:"Title",cell:o=>o.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:o=>o.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:o=>o.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:o=>{const v=o.getValue();return v?e.jsx("span",{className:"table-badge table-badge-reason",children:v}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),n=Le({data:c,columns:g,getCoreRowModel:Pe()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated movies across all instances"," ",I?`(updated ${I})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",i.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",i.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",i.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",i.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:L,disabled:d,children:[e.jsx(Je,{src:Ge}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Radarr library…"]}):m?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:n.getHeaderGroups().map(o=>e.jsx("tr",{children:o.headers.map(v=>e.jsx("th",{className:v.column.getCanSort()?"sortable":"",onClick:()=>{const h=v.id;P(h)},children:v.isPlaceholder?null:pe(v.column.columnDef.header,v.getContext())},v.id))},o.id))}),e.jsx("tbody",{children:n.getRowModel().rows.map(o=>{const v=o.original,h=`${v.__instance}-${v.title}-${v.year}`;return e.jsx("tr",{children:o.getVisibleCells().map(x=>e.jsx("td",{children:pe(x.column.columnDef.cell,x.getContext())},x.id))},h)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),m>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",f+1," of ",R," (",m.toLocaleString()," items · page size"," ",Se,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>M(Math.max(0,f-1)),disabled:f===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>M(Math.min(R-1,f+1)),disabled:f>=R-1||d,children:"Next"})]})]})]})}function hs({loading:d,data:c,page:m,totalPages:f,pageSize:R,allMovies:M,onlyMissing:L,reasonFilter:I,onPageChange:p,onRestart:P,lastUpdated:i}){const g=a.useMemo(()=>{let h=M;return L&&(h=h.filter(x=>!x.hasFile)),h},[M,L]),n=a.useMemo(()=>I==="all"?g:I==="none"?g.filter(h=>!h.reason):g.filter(h=>h.reason===I),[g,I]),o=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:h=>h.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:h=>h.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:h=>h.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:h=>{const x=h.getValue();return x?e.jsx("span",{className:"table-badge table-badge-reason",children:x}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),v=Le({data:n.slice(m*R,m*R+R),columns:o,getCoreRowModel:Pe(),getSortedRowModel:ns()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[c?.counts?`Available: ${c.counts.available??0} • Monitored: ${c.counts.monitored??0}`:"",i?` (updated ${i})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:P,disabled:d,children:[e.jsx(Je,{src:Ge}),"Restart"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):M.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:v.getHeaderGroups().map(h=>e.jsx("tr",{children:h.headers.map(x=>e.jsx("th",{children:x.isPlaceholder?null:pe(x.column.columnDef.header,x.getContext())},x.id))},h.id))}),e.jsx("tbody",{children:v.getRowModel().rows.map(h=>{const x=h.original,G=`${x.title}-${x.year}`;return e.jsx("tr",{children:h.getVisibleCells().map(W=>e.jsx("td",{children:pe(W.column.columnDef.cell,W.getContext())},W.id))},G)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),n.length>R&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",m+1," of ",f," (",n.length.toLocaleString()," items · page size"," ",R,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>p(Math.max(0,m-1)),disabled:m===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>p(Math.min(f-1,m+1)),disabled:m>=f-1||d,children:"Next"})]})]})]})}function us({active:d}){const{push:c}=qe(),{value:m,setValue:f,register:R,clearHandler:M}=es(),{liveArr:L,setLiveArr:I}=ss(),[p,P]=a.useState([]),[i,g]=a.useState("aggregate"),[n,o]=a.useState(null),[v,h]=a.useState(0),[x,G]=a.useState(""),[W,ie]=a.useState(!1),[re,X]=a.useState(null),[V,se]=a.useState({}),[l,E]=a.useState(Ye),[y,_]=a.useState(1),D=a.useRef(""),K=a.useRef({}),Y=a.useRef(m),H=a.useRef(!1),[le,ue]=a.useState([]),[ye,oe]=a.useState(!1),[ce,me]=a.useState(0),[q,ve]=a.useState(""),[Re,Ne]=a.useState(null),[ee,xe]=a.useState({key:"__instance",direction:"asc"}),[ae,_e]=a.useState(!1),[te,O]=a.useState("all"),[ke,Q]=a.useState({available:0,monitored:0,missing:0,total:0}),Me=a.useCallback(async()=>{try{const t=await as();t.ready===!1&&!H.current?(H.current=!0,c("Radarr backend is still initialising. Check the logs if this persists.","info")):t.ready&&(H.current=!0);const s=(t.arr||[]).filter(r=>r.type==="radarr");if(P(s),!s.length){g("aggregate"),o(null),ue([]),Q({available:0,monitored:0,missing:0,total:0});return}i===""?g("aggregate"):i!=="aggregate"&&!s.some(r=>r.category===i)&&g(s[0].category)}catch(t){c(t instanceof Error?t.message:"Unable to load Radarr instances","error")}},[c,i]),Ae=a.useCallback(async(t,s,r,u,N)=>{if(u.length)try{const $=[];for(const j of u){const b=await Ve(t,j,r,s),S=b.page??j;if($.push({page:S,movies:b.movies??[]}),D.current!==N)return}if(D.current!==N)return;se(j=>{const b={...j};let S=!1;for(const{page:C,movies:F}of $){const w=j[C]??[];JSON.stringify(w)!==JSON.stringify(F)&&(b[C]=F,S=!0)}return K.current=b,S?b:j})}catch($){c($ instanceof Error?$.message:`Failed to load additional pages for ${t}`,"error")}},[c]),J=a.useCallback(async(t,s,r,u={})=>{const N=u.preloadAll!==!1;(u.showLoading??!0)&&ie(!0);try{const j=`${t}::${r}`,b=D.current!==j;b&&(D.current=j,se(()=>(K.current={},{})));const S=await Ve(t,s,Ye,r);o(S);const C=S.page??s;h(C),G(r);const F=S.page_size??Ye,w=S.total??(S.movies??[]).length,T=Math.max(1,Math.ceil((w||0)/F));E(F),_(T);const k=S.movies??[],ge=b?{}:K.current,he=K.current[C]??[],je=JSON.stringify(he)!==JSON.stringify(k);if((b||je)&&(se(z=>{const we={...b?{}:z,[C]:k};return K.current=we,we}),X(new Date().toLocaleTimeString())),N){const z=[];for(let B=0;B<T;B+=1)B!==C&&(ge[B]||z.push(B));Ae(t,r,F,z,j)}}catch(j){c(j instanceof Error?j.message:`Failed to load ${t} movies`,"error")}finally{ie(!1)}},[c,Ae]),de=a.useCallback(async()=>{if(!p.length){ue([]),Q({available:0,monitored:0,missing:0,total:0});return}oe(!0);try{const t=[];let s=0,r=0;for(const N of p){let $=0,j=!1;const b=N.name||N.category;for(;$<100;){const S=await Ve(N.category,$,Be,"");if(!j){const F=S.counts;F&&(s+=F.available??0,r+=F.monitored??0),j=!0}const C=S.movies??[];if(C.forEach(F=>{t.push({...F,__instance:b})}),!C.length||C.length<Be)break;$+=1}}ue(N=>{const $=JSON.stringify(N),j=JSON.stringify(t);return $===j?N:t});const u={available:s,monitored:r,missing:t.length-s,total:t.length};Q(N=>N.available===u.available&&N.monitored===u.monitored&&N.missing===u.missing&&N.total===u.total?N:u),q!==m&&(me(0),ve(m)),Ne(new Date().toLocaleTimeString())}catch(t){ue([]),Q({available:0,monitored:0,missing:0,total:0}),c(t instanceof Error?t.message:"Failed to load aggregated Radarr data","error")}finally{oe(!1)}},[p,m,c]);a.useEffect(()=>{d&&Me()},[d,Me]),a.useEffect(()=>{if(!d||!i||i==="aggregate")return;K.current={},se({}),_(1),h(0);const t=Y.current;J(i,0,t,{preloadAll:!0,showLoading:!0})},[d,i,J]),a.useEffect(()=>{d&&i==="aggregate"&&de()},[d,i,de]),Ie(()=>{i==="aggregate"&&L&&de()},i==="aggregate"&&L?1e4:null),a.useEffect(()=>{if(!d)return;const t=s=>{i==="aggregate"?(ve(s),me(0)):i&&(h(0),J(i,0,s,{preloadAll:!0,showLoading:!0}))};return R(t),()=>{M(t)}},[d,i,R,M,J]),Ie(()=>{if(i&&i!=="aggregate"){if(Y.current?.trim?.()||"")return;J(i,v,x,{preloadAll:!1,showLoading:!1})}},d&&i&&i!=="aggregate"&&L?1e3:null),a.useEffect(()=>{Y.current=m},[m]),a.useEffect(()=>{i==="aggregate"&&ve(m)},[i,m]);const Z=a.useMemo(()=>{let t=le;if(q){const s=q.toLowerCase();t=t.filter(r=>{const u=(r.title??"").toString().toLowerCase(),N=(r.__instance??"").toLowerCase();return u.includes(s)||N.includes(s)})}return ae&&(t=t.filter(s=>!s.hasFile)),te!=="all"&&(te==="none"?t=t.filter(s=>!s.reason):t=t.filter(s=>s.reason===te)),t},[le,q,ae,te]),ne=a.useMemo(()=>{const t=[...Z],s=(r,u)=>{switch(u){case"__instance":return(r.__instance||"").toLowerCase();case"title":return(r.title||"").toLowerCase();case"year":return r.year??0;case"monitored":return r.monitored?1:0;case"hasFile":return r.hasFile?1:0;default:return""}};return t.sort((r,u)=>{const N=s(r,ee.key),$=s(u,ee.key);let j=0;return typeof N=="number"&&typeof $=="number"?j=N-$:typeof N=="string"&&typeof $=="string"?j=N.localeCompare($):j=String(N).localeCompare(String($)),ee.direction==="asc"?j:-j}),t},[Z,ee]),We=Math.max(1,Math.ceil(ne.length/Se)),fe=ne.slice(ce*Se,ce*Se+Se),De=a.useMemo(()=>{const t=Object.keys(V).map(Number).sort((r,u)=>r-u),s=[];return t.forEach(r=>{V[r]&&s.push(...V[r])}),s},[V]),Ke=a.useCallback(async()=>{if(!(!i||i==="aggregate"))try{await ts(i),c(`Restarted ${i}`,"success")}catch(t){c(t instanceof Error?t.message:`Failed to restart ${i}`,"error")}},[i,c]),Te=a.useCallback(t=>{const s=t.target.value||"aggregate";g(s),s!=="aggregate"&&f("")},[g,f]),Ce=i==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Radarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[e.jsx("button",{className:`btn ${Ce?"active":""}`,onClick:()=>g("aggregate"),children:"All Radarr"}),p.map(t=>e.jsx("button",{className:`btn ghost ${i===t.category?"active":""}`,onClick:()=>{g(t.category),f("")},children:t.name||t.category},t.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:i||"aggregate",onChange:Te,disabled:!p.length,children:[e.jsx("option",{value:"aggregate",children:"All Radarr"}),p.map(t=>e.jsx("option",{value:t.category,children:t.name||t.category},t.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter movies",value:m,onChange:t=>f(t.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:t=>{const s=t.target.value;_e(s==="missing")},value:ae?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Movies"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:t=>O(t.target.value),value:te,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),Ce?e.jsx(gs,{loading:ye,rows:fe,total:ne.length,page:ce,totalPages:We,onPageChange:me,onRefresh:()=>void de(),lastUpdated:Re,sort:ee,onSort:t=>xe(s=>s.key===t?{key:t,direction:s.direction==="asc"?"desc":"asc"}:{key:t,direction:"asc"}),summary:ke}):e.jsx(hs,{loading:W,data:n,page:v,totalPages:y,pageSize:l,allMovies:De,onlyMissing:ae,reasonFilter:te,onPageChange:t=>{h(t),J(i,t,x,{preloadAll:!0})},onRestart:()=>void Ke(),lastUpdated:re})]})]})})]})}const He=25,Fe=50,Xe=200;function ms(d,c){if(!c)return d;const m=[];for(const f of d){const R=f.seasons??{},M={};for(const[L,I]of Object.entries(R)){const p=(I.episodes??[]).filter(P=>!P.hasFile);p.length&&(M[L]={...I,episodes:p})}Object.keys(M).length!==0&&m.push({...f,seasons:M})}return m}function Ee(d,c){return JSON.stringify(ms(d,c))}function xs({active:d}){const{push:c}=qe(),{value:m,setValue:f,register:R,clearHandler:M}=es(),{liveArr:L,setLiveArr:I,groupSonarr:p,setGroupSonarr:P}=ss(),[i,g]=a.useState([]),[n,o]=a.useState("aggregate"),[v,h]=a.useState(null),[x,G]=a.useState(0),[W,ie]=a.useState(""),[re,X]=a.useState(!1),[V,se]=a.useState(null),[l,E]=a.useState({}),y=a.useRef({}),_=a.useRef(null),D=a.useRef(""),[K,Y]=a.useState(He),[H,le]=a.useState(1),[ue,ye]=a.useState(0),oe=a.useRef(m),ce=a.useRef(!1),[me,q]=a.useState([]),[ve,Re]=a.useState(!1),[Ne,ee]=a.useState(0),[xe,ae]=a.useState(""),[_e,te]=a.useState(null),[O,ke]=a.useState(!1),[Q,Me]=a.useState("all"),[Ae,J]=a.useState({available:0,monitored:0,missing:0,total:0}),de=a.useCallback(async()=>{try{const s=await as();s.ready===!1&&!ce.current?(ce.current=!0,c("Sonarr backend is still initialising. Check the logs if this persists.","info")):s.ready&&(ce.current=!0);const r=(s.arr||[]).filter(u=>u.type==="sonarr");if(g(r),!r.length){o("aggregate"),h(null),q([]),J({available:0,monitored:0,missing:0,total:0});return}n===""?o("aggregate"):n!=="aggregate"&&!r.some(u=>u.category===n)&&o(r[0].category)}catch(s){c(s instanceof Error?s.message:"Unable to load Sonarr instances","error")}},[c,n]),Z=a.useCallback(async(s,r,u,N={})=>{const{preloadAll:$=!0,showLoading:j=!0,missingOnly:b}=N,S=b??O;j&&X(!0);try{const C=`${s}::${u}::${S?"missing":"all"}`,F=D.current!==C;F&&(D.current=C,E(()=>(y.current={},{})),ye(0),le(1));const w=await Ue(s,r,He,u,{missingOnly:S}),T=w.page??r,k=w.page_size??He,ge=w.total??(w.series??[]).length,he=Math.max(1,Math.ceil((ge||0)/k)),je=w.series??[],z=F?{}:y.current,B={...z,[T]:je},we=Ee(z[T]??[],S),is=Ee(je,S),Oe=F||we!==is;if(y.current=B,Oe&&E(B),h(A=>{const U=A?.counts??null,be=w.counts??null;return!A||A.total!==w.total||A.page!==w.page||A.page_size!==w.page_size||(U?.available??null)!==(be?.available??null)||(U?.monitored??null)!==(be?.monitored??null)||(U?.missing??null)!==(be?.missing??null)||Oe?(_.current=w,w):A}),G(A=>A===T?A:T),ie(A=>A===u?A:u),Y(A=>A===k?A:k),le(A=>A===he?A:he),ye(A=>A===ge?A:ge),Oe&&se(new Date().toLocaleTimeString()),$){const A=[];for(let U=0;U<he;U+=1)U!==T&&(B[U]||A.push(U));for(const U of A)try{const be=await Ue(s,U,k,u,{missingOnly:S});if(D.current!==C)break;const $e=be.page??U,ze=be.series??[],Qe=y.current,rs=Ee(Qe[$e]??[],S),ls=Ee(ze,S);if(rs===ls){y.current={...Qe,[$e]:ze};continue}E(os=>{const Ze={...os,[$e]:ze};return y.current=Ze,Ze})}catch{break}}}catch(C){c(C instanceof Error?C.message:`Failed to load ${s} series`,"error")}finally{j&&X(!1)}},[c,O]),ne=a.useCallback(async()=>{if(!i.length){q([]),J({available:0,monitored:0,missing:0,total:0});return}console.log(`[Sonarr Aggregate] Starting aggregation for ${i.length} instances`),Re(!0);try{const s=[];let r=0,u=0,N=0;for(const b of i){let S=0,C=!1;const F=b.name||b.category;for(console.log(`[Sonarr Aggregate] Processing instance: ${F}`);S<200;){const w=await Ue(b.category,S,Xe,"",{missingOnly:O});if(console.log(`[Sonarr Aggregate] Response for ${F} page ${S}:`,{total:w.total,page:w.page,page_size:w.page_size,series_count:w.series?.length??0,counts:w.counts}),!C){const k=w.counts;k&&(r+=k.available??0,u+=k.monitored??0,N+=k.missing??0),C=!0}const T=w.series??[];if(console.log(`[Sonarr Aggregate] Instance: ${F}, Page: ${S}, Series count: ${T.length}, Total episodes so far: ${s.length}`),T.forEach(k=>{const ge=k.series?.title||"";Object.entries(k.seasons??{}).forEach(([he,je])=>{(je.episodes??[]).forEach(z=>{s.push({__instance:F,series:ge,season:he,episode:z.episodeNumber??"",title:z.title??"",monitored:!!z.monitored,hasFile:!!z.hasFile,airDate:z.airDateUtc??""})})})}),!T.length||T.length<Xe){console.log(`[Sonarr Aggregate] Breaking pagination for ${F} - series.length=${T.length}`);break}S+=1}}const $=new Set(s.map(b=>`${b.__instance}::${b.series}`)).size;console.log("[Sonarr Aggregate] Aggregation complete:",{totalEpisodes:s.length,uniqueSeries:$,instances:i.length}),q(b=>{const S=JSON.stringify(b),C=JSON.stringify(s);return S===C?(console.log("[Sonarr Aggregate] Data unchanged, skipping update"),b):(console.log(`[Sonarr Aggregate] Data changed, updating from ${b.length} to ${s.length} episodes`),s)});const j={available:r,monitored:u,missing:N,total:s.length};J(b=>b.available===j.available&&b.monitored===j.monitored&&b.missing===j.missing&&b.total===j.total?b:j),xe!==m&&(ee(0),ae(m)),te(new Date().toLocaleTimeString())}catch(s){q([]),J({available:0,monitored:0,missing:0,total:0}),c(s instanceof Error?s.message:"Failed to load aggregated Sonarr data","error")}finally{Re(!1)}},[i,m,c,O]);a.useEffect(()=>{d&&de()},[d,de]),a.useEffect(()=>{if(!d||!n||n==="aggregate")return;G(0);const s=oe.current;Z(n,0,s,{preloadAll:!0,showLoading:!0,missingOnly:O})},[d,n,Z]),a.useEffect(()=>{d&&n==="aggregate"&&ne()},[d,n,ne]),Ie(()=>{n==="aggregate"&&L&&ne()},n==="aggregate"&&L?1e4:null),a.useEffect(()=>{if(!d)return;const s=r=>{n==="aggregate"?(ae(r),ee(0)):n&&(G(0),Z(n,0,r,{preloadAll:!0,showLoading:!0,missingOnly:O}))};return R(s),()=>M(s)},[d,n,R,M,Z,O]),Ie(()=>{if(n&&n!=="aggregate"){if(oe.current?.trim?.()||"")return;Z(n,x,W,{preloadAll:!1,showLoading:!1,missingOnly:O})}},d&&n&&n!=="aggregate"&&L?1e3:null),a.useEffect(()=>{oe.current=m},[m]),a.useEffect(()=>{n==="aggregate"&&ae(m)},[n,m]);const fe=a.useMemo(()=>{let s=me;if(xe){const r=xe.toLowerCase();s=s.filter(u=>u.series.toLowerCase().includes(r)||u.title.toLowerCase().includes(r)||u.__instance.toLowerCase().includes(r))}return Q!=="all"&&(Q==="none"?s=s.filter(r=>!r.reason):s=s.filter(r=>r.reason===Q)),s},[me,xe,Q]),De=Math.max(1,Math.ceil(fe.length/Fe));fe.slice(Ne*Fe,Ne*Fe+Fe);const Ke=l[x]??[],Te=a.useCallback(async()=>{if(!(!n||n==="aggregate"))try{await ts(n),c(`Restarted ${n}`,"success")}catch(s){c(s instanceof Error?s.message:`Failed to restart ${n}`,"error")}},[n,c]),Ce=a.useCallback(s=>{const r=s.target.value||"aggregate";o(r),r!=="aggregate"&&f("")},[o,f]),t=n==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Sonarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[e.jsx("button",{className:`btn ${t?"active":""}`,onClick:()=>o("aggregate"),children:"All Sonarr"}),i.map(s=>e.jsx("button",{className:`btn ghost ${n===s.category?"active":""}`,onClick:()=>{o(s.category),f("")},children:s.name||s.category},s.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:n||"aggregate",onChange:Ce,disabled:!i.length,children:[e.jsx("option",{value:"aggregate",children:"All Sonarr"}),i.map(s=>e.jsx("option",{value:s.category,children:s.name||s.category},s.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter series or episodes",value:m,onChange:s=>f(s.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:s=>{const u=s.target.value==="missing";ke(u),n&&n!=="aggregate"&&Z(n,0,oe.current||"",{preloadAll:!0,showLoading:!0,missingOnly:u})},value:O?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Episodes"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:s=>Me(s.target.value),value:Q,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),t?e.jsx(fs,{loading:ve,rows:fe,total:fe.length,page:Ne,totalPages:De,onPageChange:ee,onRefresh:()=>void ne(),lastUpdated:_e,groupSonarr:p,summary:Ae}):e.jsx(js,{loading:re,counts:v?.counts??null,series:Ke,page:x,pageSize:K,totalPages:H,totalItems:ue,onlyMissing:O,onPageChange:s=>{G(s),Z(n,s,W,{preloadAll:!1,showLoading:!0,missingOnly:O})},onRestart:()=>void Te(),lastUpdated:V,groupSonarr:p})]})]})})]})}function fs({loading:d,rows:c,total:m,page:f,totalPages:R,onPageChange:M,onRefresh:L,lastUpdated:I,groupSonarr:p,summary:P}){const i=a.useMemo(()=>{const l=new Map;c.forEach(y=>{const _=y.__instance,D=y.series,K=String(y.season);l.has(_)||l.set(_,new Map);const Y=l.get(_);Y.has(D)||Y.set(D,new Map);const H=Y.get(D);H.has(K)||H.set(K,[]),H.get(K).push(y)});const E=[];return l.forEach((y,_)=>{y.forEach((D,K)=>{E.push({instance:_,series:K,subRows:Array.from(D.entries()).map(([Y,H])=>({seasonNumber:Y,isSeason:!0,subRows:H.map(le=>({...le,isEpisode:!0}))}))})})}),E},[c]),g=a.useMemo(()=>i.slice(f*50,(f+1)*50),[i,f]),n=a.useMemo(()=>c.slice(f*50,(f+1)*50),[c,f]),o=p?g:n,v=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:({row:l})=>l.original.isEpisode?l.original.title:l.original.isSeason?`Season ${l.original.seasonNumber}`:l.original.series},{accessorKey:"monitored",header:"Monitored",cell:({row:l})=>{const E=(l.original.isEpisode,l.original.monitored);return e.jsx("span",{className:"table-badge",children:E?"Yes":"No"})}},{accessorKey:"hasFile",header:"Has File",cell:({row:l})=>l.original.isEpisode?e.jsx("span",{className:"table-badge",children:l.original.hasFile?"Yes":"No"}):null},{accessorKey:"airDate",header:"Air Date",cell:({row:l})=>l.original.isEpisode?l.original.airDate||"—":null}],[]),h=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance"},{accessorKey:"series",header:"Series"},{accessorKey:"season",header:"Season"},{accessorKey:"episode",header:"Episode"},{accessorKey:"title",header:"Title"},{accessorKey:"monitored",header:"Monitored",cell:({getValue:l})=>e.jsx("span",{className:"table-badge",children:l()?"Yes":"No"})},{accessorKey:"hasFile",header:"Has File",cell:({getValue:l})=>e.jsx("span",{className:"table-badge",children:l()?"Yes":"No"})},{accessorKey:"airDate",header:"Air Date",cell:({getValue:l})=>l()||"—"}],[]),x=p?v:h,G=Le({data:o,columns:x,getCoreRowModel:Pe(),getExpandedRowModel:cs()}),W=Le({data:o,columns:x,getCoreRowModel:Pe(),getSortedRowModel:ns(),getPaginationRowModel:ds(),state:{pagination:{pageIndex:f,pageSize:50}},manualPagination:!0,pageCount:R}),ie=p?G:W,re=50,X=Math.ceil(p?i.length/re:c.length/re),V=Math.min(f,Math.max(0,X-1)),se=p?`${i.length} series`:c.length.toLocaleString();return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated episodes across all instances"," ",I?`(updated ${I})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",P.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",P.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",P.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total Episodes:"})," ",P.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:L,disabled:d,children:[e.jsx(Je,{src:Ge}),"Refresh"]})]}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Sonarr library…"]}):p?e.jsx("div",{className:"sonarr-hierarchical-view",children:g.map(l=>e.jsxs("details",{className:"series-details",children:[e.jsxs("summary",{className:"series-summary",children:[e.jsx("span",{className:"series-title",children:l.series}),e.jsxs("span",{className:"series-instance",children:["(",l.instance,")"]})]}),e.jsx("div",{className:"series-content",children:l.subRows.map(E=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",E.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",E.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:E.subRows.map(y=>e.jsxs("tr",{children:[e.jsx("td",{children:y.episode}),e.jsx("td",{children:y.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:y.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:y.hasFile?"Yes":"No"})}),e.jsx("td",{children:y.airDate||"—"}),e.jsx("td",{children:y.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:y.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${y.__instance}-${y.series}-${y.season}-${y.episode}`))})]})})})]},`${l.instance}-${l.series}-${E.seasonNumber}`))})]},`${l.instance}-${l.series}`))}):o.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsx("tr",{children:ie.getFlatHeaders().map(l=>e.jsxs("th",{className:l.column.getCanSort()?"sortable":"",onClick:l.column.getToggleSortingHandler(),children:[l.isPlaceholder?null:pe(l.column.columnDef.header,l.getContext()),l.column.getCanSort()&&e.jsx("span",{className:"sort-arrow",children:{asc:"▲",desc:"▼"}[l.column.getIsSorted()]??null})]},l.id))})}),e.jsx("tbody",{children:ie.getRowModel().rows.map(l=>{const E=l.original,y=`${E.__instance}-${E.series}-${E.season}-${E.episode}`;return e.jsx("tr",{children:l.getVisibleCells().map(_=>e.jsx("td",{"data-label":_.column.columnDef.header,children:pe(_.column.columnDef.cell,_.getContext())},_.id))},y)})})]})}):e.jsx("div",{className:"hint",children:"No series found."}),o.length>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",V+1," of ",X," (",se," items · page size ",re,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>M(Math.max(0,V-1)),disabled:V===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>M(Math.min(X-1,V+1)),disabled:V>=X-1||d,children:"Next"})]})]})]})}function js({loading:d,counts:c,series:m,page:f,pageSize:R,totalPages:M,onPageChange:L,groupSonarr:I}){const p=Math.min(f,Math.max(0,M-1)),P=a.useMemo(()=>{const g=[];for(const n of m){const o=n.series?.title||"";Object.entries(n.seasons??{}).forEach(([v,h])=>{(h.episodes??[]).forEach(x=>{g.push({__instance:"Instance",series:o,season:v,episode:x.episodeNumber??"",title:x.title??"",monitored:!!x.monitored,hasFile:!!x.hasFile,airDate:x.airDateUtc??""})})})}return g},[m]),i=a.useMemo(()=>{const g=new Map;return P.forEach(n=>{const o=n.series;g.has(o)||g.set(o,new Map);const v=g.get(o),h=String(n.season);v.has(h)||v.set(h,[]),v.get(h).push(n)}),Array.from(g.entries()).map(([n,o])=>({series:n,subRows:Array.from(o.entries()).map(([v,h])=>({seasonNumber:v,isSeason:!0,subRows:h.map(x=>({...x,isEpisode:!0}))}))}))},[P]);return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsx("div",{className:"row",style:{justifyContent:"space-between"},children:e.jsx("div",{className:"hint",children:c?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Available:"})," ",c.available.toLocaleString()," •"," ",e.jsx("strong",{children:"Monitored:"})," ",c.monitored.toLocaleString()," •"," ",e.jsx("strong",{children:"Missing:"})," ",c.missing?.toLocaleString()??0]}):"Loading series information..."})}),d?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading series…"]}):I?e.jsx("div",{className:"sonarr-hierarchical-view",children:i.map(g=>e.jsxs("details",{className:"series-details",children:[e.jsx("summary",{className:"series-summary",children:e.jsx("span",{className:"series-title",children:g.series})}),e.jsx("div",{className:"series-content",children:g.subRows.map(n=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",n.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",n.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:n.subRows.map(o=>e.jsxs("tr",{children:[e.jsx("td",{children:o.episode}),e.jsx("td",{children:o.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:o.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:o.hasFile?"Yes":"No"})}),e.jsx("td",{children:o.airDate||"—"}),e.jsx("td",{children:o.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:o.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${o.series}-${o.season}-${o.episode}`))})]})})})]},`${g.series}-${n.seasonNumber}`))})]},`${g.series}`))}):P.length?e.jsxs("div",{className:"table-wrapper",children:[e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Series"}),e.jsx("th",{children:"Season"}),e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:P.slice(p*R,p*R+R).map((g,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:g.series}),e.jsx("td",{children:g.season}),e.jsx("td",{children:g.episode}),e.jsx("td",{children:g.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:g.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:g.hasFile?"Yes":"No"})}),e.jsx("td",{children:g.airDate||"—"}),e.jsx("td",{children:g.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:g.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${g.series}-${g.season}-${g.episode}-${n}`))})]}),e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",p+1," of ",M," (",P.length.toLocaleString()," items · page size ",R,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>L(Math.max(0,p-1)),disabled:p===0||d,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>L(Math.min(M-1,p+1)),disabled:p>=M-1||d,children:"Next"})]})]})]}):e.jsx("div",{className:"hint",children:"No series found."})]})}function Ss({type:d,active:c}){return d==="radarr"?e.jsx(us,{active:c}):e.jsx(xs,{active:c})}export{Ss as ArrView};
//# sourceMappingURL=ArrView.js.map
