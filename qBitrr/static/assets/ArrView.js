import{u as Xe,h as qe,i as es,k as ss,l as Ye,m as as,j as e,I as De,R as Ke,n as Ge,o as We}from"./app.js";import{r as a,u as Fe,f as xe,g as $e,a as ts,b as hs,c as ms}from"./table.js";import{u as Pe}from"./useInterval.js";import"./vendor.js";const Qe=50,ke=50,rs=500;function fs({loading:g,rows:d,total:h,page:p,totalPages:C,onPageChange:M,onRefresh:$,lastUpdated:L,sort:A,onSort:m,summary:c}){const f=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance",size:150},{accessorKey:"title",header:"Title",cell:o=>o.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:o=>o.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:o=>o.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:o=>{const y=o.getValue();return y?e.jsx("span",{className:"table-badge table-badge-reason",children:y}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),n=Fe({data:d,columns:f,getCoreRowModel:$e()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated movies across all instances"," ",L?`(updated ${L})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",c.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",c.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",c.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",c.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:$,disabled:g,children:[e.jsx(De,{src:Ke}),"Refresh"]})]}),g?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Radarr library…"]}):h?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:n.getHeaderGroups().map(o=>e.jsx("tr",{children:o.headers.map(y=>e.jsx("th",{className:y.column.getCanSort()?"sortable":"",onClick:()=>{const l=y.id;m(l)},children:y.isPlaceholder?null:xe(y.column.columnDef.header,y.getContext())},y.id))},o.id))}),e.jsx("tbody",{children:n.getRowModel().rows.map(o=>{const y=o.original,l=`${y.__instance}-${y.title}-${y.year}`;return e.jsx("tr",{children:o.getVisibleCells().map(j=>e.jsx("td",{children:xe(j.column.columnDef.cell,j.getContext())},j.id))},l)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),h>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",p+1," of ",C," (",h.toLocaleString()," items · page size"," ",ke,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>M(Math.max(0,p-1)),disabled:p===0||g,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>M(Math.min(C-1,p+1)),disabled:p>=C-1||g,children:"Next"})]})]})]})}function xs({loading:g,data:d,page:h,totalPages:p,pageSize:C,allMovies:M,onlyMissing:$,reasonFilter:L,onPageChange:A,onRestart:m,lastUpdated:c}){const f=a.useMemo(()=>{let l=M;return $&&(l=l.filter(j=>!j.hasFile)),l},[M,$]),n=a.useMemo(()=>L==="all"?f:L==="none"?f.filter(l=>!l.reason):f.filter(l=>l.reason===L),[f,L]),o=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:l=>l.getValue()},{accessorKey:"year",header:"Year",size:80},{accessorKey:"monitored",header:"Monitored",cell:l=>l.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:l=>l.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:l=>{const j=l.getValue();return j?e.jsx("span",{className:"table-badge table-badge-reason",children:j}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),y=Fe({data:n.slice(h*C,h*C+C),columns:o,getCoreRowModel:$e(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[d?.counts?`Available: ${d.counts.available??0} • Monitored: ${d.counts.monitored??0}`:"",c?` (updated ${c})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:m,disabled:g,children:[e.jsx(De,{src:Ke}),"Restart"]})]}),g?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):M.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:y.getHeaderGroups().map(l=>e.jsx("tr",{children:l.headers.map(j=>e.jsx("th",{children:j.isPlaceholder?null:xe(j.column.columnDef.header,j.getContext())},j.id))},l.id))}),e.jsx("tbody",{children:y.getRowModel().rows.map(l=>{const j=l.original,G=`${j.title}-${j.year}`;return e.jsx("tr",{children:l.getVisibleCells().map(O=>e.jsx("td",{children:xe(O.column.columnDef.cell,O.getContext())},O.id))},G)})})]})}):e.jsx("div",{className:"hint",children:"No movies found."}),n.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",h+1," of ",p," (",n.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>A(Math.max(0,h-1)),disabled:h===0||g,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>A(Math.min(p-1,h+1)),disabled:h>=p-1||g,children:"Next"})]})]})]})}function js({active:g}){const{push:d}=Xe(),{value:h,setValue:p,register:C,clearHandler:M}=qe(),{liveArr:$,setLiveArr:L}=es(),[A,m]=a.useState([]),[c,f]=a.useState("aggregate"),[n,o]=a.useState(null),[y,l]=a.useState(0),[j,G]=a.useState(""),[O,je]=a.useState(!1),[be,W]=a.useState(null),[T,ce]=a.useState({}),[x,k]=a.useState(Qe),[F,D]=a.useState(1),_=a.useRef(""),z=a.useRef({}),J=a.useRef(h),Q=a.useRef(!1),[ee,Ne]=a.useState([]),[Re,ae]=a.useState(!1),[te,ne]=a.useState(0),[B,Ae]=a.useState(""),[we,de]=a.useState(null),[ie,re]=a.useState({key:"__instance",direction:"asc"}),[ge,ue]=a.useState(!1),[he,Y]=a.useState("all"),[Se,X]=a.useState({available:0,monitored:0,missing:0,total:0}),Ce=a.useCallback(async()=>{try{const t=await ss();t.ready===!1&&!Q.current?(Q.current=!0,d("Radarr backend is still initialising. Check the logs if this persists.","info")):t.ready&&(Q.current=!0);const s=(t.arr||[]).filter(r=>r.type==="radarr");if(m(s),!s.length){f("aggregate"),o(null),Ne([]),X({available:0,monitored:0,missing:0,total:0});return}c===""?f("aggregate"):c!=="aggregate"&&!s.some(r=>r.category===c)&&f(s[0].category)}catch(t){d(t instanceof Error?t.message:"Unable to load Radarr instances","error")}},[d,c]),le=a.useCallback(async(t,s,r,u,b)=>{if(u.length)try{const v=[];for(const N of u){const S=await Ye(t,N,r,s),R=S.page??N;if(v.push({page:R,movies:S.movies??[]}),_.current!==b)return}if(_.current!==b)return;ce(N=>{const S={...N};let R=!1;for(const{page:w,movies:P}of v){const E=N[w]??[];JSON.stringify(E)!==JSON.stringify(P)&&(S[w]=P,R=!0)}return z.current=S,R?S:N})}catch(v){d(v instanceof Error?v.message:`Failed to load additional pages for ${t}`,"error")}},[d]),H=a.useCallback(async(t,s,r,u={})=>{const b=u.preloadAll!==!1;(u.showLoading??!0)&&je(!0);try{const N=`${t}::${r}`,S=_.current!==N;S&&(_.current=N,ce(()=>(z.current={},{})));const R=await Ye(t,s,Qe,r);o(R);const w=R.page??s;l(w),G(r);const P=R.page_size??Qe,E=R.total??(R.movies??[]).length,V=Math.max(1,Math.ceil((E||0)/P));k(P),D(V);const U=R.movies??[],pe=S?{}:z.current,ve=z.current[w]??[],oe=JSON.stringify(ve)!==JSON.stringify(U);if((S||oe)&&(ce(K=>{const Oe={...S?{}:K,[w]:U};return z.current=Oe,Oe}),W(new Date().toLocaleTimeString())),b){const K=[];for(let q=0;q<V;q+=1)q!==w&&(pe[q]||K.push(q));le(t,r,P,K,N)}}catch(N){d(N instanceof Error?N.message:`Failed to load ${t} movies`,"error")}finally{je(!1)}},[d,le]),me=a.useCallback(async()=>{if(!A.length){Ne([]),X({available:0,monitored:0,missing:0,total:0});return}ae(!0);try{const t=[];let s=0,r=0;for(const b of A){let v=0,N=!1;const S=b.name||b.category;for(;v<100;){const R=await Ye(b.category,v,rs,"");if(!N){const P=R.counts;P&&(s+=P.available??0,r+=P.monitored??0),N=!0}const w=R.movies??[];if(w.forEach(P=>{t.push({...P,__instance:S})}),!w.length||w.length<rs)break;v+=1}}Ne(b=>{const v=JSON.stringify(b),N=JSON.stringify(t);return v===N?b:t});const u={available:s,monitored:r,missing:t.length-s,total:t.length};X(b=>b.available===u.available&&b.monitored===u.monitored&&b.missing===u.missing&&b.total===u.total?b:u),B!==h&&(ne(0),Ae(h)),de(new Date().toLocaleTimeString())}catch(t){Ne([]),X({available:0,monitored:0,missing:0,total:0}),d(t instanceof Error?t.message:"Failed to load aggregated Radarr data","error")}finally{ae(!1)}},[A,h,d]);a.useEffect(()=>{g&&Ce()},[g,Ce]),a.useEffect(()=>{if(!g||!c||c==="aggregate")return;z.current={},ce({}),D(1),l(0);const t=J.current;H(c,0,t,{preloadAll:!0,showLoading:!0})},[g,c,H]),a.useEffect(()=>{g&&c==="aggregate"&&me()},[g,c,me]),Pe(()=>{c==="aggregate"&&$&&me()},c==="aggregate"&&$?1e4:null),a.useEffect(()=>{if(!g)return;const t=s=>{c==="aggregate"?(Ae(s),ne(0)):c&&(l(0),H(c,0,s,{preloadAll:!0,showLoading:!0}))};return C(t),()=>{M(t)}},[g,c,C,M,H]),Pe(()=>{if(c&&c!=="aggregate"){if(J.current?.trim?.()||"")return;H(c,y,j,{preloadAll:!1,showLoading:!1})}},g&&c&&c!=="aggregate"&&$?1e3:null),a.useEffect(()=>{J.current=h},[h]),a.useEffect(()=>{c==="aggregate"&&Ae(h)},[c,h]);const Z=a.useMemo(()=>{let t=ee;if(B){const s=B.toLowerCase();t=t.filter(r=>{const u=(r.title??"").toString().toLowerCase(),b=(r.__instance??"").toLowerCase();return u.includes(s)||b.includes(s)})}return ge&&(t=t.filter(s=>!s.hasFile)),he!=="all"&&(he==="none"?t=t.filter(s=>!s.reason):t=t.filter(s=>s.reason===he)),t},[ee,B,ge,he]),fe=a.useMemo(()=>{const t=[...Z],s=(r,u)=>{switch(u){case"__instance":return(r.__instance||"").toLowerCase();case"title":return(r.title||"").toLowerCase();case"year":return r.year??0;case"monitored":return r.monitored?1:0;case"hasFile":return r.hasFile?1:0;default:return""}};return t.sort((r,u)=>{const b=s(r,ie.key),v=s(u,ie.key);let N=0;return typeof b=="number"&&typeof v=="number"?N=b-v:typeof b=="string"&&typeof v=="string"?N=b.localeCompare(v):N=String(b).localeCompare(String(v)),ie.direction==="asc"?N:-N}),t},[Z,ie]),ze=Math.max(1,Math.ceil(fe.length/ke)),ye=fe.slice(te*ke,te*ke+ke),Ee=a.useMemo(()=>{const t=Object.keys(T).map(Number).sort((r,u)=>r-u),s=[];return t.forEach(r=>{T[r]&&s.push(...T[r])}),s},[T]),Ie=a.useCallback(async()=>{if(!(!c||c==="aggregate"))try{await as(c),d(`Restarted ${c}`,"success")}catch(t){d(t instanceof Error?t.message:`Failed to restart ${c}`,"error")}},[c,d]),Me=a.useCallback(t=>{const s=t.target.value||"aggregate";f(s),s!=="aggregate"&&p("")},[f,p]),i=c==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Radarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[e.jsx("button",{className:`btn ${i?"active":""}`,onClick:()=>f("aggregate"),children:"All Radarr"}),A.map(t=>e.jsx("button",{className:`btn ghost ${c===t.category?"active":""}`,onClick:()=>{f(t.category),p("")},children:t.name||t.category},t.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:c||"aggregate",onChange:Me,disabled:!A.length,children:[e.jsx("option",{value:"aggregate",children:"All Radarr"}),A.map(t=>e.jsx("option",{value:t.category,children:t.name||t.category},t.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter movies",value:h,onChange:t=>p(t.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:t=>{const s=t.target.value;ue(s==="missing")},value:ge?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Movies"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:t=>Y(t.target.value),value:he,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),i?e.jsx(fs,{loading:Re,rows:ye,total:fe.length,page:te,totalPages:ze,onPageChange:ne,onRefresh:()=>void me(),lastUpdated:we,sort:ie,onSort:t=>re(s=>s.key===t?{key:t,direction:s.direction==="asc"?"desc":"asc"}:{key:t,direction:"asc"}),summary:Se}):e.jsx(xs,{loading:O,data:n,page:y,totalPages:F,pageSize:x,allMovies:Ee,onlyMissing:ge,reasonFilter:he,onPageChange:t=>{l(t),H(c,t,j,{preloadAll:!0})},onRestart:()=>void Ie(),lastUpdated:be})]})]})})]})}const Ze=25,Ve=50,ls=200;function bs(g,d){if(!d)return g;const h=[];for(const p of g){const C=p.seasons??{},M={};for(const[$,L]of Object.entries(C)){const A=(L.episodes??[]).filter(m=>!m.hasFile);A.length&&(M[$]={...L,episodes:A})}Object.keys(M).length!==0&&h.push({...p,seasons:M})}return h}function Ue(g,d){return JSON.stringify(bs(g,d))}function ps({active:g}){const{push:d}=Xe(),{value:h,setValue:p,register:C,clearHandler:M}=qe(),{liveArr:$,setLiveArr:L,groupSonarr:A,setGroupSonarr:m}=es(),[c,f]=a.useState([]),[n,o]=a.useState("aggregate"),[y,l]=a.useState(null),[j,G]=a.useState(0),[O,je]=a.useState(""),[be,W]=a.useState(!1),[T,ce]=a.useState(null),[x,k]=a.useState({}),F=a.useRef({}),D=a.useRef(null),_=a.useRef(""),[z,J]=a.useState(Ze),[Q,ee]=a.useState(1),[Ne,Re]=a.useState(0),ae=a.useRef(h),te=a.useRef(!1),[ne,B]=a.useState([]),[Ae,we]=a.useState(!1),[de,ie]=a.useState(0),[re,ge]=a.useState(""),[ue,he]=a.useState(null),[Y,Se]=a.useState(!1),[X,Ce]=a.useState("all"),[le,H]=a.useState({available:0,monitored:0,missing:0,total:0}),me=a.useCallback(async()=>{try{const s=await ss();s.ready===!1&&!te.current?(te.current=!0,d("Sonarr backend is still initialising. Check the logs if this persists.","info")):s.ready&&(te.current=!0);const r=(s.arr||[]).filter(u=>u.type==="sonarr");if(f(r),!r.length){o("aggregate"),l(null),B([]),H({available:0,monitored:0,missing:0,total:0});return}n===""?o("aggregate"):n!=="aggregate"&&!r.some(u=>u.category===n)&&o(r[0].category)}catch(s){d(s instanceof Error?s.message:"Unable to load Sonarr instances","error")}},[d,n]),Z=a.useCallback(async(s,r,u,b={})=>{const{preloadAll:v=!0,showLoading:N=!0,missingOnly:S}=b,R=S??Y;N&&W(!0);try{const w=`${s}::${u}::${R?"missing":"all"}`,P=_.current!==w;P&&(_.current=w,k(()=>(F.current={},{})),Re(0),ee(1));const E=await Ge(s,r,Ze,u,{missingOnly:R}),V=E.page??r,U=E.page_size??Ze,pe=E.total??(E.series??[]).length,ve=Math.max(1,Math.ceil((pe||0)/U)),oe=E.series??[],K=P?{}:F.current,q={...K,[V]:oe},Oe=Ue(K[V]??[],R),cs=Ue(oe,R),He=P||Oe!==cs;if(F.current=q,He&&k(q),l(I=>{const se=I?.counts??null,Le=E.counts??null;return!I||I.total!==E.total||I.page!==E.page||I.page_size!==E.page_size||(se?.available??null)!==(Le?.available??null)||(se?.monitored??null)!==(Le?.monitored??null)||(se?.missing??null)!==(Le?.missing??null)||He?(D.current=E,E):I}),G(I=>I===V?I:V),je(I=>I===u?I:u),J(I=>I===U?I:U),ee(I=>I===ve?I:ve),Re(I=>I===pe?I:pe),He&&ce(new Date().toLocaleTimeString()),v){const I=[];for(let se=0;se<ve;se+=1)se!==V&&(q[se]||I.push(se));for(const se of I)try{const Le=await Ge(s,se,U,u,{missingOnly:R});if(_.current!==w)break;const Te=Le.page??se,Je=Le.series??[],ns=F.current,ds=Ue(ns[Te]??[],R),gs=Ue(Je,R);if(ds===gs){F.current={...ns,[Te]:Je};continue}k(us=>{const is={...us,[Te]:Je};return F.current=is,is})}catch{break}}}catch(w){d(w instanceof Error?w.message:`Failed to load ${s} series`,"error")}finally{N&&W(!1)}},[d,Y]),fe=a.useCallback(async()=>{if(!c.length){B([]),H({available:0,monitored:0,missing:0,total:0});return}console.log(`[Sonarr Aggregate] Starting aggregation for ${c.length} instances`),we(!0);try{const s=[];let r=0,u=0,b=0;for(const S of c){let R=0,w=!1;const P=S.name||S.category;for(console.log(`[Sonarr Aggregate] Processing instance: ${P}`);R<200;){const E=await Ge(S.category,R,ls,"",{missingOnly:Y});if(console.log(`[Sonarr Aggregate] Response for ${P} page ${R}:`,{total:E.total,page:E.page,page_size:E.page_size,series_count:E.series?.length??0,counts:E.counts}),!w){const U=E.counts;U&&(r+=U.available??0,u+=U.monitored??0,b+=U.missing??0),w=!0}const V=E.series??[];if(console.log(`[Sonarr Aggregate] Instance: ${P}, Page: ${R}, Series count: ${V.length}, Total episodes so far: ${s.length}`),V.forEach(U=>{const pe=U.series?.title||"";Object.entries(U.seasons??{}).forEach(([ve,oe])=>{(oe.episodes??[]).forEach(K=>{s.push({__instance:P,series:pe,season:ve,episode:K.episodeNumber??"",title:K.title??"",monitored:!!K.monitored,hasFile:!!K.hasFile,airDate:K.airDateUtc??""})})})}),!V.length||V.length<ls){console.log(`[Sonarr Aggregate] Breaking pagination for ${P} - series.length=${V.length}`);break}R+=1}}const v=new Set(s.map(S=>`${S.__instance}::${S.series}`)).size;console.log("[Sonarr Aggregate] Aggregation complete:",{totalEpisodes:s.length,uniqueSeries:v,instances:c.length}),B(S=>{const R=JSON.stringify(S),w=JSON.stringify(s);return R===w?(console.log("[Sonarr Aggregate] Data unchanged, skipping update"),S):(console.log(`[Sonarr Aggregate] Data changed, updating from ${S.length} to ${s.length} episodes`),s)});const N={available:r,monitored:u,missing:b,total:s.length};H(S=>S.available===N.available&&S.monitored===N.monitored&&S.missing===N.missing&&S.total===N.total?S:N),re!==h&&(ie(0),ge(h)),he(new Date().toLocaleTimeString())}catch(s){B([]),H({available:0,monitored:0,missing:0,total:0}),d(s instanceof Error?s.message:"Failed to load aggregated Sonarr data","error")}finally{we(!1)}},[c,h,d,Y]);a.useEffect(()=>{g&&me()},[g,me]),a.useEffect(()=>{if(!g||!n||n==="aggregate")return;G(0);const s=ae.current;Z(n,0,s,{preloadAll:!0,showLoading:!0,missingOnly:Y})},[g,n,Z]),a.useEffect(()=>{g&&n==="aggregate"&&fe()},[g,n,fe]),Pe(()=>{n==="aggregate"&&$&&fe()},n==="aggregate"&&$?1e4:null),a.useEffect(()=>{if(!g)return;const s=r=>{n==="aggregate"?(ge(r),ie(0)):n&&(G(0),Z(n,0,r,{preloadAll:!0,showLoading:!0,missingOnly:Y}))};return C(s),()=>M(s)},[g,n,C,M,Z,Y]),Pe(()=>{if(n&&n!=="aggregate"){if(ae.current?.trim?.()||"")return;Z(n,j,O,{preloadAll:!1,showLoading:!1,missingOnly:Y})}},g&&n&&n!=="aggregate"&&$?1e3:null),a.useEffect(()=>{ae.current=h},[h]),a.useEffect(()=>{n==="aggregate"&&ge(h)},[n,h]);const ye=a.useMemo(()=>{let s=ne;if(re){const r=re.toLowerCase();s=s.filter(u=>u.series.toLowerCase().includes(r)||u.title.toLowerCase().includes(r)||u.__instance.toLowerCase().includes(r))}return X!=="all"&&(X==="none"?s=s.filter(r=>!r.reason):s=s.filter(r=>r.reason===X)),s},[ne,re,X]),Ee=Math.max(1,Math.ceil(ye.length/Ve));ye.slice(de*Ve,de*Ve+Ve);const Ie=x[j]??[],Me=a.useCallback(async()=>{if(!(!n||n==="aggregate"))try{await as(n),d(`Restarted ${n}`,"success")}catch(s){d(s instanceof Error?s.message:`Failed to restart ${n}`,"error")}},[n,d]),i=a.useCallback(s=>{const r=s.target.value||"aggregate";o(r),r!=="aggregate"&&p("")},[o,p]),t=n==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Sonarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[e.jsx("button",{className:`btn ${t?"active":""}`,onClick:()=>o("aggregate"),children:"All Sonarr"}),c.map(s=>e.jsx("button",{className:`btn ghost ${n===s.category?"active":""}`,onClick:()=>{o(s.category),p("")},children:s.name||s.category},s.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:n||"aggregate",onChange:i,disabled:!c.length,children:[e.jsx("option",{value:"aggregate",children:"All Sonarr"}),c.map(s=>e.jsx("option",{value:s.category,children:s.name||s.category},s.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter series or episodes",value:h,onChange:s=>p(s.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:s=>{const u=s.target.value==="missing";Se(u),n&&n!=="aggregate"&&Z(n,0,ae.current||"",{preloadAll:!0,showLoading:!0,missingOnly:u})},value:Y?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Episodes"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:s=>Ce(s.target.value),value:X,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),t?e.jsx(vs,{loading:Ae,rows:ye,total:ye.length,page:de,totalPages:Ee,onPageChange:ie,onRefresh:()=>void fe(),lastUpdated:ue,groupSonarr:A,summary:le}):e.jsx(Ns,{loading:be,counts:y?.counts??null,series:Ie,page:j,pageSize:z,totalPages:Q,totalItems:Ne,onlyMissing:Y,onPageChange:s=>{G(s),Z(n,s,O,{preloadAll:!1,showLoading:!0,missingOnly:Y})},onRestart:()=>void Me(),lastUpdated:T,groupSonarr:A})]})]})})]})}function vs({loading:g,rows:d,total:h,page:p,totalPages:C,onPageChange:M,onRefresh:$,lastUpdated:L,groupSonarr:A,summary:m}){const c=a.useMemo(()=>{const x=new Map;d.forEach(F=>{const D=F.__instance,_=F.series,z=String(F.season);x.has(D)||x.set(D,new Map);const J=x.get(D);J.has(_)||J.set(_,new Map);const Q=J.get(_);Q.has(z)||Q.set(z,[]),Q.get(z).push(F)});const k=[];return x.forEach((F,D)=>{F.forEach((_,z)=>{k.push({instance:D,series:z,subRows:Array.from(_.entries()).map(([J,Q])=>({seasonNumber:J,isSeason:!0,subRows:Q.map(ee=>({...ee,isEpisode:!0}))}))})})}),k},[d]),f=a.useMemo(()=>c.slice(p*50,(p+1)*50),[c,p]),n=a.useMemo(()=>d.slice(p*50,(p+1)*50),[d,p]),o=A?f:n,y=a.useMemo(()=>[{accessorKey:"title",header:"Title",cell:({row:x})=>x.original.isEpisode?x.original.title:x.original.isSeason?`Season ${x.original.seasonNumber}`:x.original.series},{accessorKey:"monitored",header:"Monitored",cell:({row:x})=>{const k=(x.original.isEpisode,x.original.monitored);return e.jsx("span",{className:"table-badge",children:k?"Yes":"No"})}},{accessorKey:"hasFile",header:"Has File",cell:({row:x})=>x.original.isEpisode?e.jsx("span",{className:"table-badge",children:x.original.hasFile?"Yes":"No"}):null},{accessorKey:"airDate",header:"Air Date",cell:({row:x})=>x.original.isEpisode?x.original.airDate||"—":null}],[]),l=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance"},{accessorKey:"series",header:"Series"},{accessorKey:"season",header:"Season"},{accessorKey:"episode",header:"Episode"},{accessorKey:"title",header:"Title"},{accessorKey:"monitored",header:"Monitored",cell:({getValue:x})=>e.jsx("span",{className:"table-badge",children:x()?"Yes":"No"})},{accessorKey:"hasFile",header:"Has File",cell:({getValue:x})=>e.jsx("span",{className:"table-badge",children:x()?"Yes":"No"})},{accessorKey:"airDate",header:"Air Date",cell:({getValue:x})=>x()||"—"}],[]),j=A?y:l,G=Fe({data:o,columns:j,getCoreRowModel:$e(),getExpandedRowModel:hs()}),O=Fe({data:o,columns:j,getCoreRowModel:$e(),getSortedRowModel:ts(),getPaginationRowModel:ms(),state:{pagination:{pageIndex:p,pageSize:50}},manualPagination:!0,pageCount:C}),je=A?G:O,be=50,W=Math.ceil(A?c.length/be:d.length/be),T=Math.min(p,Math.max(0,W-1)),ce=A?`${c.length} series`:d.length.toLocaleString();return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated episodes across all instances"," ",L?`(updated ${L})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",m.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",m.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",m.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total Episodes:"})," ",m.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:$,disabled:g,children:[e.jsx(De,{src:Ke}),"Refresh"]})]}),g?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Sonarr library…"]}):A?e.jsx("div",{className:"sonarr-hierarchical-view",children:f.map(x=>e.jsxs("details",{className:"series-details",children:[e.jsxs("summary",{className:"series-summary",children:[e.jsx("span",{className:"series-title",children:x.series}),e.jsxs("span",{className:"series-instance",children:["(",x.instance,")"]})]}),e.jsx("div",{className:"series-content",children:x.subRows.map(k=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",k.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",k.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:k.subRows.map(F=>e.jsxs("tr",{children:[e.jsx("td",{children:F.episode}),e.jsx("td",{children:F.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:F.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:F.hasFile?"Yes":"No"})}),e.jsx("td",{children:F.airDate||"—"}),e.jsx("td",{children:F.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:F.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${F.__instance}-${F.series}-${F.season}-${F.episode}`))})]})})})]},`${x.instance}-${x.series}-${k.seasonNumber}`))})]},`${x.instance}-${x.series}`))}):o.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsx("tr",{children:je.getFlatHeaders().map(x=>e.jsxs("th",{className:x.column.getCanSort()?"sortable":"",onClick:x.column.getToggleSortingHandler(),children:[x.isPlaceholder?null:xe(x.column.columnDef.header,x.getContext()),x.column.getCanSort()&&e.jsx("span",{className:"sort-arrow",children:{asc:"▲",desc:"▼"}[x.column.getIsSorted()]??null})]},x.id))})}),e.jsx("tbody",{children:je.getRowModel().rows.map(x=>{const k=x.original,F=`${k.__instance}-${k.series}-${k.season}-${k.episode}`;return e.jsx("tr",{children:x.getVisibleCells().map(D=>e.jsx("td",{"data-label":D.column.columnDef.header,children:xe(D.column.columnDef.cell,D.getContext())},D.id))},F)})})]})}):e.jsx("div",{className:"hint",children:"No series found."}),o.length>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",T+1," of ",W," (",ce," items · page size ",be,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>M(Math.max(0,T-1)),disabled:T===0||g,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>M(Math.min(W-1,T+1)),disabled:T>=W-1||g,children:"Next"})]})]})]})}function Ns({loading:g,counts:d,series:h,page:p,pageSize:C,totalPages:M,onPageChange:$,groupSonarr:L}){const A=Math.min(p,Math.max(0,M-1)),m=a.useMemo(()=>{const f=[];for(const n of h){const o=n.series?.title||"";Object.entries(n.seasons??{}).forEach(([y,l])=>{(l.episodes??[]).forEach(j=>{f.push({__instance:"Instance",series:o,season:y,episode:j.episodeNumber??"",title:j.title??"",monitored:!!j.monitored,hasFile:!!j.hasFile,airDate:j.airDateUtc??""})})})}return f},[h]),c=a.useMemo(()=>{const f=new Map;return m.forEach(n=>{const o=n.series;f.has(o)||f.set(o,new Map);const y=f.get(o),l=String(n.season);y.has(l)||y.set(l,[]),y.get(l).push(n)}),Array.from(f.entries()).map(([n,o])=>({series:n,subRows:Array.from(o.entries()).map(([y,l])=>({seasonNumber:y,isSeason:!0,subRows:l.map(j=>({...j,isEpisode:!0}))}))}))},[m]);return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsx("div",{className:"row",style:{justifyContent:"space-between"},children:e.jsx("div",{className:"hint",children:d?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Available:"})," ",d.available.toLocaleString()," •"," ",e.jsx("strong",{children:"Monitored:"})," ",d.monitored.toLocaleString()," •"," ",e.jsx("strong",{children:"Missing:"})," ",d.missing?.toLocaleString()??0]}):"Loading series information..."})}),g?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading series…"]}):L?e.jsx("div",{className:"sonarr-hierarchical-view",children:c.map(f=>e.jsxs("details",{className:"series-details",children:[e.jsx("summary",{className:"series-summary",children:e.jsx("span",{className:"series-title",children:f.series})}),e.jsx("div",{className:"series-content",children:f.subRows.map(n=>e.jsxs("details",{className:"season-details",children:[e.jsxs("summary",{className:"season-summary",children:[e.jsxs("span",{className:"season-title",children:["Season ",n.seasonNumber]}),e.jsxs("span",{className:"season-count",children:["(",n.subRows.length," episodes)"]})]}),e.jsx("div",{className:"season-content",children:e.jsx("div",{className:"episodes-table-wrapper",children:e.jsxs("table",{className:"episodes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:n.subRows.map(o=>e.jsxs("tr",{children:[e.jsx("td",{children:o.episode}),e.jsx("td",{children:o.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:o.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:o.hasFile?"Yes":"No"})}),e.jsx("td",{children:o.airDate||"—"}),e.jsx("td",{children:o.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:o.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${o.series}-${o.season}-${o.episode}`))})]})})})]},`${f.series}-${n.seasonNumber}`))})]},`${f.series}`))}):m.length?e.jsxs("div",{className:"table-wrapper",children:[e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Series"}),e.jsx("th",{children:"Season"}),e.jsx("th",{children:"Episode"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Monitored"}),e.jsx("th",{children:"Has File"}),e.jsx("th",{children:"Air Date"}),e.jsx("th",{children:"Reason"})]})}),e.jsx("tbody",{children:m.slice(A*C,A*C+C).map((f,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:f.series}),e.jsx("td",{children:f.season}),e.jsx("td",{children:f.episode}),e.jsx("td",{children:f.title}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:f.monitored?"Yes":"No"})}),e.jsx("td",{children:e.jsx("span",{className:"table-badge",children:f.hasFile?"Yes":"No"})}),e.jsx("td",{children:f.airDate||"—"}),e.jsx("td",{children:f.reason?e.jsx("span",{className:"table-badge table-badge-reason",children:f.reason}):e.jsx("span",{className:"hint",children:"—"})})]},`${f.series}-${f.season}-${f.episode}-${n}`))})]}),e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",A+1," of ",M," (",m.length.toLocaleString()," items · page size ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>$(Math.max(0,A-1)),disabled:A===0||g,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>$(Math.min(M-1,A+1)),disabled:A>=M-1||g,children:"Next"})]})]})]}):e.jsx("div",{className:"hint",children:"No series found."})]})}const Be=50,_e=50,os=500;function Ss({loading:g,rows:d,total:h,page:p,totalPages:C,onPageChange:M,onRefresh:$,lastUpdated:L,onSort:A,summary:m}){const c=a.useMemo(()=>[{accessorKey:"__instance",header:"Instance",size:150},{accessorKey:"title",header:"Album",cell:n=>n.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:n=>{const o=n.getValue();return o?new Date(o).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:n=>n.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:n=>{const o=n.getValue();return o?e.jsx("span",{className:"table-badge table-badge-reason",children:o}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),f=Fe({data:d,columns:c,getCoreRowModel:$e()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:["Aggregated albums across all instances"," ",L?`(updated ${L})`:"",e.jsx("br",{}),e.jsx("strong",{children:"Available:"})," ",m.available.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Monitored:"})," ",m.monitored.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Missing:"})," ",m.missing.toLocaleString(void 0,{maximumFractionDigits:0})," •"," ",e.jsx("strong",{children:"Total:"})," ",m.total.toLocaleString(void 0,{maximumFractionDigits:0})]}),e.jsxs("button",{className:"btn ghost",onClick:$,disabled:g,children:[e.jsx(De,{src:Ke}),"Refresh"]})]}),g?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading Lidarr library…"]}):h?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:f.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(o=>e.jsx("th",{className:o.column.getCanSort()?"sortable":"",onClick:()=>{const y=o.id;A(y)},children:o.isPlaceholder?null:xe(o.column.columnDef.header,o.getContext())},o.id))},n.id))}),e.jsx("tbody",{children:f.getRowModel().rows.map(n=>{const o=n.original,y=`${o.__instance}-${o.title}-${o.artistName}`;return e.jsx("tr",{children:n.getVisibleCells().map(l=>e.jsx("td",{children:xe(l.column.columnDef.cell,l.getContext())},l.id))},y)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),h>0&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",p+1," of ",C," (",h.toLocaleString()," items · page size"," ",_e,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>M(Math.max(0,p-1)),disabled:p===0||g,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>M(Math.min(C-1,p+1)),disabled:p>=C-1||g,children:"Next"})]})]})]})}function ys({loading:g,data:d,page:h,totalPages:p,pageSize:C,allAlbums:M,onlyMissing:$,reasonFilter:L,onPageChange:A,onRestart:m,lastUpdated:c}){const f=a.useMemo(()=>{let l=M;return $&&(l=l.filter(j=>!j.hasFile)),l},[M,$]),n=a.useMemo(()=>L==="all"?f:L==="none"?f.filter(l=>!l.reason):f.filter(l=>l.reason===L),[f,L]),o=a.useMemo(()=>[{accessorKey:"title",header:"Album",cell:l=>l.getValue()},{accessorKey:"artistName",header:"Artist",size:150},{accessorKey:"releaseDate",header:"Release Date",cell:l=>{const j=l.getValue();return j?new Date(j).toLocaleDateString():e.jsx("span",{className:"hint",children:"—"})},size:120},{accessorKey:"monitored",header:"Monitored",cell:l=>l.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"hasFile",header:"Has File",cell:l=>l.getValue()?e.jsx("span",{className:"table-badge",children:"Yes"}):e.jsx("span",{children:"No"}),size:100},{accessorKey:"reason",header:"Reason",cell:l=>{const j=l.getValue();return j?e.jsx("span",{className:"table-badge table-badge-reason",children:j}):e.jsx("span",{className:"hint",children:"—"})},size:120}],[]),y=Fe({data:n.slice(h*C,h*C+C),columns:o,getCoreRowModel:$e(),getSortedRowModel:ts()});return e.jsxs("div",{className:"stack animate-fade-in",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"hint",children:[d?.counts?`Available: ${d.counts.available??0} • Monitored: ${d.counts.monitored??0}`:"",c?` (updated ${c})`:""]}),e.jsxs("button",{className:"btn ghost",onClick:m,disabled:g,children:[e.jsx(De,{src:Ke}),"Restart"]})]}),g?e.jsxs("div",{className:"loading",children:[e.jsx("span",{className:"spinner"})," Loading…"]}):M.length?e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"responsive-table",children:[e.jsx("thead",{children:y.getHeaderGroups().map(l=>e.jsx("tr",{children:l.headers.map(j=>e.jsx("th",{children:j.isPlaceholder?null:xe(j.column.columnDef.header,j.getContext())},j.id))},l.id))}),e.jsx("tbody",{children:y.getRowModel().rows.map(l=>{const j=l.original,G=`${j.title}-${j.artistName}`;return e.jsx("tr",{children:l.getVisibleCells().map(O=>e.jsx("td",{children:xe(O.column.columnDef.cell,O.getContext())},O.id))},G)})})]})}):e.jsx("div",{className:"hint",children:"No albums found."}),n.length>C&&e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{children:["Page ",h+1," of ",p," (",n.length.toLocaleString()," items · page size"," ",C,")"]}),e.jsxs("div",{className:"inline",children:[e.jsx("button",{className:"btn",onClick:()=>A(Math.max(0,h-1)),disabled:h===0||g,children:"Prev"}),e.jsx("button",{className:"btn",onClick:()=>A(Math.min(p-1,h+1)),disabled:h>=p-1||g,children:"Next"})]})]})]})}function Rs({active:g}){const{push:d}=Xe(),{value:h,setValue:p,register:C,clearHandler:M}=qe(),{liveArr:$}=es(),[L,A]=a.useState([]),[m,c]=a.useState("aggregate"),[f,n]=a.useState(null),[o,y]=a.useState(0),[l,j]=a.useState(""),[G,O]=a.useState(!1),[je,be]=a.useState(null),[W,T]=a.useState({}),[ce,x]=a.useState(Be),[k,F]=a.useState(1),D=a.useRef(""),_=a.useRef({}),z=a.useRef(h),J=a.useRef(!1),[Q,ee]=a.useState([]),[Ne,Re]=a.useState(!1),[ae,te]=a.useState(0),[ne,B]=a.useState(""),[Ae,we]=a.useState(null),[de,ie]=a.useState({key:"__instance",direction:"asc"}),[re,ge]=a.useState(!1),[ue,he]=a.useState("all"),[Y,Se]=a.useState({available:0,monitored:0,missing:0,total:0}),X=a.useCallback(async()=>{try{const i=await ss();i.ready===!1&&!J.current?(J.current=!0,d("Lidarr backend is still initialising. Check the logs if this persists.","info")):i.ready&&(J.current=!0);const t=(i.arr||[]).filter(s=>s.type==="lidarr");if(A(t),!t.length){c("aggregate"),n(null),ee([]),Se({available:0,monitored:0,missing:0,total:0});return}m===""?c("aggregate"):m!=="aggregate"&&!t.some(s=>s.category===m)&&c(t[0].category)}catch(i){d(i instanceof Error?i.message:"Unable to load Lidarr instances","error")}},[d,m]),Ce=a.useCallback(async(i,t,s,r,u)=>{if(r.length)try{const b=[];for(const v of r){const N=await We(i,v,s,t),S=N.page??v;if(b.push({page:S,albums:N.albums??[]}),D.current!==u)return}if(D.current!==u)return;T(v=>{const N={...v};let S=!1;for(const{page:R,albums:w}of b){const P=v[R]??[];JSON.stringify(P)!==JSON.stringify(w)&&(N[R]=w,S=!0)}return _.current=N,S?N:v})}catch(b){d(b instanceof Error?b.message:`Failed to load additional pages for ${i}`,"error")}},[d]),le=a.useCallback(async(i,t,s,r={})=>{const u=r.preloadAll!==!1;(r.showLoading??!0)&&O(!0);try{const v=`${i}::${s}`,N=D.current!==v;N&&(D.current=v,T(()=>(_.current={},{})));const S=await We(i,t,Be,s);n(S);const R=S.page??t;y(R),j(s);const w=S.page_size??Be,P=S.total??(S.albums??[]).length,E=Math.max(1,Math.ceil((P||0)/w));x(w),F(E);const V=S.albums??[],U=N?{}:_.current,pe=_.current[R]??[],ve=JSON.stringify(pe)!==JSON.stringify(V);if((N||ve)&&(T(oe=>{const q={...N?{}:oe,[R]:V};return _.current=q,q}),be(new Date().toLocaleTimeString())),u){const oe=[];for(let K=0;K<E;K+=1)K!==R&&(U[K]||oe.push(K));Ce(i,s,w,oe,v)}}catch(v){d(v instanceof Error?v.message:`Failed to load ${i} albums`,"error")}finally{O(!1)}},[d,Ce]),H=a.useCallback(async()=>{if(!L.length){ee([]),Se({available:0,monitored:0,missing:0,total:0});return}Re(!0);try{const i=[];let t=0,s=0;for(const u of L){let b=0,v=!1;const N=u.name||u.category;for(;b<100;){const S=await We(u.category,b,os,"");if(!v){const w=S.counts;w&&(t+=w.available??0,s+=w.monitored??0),v=!0}const R=S.albums??[];if(R.forEach(w=>{i.push({...w,__instance:N})}),!R.length||R.length<os)break;b+=1}}ee(u=>{const b=JSON.stringify(u),v=JSON.stringify(i);return b===v?u:i});const r={available:t,monitored:s,missing:i.length-t,total:i.length};Se(u=>u.available===r.available&&u.monitored===r.monitored&&u.missing===r.missing&&u.total===r.total?u:r),ne!==h&&(te(0),B(h)),we(new Date().toLocaleTimeString())}catch(i){ee([]),Se({available:0,monitored:0,missing:0,total:0}),d(i instanceof Error?i.message:"Failed to load aggregated Lidarr data","error")}finally{Re(!1)}},[L,h,d]);a.useEffect(()=>{g&&X()},[g,X]),a.useEffect(()=>{if(!g||!m||m==="aggregate")return;_.current={},T({}),F(1),y(0);const i=z.current;le(m,0,i,{preloadAll:!0,showLoading:!0})},[g,m,le]),a.useEffect(()=>{g&&m==="aggregate"&&H()},[g,m,H]),Pe(()=>{m==="aggregate"&&$&&H()},m==="aggregate"&&$?1e4:null),a.useEffect(()=>{if(!g)return;const i=t=>{m==="aggregate"?(B(t),te(0)):m&&(y(0),le(m,0,t,{preloadAll:!0,showLoading:!0}))};return C(i),()=>{M(i)}},[g,m,C,M,le]),Pe(()=>{if(m&&m!=="aggregate"){if(z.current?.trim?.()||"")return;le(m,o,l,{preloadAll:!1,showLoading:!1})}},g&&m&&m!=="aggregate"&&$?1e3:null),a.useEffect(()=>{z.current=h},[h]),a.useEffect(()=>{m==="aggregate"&&B(h)},[m,h]);const me=a.useMemo(()=>{let i=Q;if(ne){const t=ne.toLowerCase();i=i.filter(s=>{const r=(s.title??"").toString().toLowerCase(),u=(s.artistName??"").toString().toLowerCase(),b=(s.__instance??"").toLowerCase();return r.includes(t)||u.includes(t)||b.includes(t)})}return re&&(i=i.filter(t=>!t.hasFile)),ue!=="all"&&(ue==="none"?i=i.filter(t=>!t.reason):i=i.filter(t=>t.reason===ue)),i},[Q,ne,re,ue]),Z=a.useMemo(()=>{const i=[...me],t=(s,r)=>{switch(r){case"__instance":return(s.__instance||"").toLowerCase();case"title":return(s.title||"").toLowerCase();case"artistName":return(s.artistName||"").toLowerCase();case"releaseDate":return s.releaseDate??"";case"monitored":return s.monitored?1:0;case"hasFile":return s.hasFile?1:0;default:return""}};return i.sort((s,r)=>{const u=t(s,de.key),b=t(r,de.key);let v=0;return typeof u=="number"&&typeof b=="number"?v=u-b:typeof u=="string"&&typeof b=="string"?v=u.localeCompare(b):v=String(u).localeCompare(String(b)),de.direction==="asc"?v:-v}),i},[me,de]),fe=Math.max(1,Math.ceil(Z.length/_e)),ze=Z.slice(ae*_e,ae*_e+_e),ye=a.useMemo(()=>{const i=Object.keys(W).map(Number).sort((s,r)=>s-r),t=[];return i.forEach(s=>{W[s]&&t.push(...W[s])}),t},[W]),Ee=a.useCallback(async()=>{if(!(!m||m==="aggregate"))try{await as(m),d(`Restarted ${m}`,"success")}catch(i){d(i instanceof Error?i.message:`Failed to restart ${m}`,"error")}},[m,d]),Ie=a.useCallback(i=>{const t=i.target.value||"aggregate";c(t),t!=="aggregate"&&p("")},[c,p]),Me=m==="aggregate";return e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:"Lidarr"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"split",children:[e.jsxs("aside",{className:"pane sidebar",children:[e.jsx("button",{className:`btn ${Me?"active":""}`,onClick:()=>c("aggregate"),children:"All Lidarr"}),L.map(i=>e.jsx("button",{className:`btn ghost ${m===i.category?"active":""}`,onClick:()=>{c(i.category),p("")},children:i.name||i.category},i.category))]}),e.jsxs("div",{className:"pane",children:[e.jsxs("div",{className:"field mobile-instance-select",children:[e.jsx("label",{children:"Instance"}),e.jsxs("select",{value:m||"aggregate",onChange:Ie,disabled:!L.length,children:[e.jsx("option",{value:"aggregate",children:"All Lidarr"}),L.map(i=>e.jsx("option",{value:i.category,children:i.name||i.category},i.category))]})]}),e.jsxs("div",{className:"row",style:{alignItems:"flex-end",gap:"12px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"col field",style:{flex:"1 1 200px"},children:[e.jsx("label",{children:"Search"}),e.jsx("input",{placeholder:"Filter albums",value:h,onChange:i=>p(i.target.value)})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{onChange:i=>{const t=i.target.value;ge(t==="missing")},value:re?"missing":"all",children:[e.jsx("option",{value:"all",children:"All Albums"}),e.jsx("option",{value:"missing",children:"Missing Only"})]})]}),e.jsxs("div",{className:"field",style:{flex:"0 0 auto",minWidth:"140px"},children:[e.jsx("label",{children:"Search Reason"}),e.jsxs("select",{onChange:i=>he(i.target.value),value:ue,children:[e.jsx("option",{value:"all",children:"All Reasons"}),e.jsx("option",{value:"none",children:"Not Being Searched"}),e.jsx("option",{value:"Missing",children:"Missing"}),e.jsx("option",{value:"Quality",children:"Quality"}),e.jsx("option",{value:"CustomFormat",children:"Custom Format"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Scheduled search",children:"Scheduled Search"})]})]})]}),Me?e.jsx(Ss,{loading:Ne,rows:ze,total:Z.length,page:ae,totalPages:fe,onPageChange:te,onRefresh:()=>void H(),lastUpdated:Ae,onSort:i=>ie(t=>t.key===i?{key:i,direction:t.direction==="asc"?"desc":"asc"}:{key:i,direction:"asc"}),summary:Y}):e.jsx(ys,{loading:G,data:f,page:o,totalPages:k,pageSize:ce,allAlbums:ye,onlyMissing:re,reasonFilter:ue,onPageChange:i=>{y(i),le(m,i,l,{preloadAll:!0})},onRestart:()=>void Ee(),lastUpdated:je})]})]})})]})}function Ls({type:g,active:d}){return g==="radarr"?e.jsx(js,{active:d}):g==="lidarr"?e.jsx(Rs,{active:d}):e.jsx(ps,{active:d})}export{Ls as ArrView};
//# sourceMappingURL=ArrView.js.map
